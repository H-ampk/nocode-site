<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å­¦ç¿’ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <link rel="stylesheet" href="../public/css/main.css" />
  <link rel="stylesheet" href="../public/css/analysis.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="../src/admin/pin.js" defer></script>
  <script>window.addEventListener('DOMContentLoaded',function(){ if(window.AdminAuth) AdminAuth.init({admin:true}); });</script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    h1 {
      margin-bottom: 1rem;
      color: #333;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 2rem;
      color: #666;
      text-decoration: none;
    }
    .back-link:hover {
      color: #333;
    }
    .dataset-section {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dataset-section h2 {
      margin-top: 0;
      font-size: 1.5rem;
      color: #333;
    }
    .dataset-list {
      margin: 1rem 0;
    }
    .dataset-category {
      margin: 1.5rem 0;
    }
    .dataset-category-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
      cursor: pointer;
      user-select: none;
    }
    .dataset-category-title:hover {
      color: #4CAF50;
    }
    .dataset-category-list {
      margin-left: 1.5rem;
      margin-top: 0.5rem;
    }
    .dataset-item {
      display: block;
      padding: 0.75rem 1rem;
      margin: 0.5rem 0;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      color: #333;
      transition: all 0.2s;
    }
    .dataset-item:hover {
      background: #e8f5e9;
      border-color: #4CAF50;
      transform: translateX(4px);
    }
    .dataset-item:active {
      background: #c8e6c9;
    }
    .create-section {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 2px solid #eee;
    }
    .create-form {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .form-group {
      flex: 1;
      min-width: 150px;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }
    .btn {
      padding: 0.5rem 1.5rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background 0.2s;
    }
    .btn:hover {
      background: #45a049;
    }
    .btn:active {
      background: #3d8b40;
    }
    .dataset-info {
      margin-top: 1rem;
      padding: 1rem;
      background: #e8f5e9;
      border-radius: 4px;
      font-size: 0.9rem;
      color: #2e7d32;
      border-left: 4px solid #4CAF50;
    }
    .dataset-error {
      margin-top: 1rem;
      padding: 1rem;
      background: #ffebee;
      border-radius: 4px;
      font-size: 0.9rem;
      color: #d32f2f;
      border-left: 4px solid #f44336;
    }
    .loading {
      color: #666;
      font-style: italic;
    }
    /* ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºåˆ¶å¾¡ï¼ˆanalysis.cssã§è©³ç´°ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©ï¼‰ */
    .dashboard-dark {
      display: none;
    }
  </style>
</head>
<body>
  <a href="admin.html" class="back-link">â† Admin ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
  <h1>ğŸ“Š å­¦ç¿’ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

  <!-- ã‚¯ã‚¤ã‚ºãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <section id="quizVersionListSection" class="dataset-section" style="margin-bottom: 2rem;">
    <h2>ğŸ“¦ ã‚¯ã‚¤ã‚ºãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è¦§</h2>
    <p style="color: #666; margin-bottom: 15px;">
      ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰ã‚¯ã‚¤ã‚ºãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ã€å·®åˆ†ã‚’ç¢ºèªã§ãã¾ã™ã€‚
    </p>
    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</label>
        <select id="versionProjectSelect" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; min-width: 200px;">
          <option value="default">default</option>
        </select>
      </div>
      <div>
        <label style="display: block; margin-bottom: 5px; font-weight: 600;">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠ:</label>
        <select id="quizVersionList" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; min-width: 300px;">
          <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
        </select>
      </div>
      <div style="align-self: flex-end;">
        <button id="loadVersionDiffBtn" style="padding: 10px 20px; background: #2d7bf4; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em;">
          ğŸ” å·®åˆ†ã‚’è¡¨ç¤º
        </button>
      </div>
    </div>
    <div id="diffContainer" style="margin-top: 20px; padding: 15px; background: white; border-radius: 6px; overflow-x: auto; display: none;"></div>
  </section>

  <div class="dataset-section">
    <h2>ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆé¸æŠ</h2>
    <div id="dataset-list" class="dataset-list">
      <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    <div id="dataset-info" class="dataset-info" style="display: none;"></div>
    <div id="dataset-error" class="dataset-error" style="display: none;"></div>

    <div class="create-section">
      <h3>æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹</h3>
      <div class="create-form">
        <div class="form-group">
          <label for="new-dataset-name">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå</label>
          <input type="text" id="new-dataset-name" placeholder="ä¾‹: classA_2025" />
        </div>
        <div class="form-group">
          <label for="new-dataset-type">ã‚¿ã‚¤ãƒ—</label>
          <select id="new-dataset-type">
            <option value="class">ã‚¯ãƒ©ã‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆclassï¼‰</option>
            <option value="student">å€‹äººãƒ‡ãƒ¼ã‚¿ï¼ˆstudentï¼‰</option>
          </select>
        </div>
        <div class="form-group">
          <button class="btn" onclick="createNewDatasetFile()">ä½œæˆ</button>
        </div>
      </div>
      <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #eee;">
        <button class="btn" style="background: #2196F3;" onclick="regenerateIndex()">ğŸ”„ index.json ã‚’å†ç”Ÿæˆ</button>
        <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
          students/ ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã™ã¹ã¦ã® JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ index.json ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚
        </p>
      </div>
    </div>
  </div>

  <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠUI -->
  <div id="session-selector" class="dataset-section" style="display: none;">
    <h3>ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠ</h3>
    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
      <select id="session-select" style="padding: 10px; font-size: 1em; border-radius: 5px; border: 1px solid #ddd; min-width: 300px;"></select>
      <button id="view-session" class="btn" style="background: #2196F3;">è¡¨ç¤º</button>
      <button id="view-all-sessions" class="btn" style="background: #4CAF50;">å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆç®—</button>
    </div>
  </div>

  <!-- ç†è§£éšå±¤åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
  <div id="dashboard" class="dashboard-dark" style="display: none;">
    <!-- ä¸Šæ®µã‚«ãƒ¼ãƒ‰ -->
    <div class="kpi-row">
      <div class="kpi-card" id="total-answers-card">
        <h4>ç·å›ç­”æ•°</h4>
        <div class="kpi-value" id="kpi-total-answers">-</div>
      </div>

      <div class="kpi-card" id="accuracy-card">
        <h4>å¹³å‡æ­£ç­”ç‡ / ç†è§£åº¦</h4>
        <div class="kpi-value" id="kpi-accuracy">-</div>
      </div>

      <div class="kpi-card" id="weakest-level-card">
        <h4>æœ€ã‚‚å¼±ã„ç†è§£éšå±¤</h4>
        <div class="kpi-value" id="kpi-weakest-level">-</div>
      </div>
    </div>

    <!-- ä¸­æ®µãƒãƒ£ãƒ¼ãƒˆ -->
    <div class="chart-row">
      <div class="chart-box">
        <h4>ç†è§£éšå±¤ã®åˆ†å¸ƒ</h4>
        <canvas id="masteryPie"></canvas>
      </div>

      <div class="chart-box">
        <h4>æ¦‚å¿µåˆ¥ã®ç†è§£ã‚¹ã‚³ã‚¢</h4>
        <canvas id="conceptBar"></canvas>
      </div>

      <div class="chart-box">
        <h4>èª¤æ¦‚å¿µãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
        <canvas id="misconceptionBar"></canvas>
      </div>
    </div>

    <!-- ä¸‹æ®µï¼šå¼±ç‚¹ã¨æ¨è–¦å•é¡Œ -->
    <div class="chart-row">
      <div class="chart-box">
        <h4>å¼±ã„ç†è§£éšå±¤ï¼ˆTOP3ï¼‰</h4>
        <canvas id="weakLevelsBar"></canvas>
      </div>

      <div class="chart-box" id="recommendation-box">
        <h4>ãŠã™ã™ã‚å•é¡Œãƒªã‚¹ãƒˆ</h4>
        <ul id="recommendation-list"></ul>
      </div>
    </div>

    <!-- èª¤æ¦‚å¿µ Ã— ç†è§£éšå±¤ã®ã‚¯ãƒ­ã‚¹é›†è¨ˆãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ— -->
    <div class="chart-row">
      <div class="chart-box" style="flex: 2;">
        <h4>èª¤æ¦‚å¿µ Ã— ç†è§£éšå±¤ï¼ˆã‚¯ãƒ­ã‚¹é›†è¨ˆï¼‰</h4>
        <canvas id="misconceptionMasteryHeat"></canvas>
      </div>
    </div>

    <!-- åå¿œæ™‚é–“é–¢é€£ã®å¯è¦–åŒ– -->
    <div class="chart-row">
      <div class="chart-box">
        <h4>åå¿œæ™‚é–“ã®åˆ†å¸ƒï¼ˆResponse Timeï¼‰</h4>
        <canvas id="rtHistogram"></canvas>
      </div>

      <div class="chart-box">
        <h4>ç†è§£éšå±¤ Ã— åå¿œã‚³ã‚¹ãƒˆï¼ˆHeatmapï¼‰</h4>
        <canvas id="rtMasteryHeat"></canvas>
      </div>
    </div>

    <!-- è¿·ã„ãƒˆãƒãƒ­ã‚¸ãƒ¼ã¨å®‰å®šåº¦ã®å¯è¦–åŒ– -->
    <div class="chart-row">
      <div class="chart-box">
        <h4>è¿·ã„ãƒˆãƒãƒ­ã‚¸ãƒ¼ï¼ˆConfusion Topologyï¼‰</h4>
        <canvas id="confusionTopo"></canvas>
      </div>

      <div class="chart-box">
        <h4>å®‰å®šåº¦ï¼ˆStability Indexï¼‰</h4>
        <canvas id="stabilityChart"></canvas>
      </div>
    </div>
  </div>

  <!-- ============================================
       ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿é †åº
       ============================================
       1. analysis.jsï¼ˆç†è§£éšå±¤åˆ†æï¼‰
       2. recommendation.jsï¼ˆå•é¡Œæ¨è–¦ï¼‰
       3. analysis.jsï¼ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æç”»ï¼‰
  -->
  <script src="../src/player/analysis.js"></script>
  <script src="../src/player/recommendation.js"></script>
  <script src="../src/admin/dataset_loader.js"></script>
  <script src="../src/admin/analysis.js"></script>
  <script>
    var currentDataset = null;
    var currentLogs = null; // ç¾åœ¨ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã¯å‰Šé™¤ï¼ˆæ–°ã—ã„ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¯ã‚¿ãƒ–ä¸è¦ï¼‰

    // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    function loadDatasetList() {
      if (typeof window.DatasetLoader === 'undefined') {
        console.error('DatasetLoader ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        const listContainer = document.getElementById('dataset-list');
        if (listContainer) {
          listContainer.innerHTML = '<div class="dataset-error">DatasetLoader ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</div>';
        }
        return;
      }
      
      window.DatasetLoader.listDatasets()
        .then(function(datasets) {
          const listContainer = document.getElementById('dataset-list');
          if (!listContainer) return;
          
          if (!datasets || datasets.length === 0) {
            listContainer.innerHTML = '<div class="dataset-error">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚students/index.json ã«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>';
            return;
          }

          // type ã§åˆ†é¡
          var classes = datasets.filter(function(ds) { return ds.type === 'class'; });
          var individuals = datasets.filter(function(ds) { return ds.type === 'student'; });

          const escapeHtml = window.AnalysisDashboard && window.AnalysisDashboard.escapeHtml ? window.AnalysisDashboard.escapeHtml : function(s) { return s; };
          let html = '';
          
          // ã‚¯ãƒ©ã‚¹ãƒ‡ãƒ¼ã‚¿
          if (classes.length > 0) {
            html += '<div class="dataset-category">';
            html += '<div class="dataset-category-title">â–¼ ã‚¯ãƒ©ã‚¹ãƒ‡ãƒ¼ã‚¿</div>';
            html += '<div class="dataset-category-list">';
            classes.forEach(function(dataset) {
              html += '<a href="#" class="dataset-item" data-dataset=\'' + JSON.stringify(dataset).replace(/'/g, '&#39;') + '\'>ğŸ“„ ' + escapeHtml(dataset.dataset_name) + '</a>';
            });
            html += '</div>';
            html += '</div>';
          }

          // å€‹äººãƒ‡ãƒ¼ã‚¿
          if (individuals.length > 0) {
            html += '<div class="dataset-category">';
            html += '<div class="dataset-category-title">â–¼ å€‹äººãƒ‡ãƒ¼ã‚¿</div>';
            html += '<div class="dataset-category-list">';
            individuals.forEach(function(dataset) {
              html += '<a href="#" class="dataset-item" data-dataset=\'' + JSON.stringify(dataset).replace(/'/g, '&#39;') + '\'>ğŸ“„ ' + escapeHtml(dataset.dataset_name) + '</a>';
            });
            html += '</div>';
            html += '</div>';
          }
          
          listContainer.innerHTML = html;

          // å„ãƒ•ã‚¡ã‚¤ãƒ«åã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ä¸ï¼ˆé‡è¤‡ç™»éŒ²ã‚’é˜²ãï¼‰
          listContainer.querySelectorAll('.dataset-item').forEach(function(item) {
            // æ—¢ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (item.dataset.listenerAdded) return;
            item.dataset.listenerAdded = 'true';
            
            item.addEventListener('click', function(e) {
              e.preventDefault();
              const datasetJson = this.getAttribute('data-dataset');
              try {
              const dataset = JSON.parse(datasetJson);
              loadAndAnalyze(dataset);
              } catch (error) {
                console.error('Failed to parse dataset JSON:', error);
                const errorDiv = document.getElementById('dataset-error');
                if (errorDiv) {
                  errorDiv.style.display = 'block';
                  errorDiv.innerHTML = '<strong>âŒ ã‚¨ãƒ©ãƒ¼</strong><br>ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæƒ…å ±ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                }
              }
            });
          });
        })
        .catch(function(error) {
          console.error('loadDatasetList error:', error);
          const listContainer = document.getElementById('dataset-list');
          if (listContainer) {
            const escapeHtml = window.AnalysisDashboard && window.AnalysisDashboard.escapeHtml ? window.AnalysisDashboard.escapeHtml : function(s) { return s; };
          listContainer.innerHTML = '<div class="dataset-error">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + escapeHtml(error.message) + '</div>';
          }
        });
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã‚“ã§åˆ†æ
    function loadAndAnalyze(dataset) {
      // AnalysisDashboard ã¨ DatasetLoader ã®å­˜åœ¨ç¢ºèª
      if (typeof window.AnalysisDashboard === 'undefined') {
        console.error('AnalysisDashboard ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        const errorDiv = document.getElementById('dataset-error');
        if (errorDiv) {
          errorDiv.style.display = 'block';
          errorDiv.innerHTML = '<strong>âŒ ã‚¨ãƒ©ãƒ¼</strong><br>AnalysisDashboard ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
        }
        return;
      }
      
      if (typeof window.DatasetLoader === 'undefined') {
        console.error('DatasetLoader ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        const errorDiv = document.getElementById('dataset-error');
        if (errorDiv) {
          errorDiv.style.display = 'block';
          errorDiv.innerHTML = '<strong>âŒ ã‚¨ãƒ©ãƒ¼</strong><br>DatasetLoader ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚';
        }
        return;
      }
      
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
      const errorDiv = document.getElementById('dataset-error');
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      const infoDiv = document.getElementById('dataset-info');
      if (!infoDiv) return;
      infoDiv.style.display = 'block';
      infoDiv.innerHTML = '<strong>èª­ã¿è¾¼ã¿ä¸­...</strong> ' + (window.AnalysisDashboard.escapeHtml ? window.AnalysisDashboard.escapeHtml(dataset.dataset_name) : dataset.dataset_name);
      infoDiv.className = 'dataset-info';

      // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’ä¸¦è¡Œã—ã¦èª­ã¿è¾¼ã‚€
      // student_log ã‚’èª­ã¿è¾¼ã‚€ãŸã‚ã« config ã‚’è¿½åŠ 
      const config = { student_id: dataset.dataset_name };
      
      Promise.all([
        window.DatasetLoader.loadDataset(dataset, config),
        window.DatasetLoader.loadProject ? window.DatasetLoader.loadProject('default') : Promise.resolve({})
      ])
        .then(function(results) {
          const data = results[0]; // æ¨™æº–å½¢: { user_id, session_id, quiz_version, logs, raw, student_log? }
          const projectData = results[1];
          window.currentProjectData = projectData;
          
          // æ¨™æº–å½¢ã® logs ã‚’ä½¿ç”¨ï¼ˆdataset_loader.js ãŒçµ±ä¸€å½¢å¼ã§è¿”ã™ï¼‰
          const logs = data.logs || [];
          
          if (!logs || logs.length === 0) {
            throw new Error('æœ‰åŠ¹ãªãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
          }
          
            currentDataset = dataset.dataset_name;
            
          // sessions ã¾ãŸã¯ student_log ãŒã‚ã‚‹å ´åˆã¯ multi-session æ§‹é€ 
          var sessions = data.sessions || data.student_log;
          if (sessions && Array.isArray(sessions) && sessions.length > 0) {
            // sessions é…åˆ—ã‚’ä½¿ç”¨
            window.currentStudentData = { sessions: sessions };
            renderSessionSelector(window.currentStudentData);
            
            // å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’åˆç®—ã—ã¦è¡¨ç¤º
            const logsAll = window.AnalysisDashboard.mergeAllSessions(window.currentStudentData);
            
            const escapeHtml = window.AnalysisDashboard.escapeHtml || function(s) { return s; };
            infoDiv.innerHTML = `
              <strong>âœ… é¸æŠä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼š</strong> ${escapeHtml(dataset.dataset_name)}<br>
              ãƒ•ã‚¡ã‚¤ãƒ«å: ${escapeHtml(dataset.file)} | ã‚¿ã‚¤ãƒ—: ${escapeHtml(data.raw && data.raw.type ? data.raw.type : dataset.type || 'student')}<br>
              ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: ${sessions.length}ä»¶ | åˆè¨ˆãƒ­ã‚°æ•°: ${logsAll.length}ä»¶
            `;
            infoDiv.className = 'dataset-info';
            
            // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            const dashboardEl = document.getElementById('dashboard');
            if (dashboardEl) {
              dashboardEl.style.display = 'block';
            }
            
            // æ–°ã—ã„ç†è§£éšå±¤åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            if (window.AnalysisDashboard && window.AnalysisDashboard.renderMasteryDashboard) {
              window.AnalysisDashboard.renderMasteryDashboard(logsAll, projectData);
            } else {
              // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢å­˜ã®åˆ†æã‚’å®Ÿè¡Œ
              window.AnalysisDashboard.analyze(logsAll, projectData);
            }
            
            // ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
            currentLogs = logsAll;
            window.currentLogs = logsAll;
          } else {
            // é€šå¸¸ã®ãƒ­ã‚°å½¢å¼ï¼ˆå˜ä¸€ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰
            var datasetName = data.raw && data.raw.dataset_name ? data.raw.dataset_name : dataset.dataset_name;
            var datasetType = data.raw && data.raw.type ? data.raw.type : dataset.type || 'unknown';
            var createdAt = data.raw && (data.raw.created_at || data.raw.generated_at) ? (data.raw.created_at || data.raw.generated_at) : 'ä¸æ˜';
            
            const escapeHtml = window.AnalysisDashboard.escapeHtml || function(s) { return s; };
            infoDiv.innerHTML = `
              <strong>âœ… é¸æŠä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼š</strong> ${escapeHtml(dataset.dataset_name)}<br>
              ãƒ•ã‚¡ã‚¤ãƒ«å: ${escapeHtml(dataset.file)} | ã‚¿ã‚¤ãƒ—: ${escapeHtml(datasetType)}<br>
              ãƒ­ã‚°æ•°: ${logs.length}ä»¶ | ä½œæˆæ—¥æ™‚: ${escapeHtml(createdAt)}
            `;
            infoDiv.className = 'dataset-info';
            
            // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            const dashboardEl2 = document.getElementById('dashboard');
            if (dashboardEl2) {
              dashboardEl2.style.display = 'block';
            }
            
            // æ–°ã—ã„ç†è§£éšå±¤åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            if (window.AnalysisDashboard && window.AnalysisDashboard.renderMasteryDashboard) {
              window.AnalysisDashboard.renderMasteryDashboard(logs, projectData);
            } else {
              // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢å­˜ã®åˆ†æã‚’å®Ÿè¡Œ
              window.AnalysisDashboard.analyze(logs, projectData);
            }
            
            // ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
            currentLogs = logs;
            window.currentLogs = logs;
          }
        })
        .catch(function(error) {
          console.error('loadAndAnalyze error:', error);
          const errorDiv = document.getElementById('dataset-error');
          if (errorDiv) {
          errorDiv.style.display = 'block';
            const escapeHtml = window.AnalysisDashboard && window.AnalysisDashboard.escapeHtml ? window.AnalysisDashboard.escapeHtml : function(s) { return s; };
          errorDiv.innerHTML = '<strong>âŒ ã‚¨ãƒ©ãƒ¼</strong><br>' + escapeHtml(error.message);
          }
          
          if (infoDiv) {
          infoDiv.style.display = 'none';
          }
        });
    }

    // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
    function createNewDatasetFile() {
      const nameInput = document.getElementById('new-dataset-name');
      const typeInput = document.getElementById('new-dataset-type');
      if (!nameInput || !typeInput) return;
      
      const datasetName = nameInput.value.trim();
      const datasetType = typeInput.value;

      if (!datasetName) {
        alert('ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      try {
        // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
        const newDataset = DatasetLoader.createNewDataset(datasetName, datasetType);
        
        // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆï¼ˆdataset_name + ".json" ã«çµ±ä¸€ï¼‰
        const fileName = datasetName.replace(/[^a-zA-Z0-9_]/g, '_') + '.json';
        
        // JSON ãƒ•ã‚¡ã‚¤ãƒ«æœ¬ä½“ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const jsonStr = JSON.stringify(newDataset, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(url);
        
        // index.json ã‚’æ›´æ–°ï¼ˆæ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ ï¼‰
        DatasetLoader.updateIndexJson(fileName, datasetName, datasetType)
          .then(function(success) {
            const infoDiv = document.getElementById('dataset-info');
            if (!infoDiv) return;
            infoDiv.style.display = 'block';
            infoDiv.className = 'dataset-info';
            
            if (success) {
              infoDiv.innerHTML = `
                <strong>âœ… ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ</strong><br>
                ãƒ•ã‚¡ã‚¤ãƒ«å: ${escapeHtml(fileName)}<br>
                students/${escapeHtml(fileName)} ã¨ students/index.json ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
              `;
              
              // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
              const nameInputReset = document.getElementById('new-dataset-name');
              if (nameInputReset) {
                nameInputReset.value = '';
              }
              
              // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
              setTimeout(function() {
                loadDatasetList();
              }, 1000);
            } else {
              infoDiv.innerHTML = `
                <strong>âš ï¸ ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ä½œæˆã•ã‚Œã¾ã—ãŸãŒã€index.json ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ</strong><br>
                ãƒ•ã‚¡ã‚¤ãƒ«å: ${escapeHtml(fileName)}<br>
                students/${escapeHtml(fileName)} ã¨æ‰‹å‹•ã§ students/index.json ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚
              `;
            }
          })
          .catch(function(error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
          });
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    // index.json ã‚’å†ç”Ÿæˆ
    function regenerateIndex() {
      const infoDiv = document.getElementById('dataset-info');
      if (!infoDiv) return;
      infoDiv.style.display = 'block';
      infoDiv.innerHTML = '<strong>â³ index.json ã‚’å†ç”Ÿæˆä¸­...</strong><br>students/ ãƒ•ã‚©ãƒ«ãƒ€å†…ã® JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã„ã¾ã™...';
      infoDiv.className = 'dataset-info';

      GenerateIndex.main()
        .then(function(indexData) {
          infoDiv.innerHTML = `
            <strong>âœ… index.json ã®å†ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ</strong><br>
            ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ•°: ${indexData.datasets.length}ä»¶<br>
            students/index.json ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚
          `;
          infoDiv.className = 'dataset-info';
          
          // 3ç§’å¾Œã«ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
          setTimeout(function() {
            loadDatasetList();
          }, 3000);
        })
        .catch(function(error) {
          const errorDiv = document.getElementById('dataset-error');
          errorDiv.style.display = 'block';
          errorDiv.innerHTML = '<strong>âŒ ã‚¨ãƒ©ãƒ¼</strong><br>' + escapeHtml(error.message);
          
          infoDiv.style.display = 'none';
        });
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      if (text == null) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠUIã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    window.renderSessionSelector = function(studentData) {
      const selector = document.getElementById('session-selector');
      const sel = document.getElementById('session-select');
      
      if (!selector || !sel) return;
      
      if (!studentData || !studentData.sessions || !Array.isArray(studentData.sessions) || studentData.sessions.length === 0) {
        selector.style.display = 'none';
        return;
      }
      
      selector.style.display = 'block';
      sel.innerHTML = '';
      
      studentData.sessions.forEach(function(s) {
        const opt = document.createElement('option');
        opt.value = s.session_id;
        opt.textContent = s.session_id + ' (' + (s.generated_at || 'æ—¥æ™‚ä¸æ˜') + ')';
        sel.appendChild(opt);
      });
    };

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³è¡¨ç¤ºãƒœã‚¿ãƒ³
    const viewSessionBtn = document.getElementById('view-session');
    if (viewSessionBtn) {
      viewSessionBtn.addEventListener('click', function() {
        const sessionSelect = document.getElementById('session-select');
        if (!sessionSelect) return;
        const selectedSessionId = sessionSelect.value;
        if (!selectedSessionId || !window.currentStudentData) return;
      
      const session = window.currentStudentData.sessions.find(function(s) {
        return s.session_id === selectedSessionId;
      });
      
      if (session && session.logs) {
        const projectData = window.currentProjectData || {};
        if (window.AnalysisDashboard && window.AnalysisDashboard.renderMasteryDashboard) {
          window.AnalysisDashboard.renderMasteryDashboard(session.logs, projectData);
        } else if (window.AnalysisDashboard) {
          window.AnalysisDashboard.analyze(session.logs, projectData);
        }
      }
      });
    }

    // å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆç®—ãƒœã‚¿ãƒ³
    const viewAllSessionsBtn = document.getElementById('view-all-sessions');
    if (viewAllSessionsBtn) {
      viewAllSessionsBtn.addEventListener('click', function() {
        if (!window.currentStudentData) return;
        if (!window.AnalysisDashboard) {
          alert('AnalysisDashboard ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
          return;
        }
      
      const logsAll = window.AnalysisDashboard.mergeAllSessions(window.currentStudentData);
      const projectData = window.currentProjectData || {};
      if (window.AnalysisDashboard.renderMasteryDashboard) {
        window.AnalysisDashboard.renderMasteryDashboard(logsAll, projectData);
      } else {
        window.AnalysisDashboard.analyze(logsAll, projectData);
      }
      });
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§ã‚’å–å¾—ï¼ˆé‡è¤‡ç™»éŒ²ã‚’é˜²ãï¼‰
    if (!window._analysisPageInitialized) {
      window._analysisPageInitialized = true;
    window.addEventListener('DOMContentLoaded', function() {
      loadDatasetList();
        loadQuizVersionList();
      });
    }

    // ã‚¯ã‚¤ã‚ºãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    async function loadQuizVersionList() {
      const projectSelect = document.getElementById('versionProjectSelect');
      const versionList = document.getElementById('quizVersionList');
      
      if (!projectSelect || !versionList) return;
      
      const projectId = projectSelect.value || 'default';
      
      try {
        if (window.DatasetLoader && window.DatasetLoader.listQuizVersions) {
          const versions = await window.DatasetLoader.listQuizVersions(projectId);
          
          versionList.innerHTML = '';
          if (versions.length === 0) {
            versionList.innerHTML = '<option value="">ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</option>';
            return;
          }
          
          versions.forEach(function(version) {
            const option = document.createElement('option');
            option.value = version;
            option.textContent = version;
            versionList.appendChild(option);
          });
        } else {
          versionList.innerHTML = '<option value="">DatasetLoader ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“</option>';
        }
      } catch (error) {
        console.error('Failed to load quiz versions:', error);
        if (versionList) {
          versionList.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
        }
      }
    }

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé¸æŠå¤‰æ›´æ™‚ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆé‡è¤‡ç™»éŒ²ã‚’é˜²ãï¼‰
    if (!window._versionProjectSelectListenerAdded) {
      window._versionProjectSelectListenerAdded = true;
      const projectSelect = document.getElementById('versionProjectSelect');
      if (projectSelect) {
        projectSelect.addEventListener('change', function() {
          loadQuizVersionList();
        });
      }
    }

    // å·®åˆ†è¡¨ç¤ºãƒœã‚¿ãƒ³ï¼ˆé‡è¤‡ç™»éŒ²ã‚’é˜²ãï¼‰
    if (!window._loadVersionDiffBtnListenerAdded) {
      window._loadVersionDiffBtnListenerAdded = true;
      const loadVersionDiffBtn = document.getElementById('loadVersionDiffBtn');
      if (loadVersionDiffBtn) {
        loadVersionDiffBtn.addEventListener('click', async function() {
        const versionList = document.getElementById('quizVersionList');
        const projectSelect = document.getElementById('versionProjectSelect');
        const diffContainer = document.getElementById('diffContainer');
        
        if (!versionList || !projectSelect || !diffContainer) return;
        
        const selectedVersion = versionList.value;
        const projectId = projectSelect.value || 'default';
        
        if (!selectedVersion) {
          alert('ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        
        diffContainer.innerHTML = '<p style="color: #666;">èª­ã¿è¾¼ã¿ä¸­...</p>';
        diffContainer.style.display = 'block';
        
        try {
          // quiz.json ã¨é¸æŠã•ã‚ŒãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ¯”è¼ƒ
          const [quizResponse, versionResponse] = await Promise.all([
            fetch(`../../projects/${projectId}/quiz.json`),
            fetch(`../../projects/${projectId}/quiz_versions/${selectedVersion}`)
          ]);
          
          if (!quizResponse.ok || !versionResponse.ok) {
            throw new Error('ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
          
          const quizData = await quizResponse.json();
          const versionData = await versionResponse.json();
          
          // JSON diff ã‚’è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
          const diff = diffJSON(quizData, versionData);
          renderDiffTable(diff);
        } catch (error) {
          console.error('Failed to load version diff:', error);
          if (diffContainer) {
            const escapeHtml = window.AnalysisDashboard && window.AnalysisDashboard.escapeHtml ? window.AnalysisDashboard.escapeHtml : function(s) { return s; };
            diffContainer.innerHTML = '<p style="color: #e53e3e;">å·®åˆ†ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + escapeHtml(error.message) + '</p>';
          }
        }
        });
      }
    }

    //â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // diff ã® UI å‡¦ç†
    //â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    async function loadVersionOptions() {
      try {
        const projectId = localStorage.getItem('projectId') || 'default';
        
        // quiz.json ã‚’èª­ã¿è¾¼ã‚€
        const quizPath = `../../projects/${projectId}/quiz.json`;
        const quizResponse = await fetch(quizPath);
        
        const versions = [];
        if (quizResponse.ok) {
          const quiz = await quizResponse.json();
          versions.push({ filename: 'quiz.json', label: 'quiz.json (ç¾åœ¨ã®ã‚¯ã‚¤ã‚º)' });
        }
        
        // localStorage ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ã‚’å–å¾—
        try {
          const historyKey = `quiz_versions_${projectId}`;
          const saved = localStorage.getItem(historyKey);
          if (saved) {
            const history = JSON.parse(saved);
            history.forEach(function(v) {
              if (v.filename && v.filename !== 'quiz.json') {
                versions.push({ filename: v.filename, label: v.filename });
              }
            });
          }
        } catch (e) {
          console.warn('Failed to load version history:', e);
        }
        
        const oldSel = document.getElementById('diffOld');
        const newSel = document.getElementById('diffNew');
        
        if (oldSel && newSel) {
          oldSel.innerHTML = '';
          newSel.innerHTML = '';
          
          versions.forEach(function(v) {
            const option1 = new Option(v.label, v.filename);
            const option2 = new Option(v.label, v.filename);
            oldSel.appendChild(option1);
            newSel.appendChild(option2);
          });
          
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ quiz.json ã‚’é¸æŠ
          if (versions.length > 0) {
            newSel.value = 'quiz.json';
          }
        }
      } catch (error) {
        console.error('Failed to load version options:', error);
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã‚€
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadVersionOptions);
    } else {
      loadVersionOptions();
    }

    const runDiffBtn = document.getElementById('runDiffBtn');
    if (runDiffBtn) {
      runDiffBtn.addEventListener('click', async function() {
        const oldVersion = document.getElementById('diffOld').value;
        const newVersion = document.getElementById('diffNew').value;
        
        if (!oldVersion || !newVersion) {
          alert('ä¸¡æ–¹ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        
        if (oldVersion === newVersion) {
          alert('ç•°ãªã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          return;
        }
        
        const resultDiv = document.getElementById('diffResult');
        if (!resultDiv) return;
        resultDiv.innerHTML = '<p style="color: #666;">èª­ã¿è¾¼ã¿ä¸­...</p>';
        
        try {
          const projectId = localStorage.getItem('projectId') || 'default';
          
          // quiz.json ã®å ´åˆã¯ç›´æ¥èª­ã¿è¾¼ã¿ã€ãã‚Œä»¥å¤–ã¯ quiz_versions/ ã‹ã‚‰èª­ã¿è¾¼ã¿
          const oldPath = oldVersion === 'quiz.json' 
            ? `../../projects/${projectId}/quiz.json`
            : `../../projects/${projectId}/quiz_versions/${oldVersion}`;
          const newPath = newVersion === 'quiz.json'
            ? `../../projects/${projectId}/quiz.json`
            : `../../projects/${projectId}/quiz_versions/${newVersion}`;
          
          const [oldResponse, newResponse] = await Promise.all([
            fetch(oldPath),
            fetch(newPath)
          ]);
          
          if (!oldResponse.ok || !newResponse.ok) {
            throw new Error('ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
          
          const oldData = await oldResponse.json();
          const newData = await newResponse.json();
          
          const diff = diffJSON(oldData, newData);
          renderDiffTable(diff);
        } catch (error) {
          console.error('Failed to diff versions:', error);
          resultDiv.innerHTML = '<p style="color: #e53e3e;">å·®åˆ†ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + escapeHtml(error.message) + '</p>';
        }
      });
    }

    function diffJSON(a, b) {
      const diff = {};
      const keys = new Set([...Object.keys(a || {}), ...Object.keys(b || {})]);
      
      for (const k of keys) {
        const aVal = a[k];
        const bVal = b[k];
        
        if (JSON.stringify(aVal) !== JSON.stringify(bVal)) {
          diff[k] = {
            old: aVal !== undefined ? aVal : null,
            new: bVal !== undefined ? bVal : null
          };
        }
      }
      
      return diff;
    }

    function renderDiffTable(diff) {
      const container = document.getElementById('diffResult');
      if (!container) return;
      
      if (Object.keys(diff).length === 0) {
        container.innerHTML = '<p style="color: #48bb78; padding: 15px; background: #f0fff4; border-radius: 6px;">âœ… å·®åˆ†ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }
      
      let html = `
        <h4>å·®åˆ†çµæœï¼ˆ${Object.keys(diff).length}ä»¶ã®å¤‰æ›´ï¼‰</h4>
        <table border="1" style="border-collapse: collapse; width: 100%; margin-top: 15px;">
          <thead>
            <tr style="background: #f9f9f9;">
              <th style="padding: 10px; text-align: left;">é …ç›®</th>
              <th style="padding: 10px; text-align: left;">æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³</th>
              <th style="padding: 10px; text-align: left;">æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³</th>
              <th style="padding: 10px; text-align: left;">å¤‰æ›´ã‚¿ã‚¤ãƒ—</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      for (const k in diff) {
        const d = diff[k];
        const type =
          d.old === null ? 'add' :
          d.new === null ? 'delete' :
          'change';
        
        const color =
          type === 'add' ? '#c2f7c2' :
          type === 'delete' ? '#f7c2c2' :
          '#fff8b3';
        
        const typeLabel =
          type === 'add' ? 'è¿½åŠ ' :
          type === 'delete' ? 'å‰Šé™¤' :
          'å¤‰æ›´';
        
        const oldStr = d.old === null ? '(ãªã—)' : JSON.stringify(d.old, null, 2);
        const newStr = d.new === null ? '(ãªã—)' : JSON.stringify(d.new, null, 2);
        
        html += `
          <tr style="background: ${color};">
            <td style="padding: 10px; font-weight: 600;">${escapeHtml(k)}</td>
            <td style="padding: 10px; font-family: monospace; font-size: 0.9em; max-width: 300px; word-break: break-all;">${escapeHtml(oldStr)}</td>
            <td style="padding: 10px; font-family: monospace; font-size: 0.9em; max-width: 300px; word-break: break-all;">${escapeHtml(newStr)}</td>
            <td style="padding: 10px; font-weight: 600;">${typeLabel}</td>
          </tr>
        `;
      }
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    //â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ”¹å–„åº¦åˆ†æ
    //â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    const runImproveBtn = document.getElementById('runImproveBtn');
    if (runImproveBtn) {
      runImproveBtn.addEventListener('click', async function() {
        const chartDiv = document.getElementById('improveChart');
        if (!chartDiv) return;
        chartDiv.innerHTML = '<p style="color: #666;">èª­ã¿è¾¼ã¿ä¸­...</p>';
        
        try {
          // ç”Ÿå¾’ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚€
          let allLogs = [];
          
          // ç¾åœ¨èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
          if (window.currentStudentData && window.currentStudentData.sessions) {
            allLogs = AnalysisDashboard.mergeAllSessions(window.currentStudentData);
          } else if (window.currentLogs && Array.isArray(window.currentLogs)) {
            allLogs = window.currentLogs;
          } else {
            // students/index.json ã‹ã‚‰èª­ã¿è¾¼ã‚€
            try {
              const indexResponse = await fetch('../../students/index.json');
              if (indexResponse.ok) {
                const index = await indexResponse.json();
                const students = index.students || [];
                
                // å„ç”Ÿå¾’ã®ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚€
                for (const student of students.slice(0, 10)) { // æœ€åˆã®10äººã¾ã§
                  try {
                    const logResponse = await fetch(`../../students/${student.file}`);
                    if (logResponse.ok) {
                      const logData = await logResponse.json();
                      if (logData.sessions) {
                        logData.sessions.forEach(function(session) {
                          if (session.logs) {
                            allLogs = allLogs.concat(session.logs);
                          }
                        });
                      } else if (logData.logs) {
                        allLogs = allLogs.concat(logData.logs);
                      }
                    }
                  } catch (e) {
                    console.warn('Failed to load student log:', student.file, e);
                  }
                }
              }
            } catch (e) {
              console.warn('Failed to load students index:', e);
            }
          }
          
          if (allLogs.length === 0) {
            chartDiv.innerHTML = '<p style="color: #e53e3e;">ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
            return;
          }
          
          // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
          const versionStats = {};
          allLogs.forEach(function(log) {
            const version = log.quiz_version || 'unknown';
            if (!versionStats[version]) {
              versionStats[version] = { count: 0, correct: 0, rt: 0, totalRt: 0 };
            }
            versionStats[version].count++;
            if (log.correct === true) {
              versionStats[version].correct++;
            }
            if (log.response_time) {
              versionStats[version].totalRt += log.response_time;
            }
          });
          
          // å¹³å‡ã‚’è¨ˆç®—
          for (const version in versionStats) {
            const stats = versionStats[version];
            stats.correctRate = stats.count > 0 ? (stats.correct / stats.count) * 100 : 0;
            stats.avgRt = stats.count > 0 ? stats.totalRt / stats.count : 0;
          }
          
          renderImproveChart(versionStats);
        } catch (error) {
          console.error('Failed to compute improve stats:', error);
          chartDiv.innerHTML = '<p style="color: #e53e3e;">æ”¹å–„åº¦ã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + escapeHtml(error.message) + '</p>';
        }
      });
    }

    function renderImproveChart(stats) {
      const container = document.getElementById('improveChart');
      
      const versions = Object.keys(stats).sort();
      if (versions.length === 0) {
        container.innerHTML = '<p style="color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }
      
      let html = '<h3>ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ¥ æ­£ç­”ç‡ã®æ¨ç§»</h3>';
      html += '<div style="margin-top: 20px;">';
      html += '<table border="1" style="border-collapse: collapse; width: 100%;">';
      html += '<thead><tr style="background: #f9f9f9;"><th style="padding: 10px;">ãƒãƒ¼ã‚¸ãƒ§ãƒ³</th><th style="padding: 10px;">ãƒ­ã‚°æ•°</th><th style="padding: 10px;">æ­£ç­”ç‡</th><th style="padding: 10px;">å¹³å‡åå¿œæ™‚é–“</th></tr></thead>';
      html += '<tbody>';
      
      versions.forEach(function(v) {
        const s = stats[v];
        const correctRateColor = s.correctRate >= 70 ? '#48bb78' : s.correctRate >= 50 ? '#f6ad55' : '#e53e3e';
        
        html += `
          <tr>
            <td style="padding: 10px; font-weight: 600;">${escapeHtml(v)}</td>
            <td style="padding: 10px;">${s.count}ä»¶</td>
            <td style="padding: 10px; color: ${correctRateColor}; font-weight: 600;">${s.correctRate.toFixed(1)}%</td>
            <td style="padding: 10px;">${s.avgRt.toFixed(2)}ç§’</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      html += '</div>';
      
      // æ”¹å–„åº¦ã®å¯è¦–åŒ–ï¼ˆChart.jsã‚’ä½¿ç”¨ï¼‰
      if (typeof Chart !== 'undefined') {
        html += '<div style="margin-top: 30px;"><canvas id="improveChartCanvas" style="max-height: 400px;"></canvas></div>';
        container.innerHTML = html;
        
        // Chart.jsã§ã‚°ãƒ©ãƒ•ã‚’æç”»
        setTimeout(function() {
          const ctx = document.getElementById('improveChartCanvas');
          if (ctx) {
            const labels = versions;
            const correctRates = versions.map(v => stats[v].correctRate);
            const avgRts = versions.map(v => stats[v].avgRt);
            
            new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [
                  {
                    label: 'æ­£ç­”ç‡ (%)',
                    data: correctRates,
                    borderColor: '#2d7bf4',
                    backgroundColor: 'rgba(45, 123, 244, 0.1)',
                    yAxisID: 'y',
                    tension: 0.4
                  },
                  {
                    label: 'å¹³å‡åå¿œæ™‚é–“ (ç§’)',
                    data: avgRts,
                    borderColor: '#48bb78',
                    backgroundColor: 'rgba(72, 187, 120, 0.1)',
                    yAxisID: 'y1',
                    tension: 0.4
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                  title: {
                    display: true,
                    text: 'ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ¥ã®æ”¹å–„åº¦æ¨ç§»'
                  },
                  legend: {
                    display: true
                  }
                },
                scales: {
                  y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                      display: true,
                      text: 'æ­£ç­”ç‡ (%)'
                    },
                    min: 0,
                    max: 100
                  },
                  y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                      display: true,
                      text: 'å¹³å‡åå¿œæ™‚é–“ (ç§’)'
                    },
                    grid: {
                      drawOnChartArea: false
                    }
                  }
                }
              }
            });
          }
        }, 100);
      } else {
        container.innerHTML = html;
      }
    }

  </script>
</body>
</html>



