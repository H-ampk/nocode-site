<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å­¦ç¿’ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <link rel="stylesheet" href="../public/css/main.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="../src/admin/pin.js" defer></script>
  <script>window.addEventListener('DOMContentLoaded',function(){ if(window.AdminAuth) AdminAuth.init({admin:true}); });</script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    h1 {
      margin-bottom: 1rem;
      color: #333;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 2rem;
      color: #666;
      text-decoration: none;
    }
    .back-link:hover {
      color: #333;
    }
    .dataset-section {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dataset-section h2 {
      margin-top: 0;
      font-size: 1.5rem;
      color: #333;
    }
    .dataset-list {
      margin: 1rem 0;
    }
    .dataset-category {
      margin: 1.5rem 0;
    }
    .dataset-category-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
      cursor: pointer;
      user-select: none;
    }
    .dataset-category-title:hover {
      color: #4CAF50;
    }
    .dataset-category-list {
      margin-left: 1.5rem;
      margin-top: 0.5rem;
    }
    .dataset-item {
      display: block;
      padding: 0.75rem 1rem;
      margin: 0.5rem 0;
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      color: #333;
      transition: all 0.2s;
    }
    .dataset-item:hover {
      background: #e8f5e9;
      border-color: #4CAF50;
      transform: translateX(4px);
    }
    .dataset-item:active {
      background: #c8e6c9;
    }
    .create-section {
      margin-top: 2rem;
      padding-top: 2rem;
      border-top: 2px solid #eee;
    }
    .create-form {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .form-group {
      flex: 1;
      min-width: 150px;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }
    .btn {
      padding: 0.5rem 1.5rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background 0.2s;
    }
    .btn:hover {
      background: #45a049;
    }
    .btn:active {
      background: #3d8b40;
    }
    .dataset-info {
      margin-top: 1rem;
      padding: 1rem;
      background: #e8f5e9;
      border-radius: 4px;
      font-size: 0.9rem;
      color: #2e7d32;
      border-left: 4px solid #4CAF50;
    }
    .dataset-error {
      margin-top: 1rem;
      padding: 1rem;
      background: #ffebee;
      border-radius: 4px;
      font-size: 0.9rem;
      color: #d32f2f;
      border-left: 4px solid #f44336;
    }
    .loading {
      color: #666;
      font-style: italic;
    }
    .dashboard {
      display: none;
    }
    .dashboard.active {
      display: block;
    }
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      border-bottom: 2px solid #ddd;
    }
    .tab {
      padding: 0.75rem 1.5rem;
      background: #f0f0f0;
      border: none;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-size: 1rem;
      color: #666;
      transition: all 0.2s;
    }
    .tab:hover {
      background: #e0e0e0;
    }
    .tab.active {
      background: white;
      color: #333;
      border-bottom: 2px solid white;
      margin-bottom: -2px;
      font-weight: 600;
    }
    .tab-content {
      display: none;
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    .tab-content.active {
      display: block;
    }
    .tab-content h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #eee;
      padding-bottom: 0.5rem;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }
    .stat-card {
      background: #f9f9f9;
      padding: 1.5rem;
      border-radius: 8px;
      text-align: center;
    }
    .stat-card .label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.5rem;
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: bold;
      color: #333;
    }
    .chart-container {
      position: relative;
      height: 400px;
      margin: 2rem 0;
    }
    .chart-container.small {
      height: 300px;
    }
    .table-container {
      overflow-x: auto;
      margin: 1.5rem 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
    }
    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f9f9f9;
      font-weight: 600;
      color: #333;
    }
    tr:hover {
      background: #f9f9f9;
    }
    .path-pattern {
      font-family: monospace;
      background: #f0f0f0;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    .warning {
      color: #d32f2f;
      padding: 1rem;
      background: #ffebee;
      border-radius: 4px;
      margin: 1rem 0;
    }
    .success {
      color: #2e7d32;
      padding: 1rem;
      background: #e8f5e9;
      border-radius: 4px;
      margin: 1rem 0;
    }
    .analysis-btn {
      margin-top: 12px;
      padding: 10px 20px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    .analysis-btn:hover {
      background: #1976D2;
    }
    #analysis-banner {
      background: #4CAF50;
      color: white;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: bold;
      text-align: center;
      cursor: pointer;
      border-radius: 4px;
      margin-top: 1rem;
      margin-bottom: 1rem;
    }
    #analysis-banner.hidden {
      display: none;
    }
    #analysis-open {
      text-decoration: underline;
    }
    #analysis-result-area {
      margin-top: 20px;
    }
    /* å­¦è¡“ãƒ¬ãƒãƒ¼ãƒˆå½¢å¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .report-card {
      padding: 20px;
      border-radius: 8px;
      background: #fff;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #2196F3;
    }
    .report-card h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #2c3e50;
      font-size: 1.3rem;
      font-weight: 600;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 8px;
    }
    .report-number {
      font-size: 1.8rem;
      color: #2c3e50;
      font-weight: 700;
      margin: 10px 0;
      text-align: center;
    }
    .report-rt-block {
      margin: 15px 0;
    }
    .report-rt-block .report-number {
      font-size: 1.8rem;
      font-weight: bold;
      color: #2c3e50;
    }
    .report-number-large {
      font-size: 2.5rem;
    }
    .report-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .report-stat-item {
      text-align: center;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 6px;
    }
    .report-stat-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 5px;
    }
    .report-stat-value {
      font-size: 1.8rem;
      color: #2c3e50;
      font-weight: 600;
    }
    .report-comment {
      margin-top: 15px;
      padding: 12px;
      background: #f9f9f9;
      border-left: 3px solid #4CAF50;
      border-radius: 4px;
      font-size: 0.95rem;
      color: #555;
      line-height: 1.6;
    }
    .report-notes {
      padding: 15px;
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 6px;
      margin-top: 15px;
    }
    .report-notes h4 {
      margin-top: 0;
      color: #856404;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }
    .report-notes p {
      margin: 0;
      color: #856404;
      line-height: 1.6;
    }
    /* åå¿œæ™‚é–“ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .analysis-section {
      padding: 16px;
      margin-top: 20px;
      background: #fafafa;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
    }
    .analysis-section h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #ddd;
      padding-bottom: 8px;
    }
    .analysis-result {
      margin-bottom: 12px;
      font-size: 1.1em;
      line-height: 1.6;
      color: #555;
      padding: 12px;
      background: #fff;
      border-radius: 6px;
      border-left: 4px solid #2196F3;
    }
    #rt-fitting-chart {
      max-height: 400px;
    }
  </style>
</head>
<body>
  <a href="admin.html" class="back-link">â† Admin ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
  <h1>ğŸ“Š å­¦ç¿’ãƒ‡ãƒ¼ã‚¿åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

  <div class="dataset-section">
    <h2>ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆé¸æŠ</h2>
    <div id="dataset-list" class="dataset-list">
      <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    <div id="dataset-info" class="dataset-info" style="display: none;"></div>
    <div id="dataset-error" class="dataset-error" style="display: none;"></div>

    <div class="create-section">
      <h3>æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹</h3>
      <div class="create-form">
        <div class="form-group">
          <label for="new-dataset-name">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆå</label>
          <input type="text" id="new-dataset-name" placeholder="ä¾‹: classA_2025" />
        </div>
        <div class="form-group">
          <label for="new-dataset-type">ã‚¿ã‚¤ãƒ—</label>
          <select id="new-dataset-type">
            <option value="class">ã‚¯ãƒ©ã‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆclassï¼‰</option>
            <option value="student">å€‹äººãƒ‡ãƒ¼ã‚¿ï¼ˆstudentï¼‰</option>
          </select>
        </div>
        <div class="form-group">
          <button class="btn" onclick="createNewDatasetFile()">ä½œæˆ</button>
        </div>
      </div>
      <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #eee;">
        <button class="btn" style="background: #2196F3;" onclick="regenerateIndex()">ğŸ”„ index.json ã‚’å†ç”Ÿæˆ</button>
        <p style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
          students/ ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã™ã¹ã¦ã® JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ index.json ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚
        </p>
      </div>
    </div>
  </div>

  <div id="dashboard" class="dashboard">
    <div class="tabs">
      <button class="tab active" data-tab="overall">å…¨ä½“æ¦‚è¦</button>
      <button class="tab" data-tab="questions">å•é¡Œåˆ¥åˆ†æ</button>
      <button class="tab" data-tab="confusions">æ¦‚å¿µæ··åŒåˆ†æ</button>
      <button class="tab" data-tab="response-time">åå¿œæ™‚é–“ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</button>
      <button class="tab" data-tab="paths">è¿·ã„ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ</button>
      <button class="tab" data-tab="glossary">Glossary æç¤ºå±¥æ­´</button>
      <button class="tab" data-tab="analysis-run">ğŸ“Š åˆ†æå®Ÿè¡Œ</button>
    </div>

    <div id="tab-overall" class="tab-content active">
      <h3>å…¨ä½“æ¦‚è¦</h3>
      <div id="overall-stats"></div>
    </div>

    <div id="tab-questions" class="tab-content">
      <h3>å•é¡Œåˆ¥åˆ†æ</h3>
      <div id="question-stats"></div>
    </div>

    <div id="tab-confusions" class="tab-content">
      <h3>æ¦‚å¿µæ··åŒåˆ†æï¼ˆconceptTagï¼‰</h3>
      <div id="confusion-stats"></div>
    </div>

    <div id="tab-response-time" class="tab-content">
      <h3>åå¿œæ™‚é–“ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«é›†è¨ˆ</h3>
      <div id="response-time-stats"></div>
    </div>

    <div id="tab-paths" class="tab-content">
      <h3>è¿·ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆpathï¼‰åˆ†æ</h3>
      <div id="path-stats"></div>
    </div>

    <div id="tab-glossary" class="tab-content">
      <h3>Glossary æç¤ºå±¥æ­´ã®é›†è¨ˆ</h3>
      <div id="glossary-stats"></div>
    </div>

    <div id="tab-analysis-run" class="tab-content">
      <h3>ğŸ“Š Julia ã‚’ç”¨ã„ãŸå­¦ç¿’ãƒ‡ãƒ¼ã‚¿è©³ç´°åˆ†æ</h3>

      <p>ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã€Julia ã«ã‚ˆã‚‹ãƒãƒƒã‚¯ã‚¨ã‚°ã‚¶ã‚¯ãƒˆè§£æã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>

      <label>ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ï¼š</label>
      <select id="analysis-student-file"></select>

      <button id="run-analysis-btn" class="analysis-btn">
        ğŸ“Š ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã™ã‚‹
      </button>

      <div id="analysis-banner" class="hidden">
        ğŸ“Š åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ â€” <span id="analysis-open">çµæœã‚’è¦‹ã‚‹</span>
      </div>

      <div id="analysis-result-area" style="margin-top:20px;"></div>
    </div>
  </div>

  <!-- åå¿œæ™‚é–“ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <section id="rt-fitting-section" class="analysis-section" style="display:none;">
    <h3>â± åå¿œæ™‚é–“ãƒ•ã‚£ãƒƒãƒ†ã‚£ãƒ³ã‚°ï¼ˆæŒ‡æ•°åˆ†å¸ƒï¼‹æ­£è¦åˆ†å¸ƒï¼‰</h3>
    <div id="rt-fitting-result" class="analysis-result"></div>
    <canvas id="rt-fitting-chart"></canvas>
  </section>

  <script src="../src/admin/dataset_loader.js"></script>
  <script src="../src/admin/analysis.js"></script>
  <script src="../students/generate_index.js"></script>
  <script>
    var currentDataset = null;

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        document.getElementById('tab-' + tabId).classList.add('active');
      });
    });

    // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    function loadDatasetList() {
      DatasetLoader.listDatasets()
        .then(function(datasets) {
          const listContainer = document.getElementById('dataset-list');
          
          if (!datasets || datasets.length === 0) {
            listContainer.innerHTML = '<div class="dataset-error">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚students/index.json ã«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>';
            return;
          }

          // type ã§åˆ†é¡
          var classes = datasets.filter(function(ds) { return ds.type === 'class'; });
          var individuals = datasets.filter(function(ds) { return ds.type === 'student'; });

          let html = '';
          
          // ã‚¯ãƒ©ã‚¹ãƒ‡ãƒ¼ã‚¿
          if (classes.length > 0) {
            html += '<div class="dataset-category">';
            html += '<div class="dataset-category-title">â–¼ ã‚¯ãƒ©ã‚¹ãƒ‡ãƒ¼ã‚¿</div>';
            html += '<div class="dataset-category-list">';
            classes.forEach(function(dataset) {
              html += '<a href="#" class="dataset-item" data-dataset=\'' + JSON.stringify(dataset).replace(/'/g, '&#39;') + '\'>ğŸ“„ ' + escapeHtml(dataset.dataset_name) + '</a>';
            });
            html += '</div>';
            html += '</div>';
          }

          // å€‹äººãƒ‡ãƒ¼ã‚¿
          if (individuals.length > 0) {
            html += '<div class="dataset-category">';
            html += '<div class="dataset-category-title">â–¼ å€‹äººãƒ‡ãƒ¼ã‚¿</div>';
            html += '<div class="dataset-category-list">';
            individuals.forEach(function(dataset) {
              html += '<a href="#" class="dataset-item" data-dataset=\'' + JSON.stringify(dataset).replace(/'/g, '&#39;') + '\'>ğŸ“„ ' + escapeHtml(dataset.dataset_name) + '</a>';
            });
            html += '</div>';
            html += '</div>';
          }
          
          listContainer.innerHTML = html;

          // å„ãƒ•ã‚¡ã‚¤ãƒ«åã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ä¸
          listContainer.querySelectorAll('.dataset-item').forEach(function(item) {
            item.addEventListener('click', function(e) {
              e.preventDefault();
              const datasetJson = this.getAttribute('data-dataset');
              const dataset = JSON.parse(datasetJson);
              loadAndAnalyze(dataset);
            });
          });
        })
        .catch(function(error) {
          const listContainer = document.getElementById('dataset-list');
          listContainer.innerHTML = '<div class="dataset-error">ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + escapeHtml(error.message) + '</div>';
        });
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã‚“ã§åˆ†æ
    function loadAndAnalyze(dataset) {
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
      document.getElementById('dataset-error').style.display = 'none';
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      const infoDiv = document.getElementById('dataset-info');
      infoDiv.style.display = 'block';
      infoDiv.innerHTML = '<strong>èª­ã¿è¾¼ã¿ä¸­...</strong> ' + escapeHtml(dataset.dataset_name);
      infoDiv.className = 'dataset-info';

      DatasetLoader.loadDataset(dataset)
        .then(function(data) {
          const logs = AnalysisDashboard.loadQuizLog(data);
          
          if (logs && logs.length > 0) {
            currentDataset = dataset.dataset_name;
            
            var datasetName = data.dataset_name || dataset.dataset_name;
            var datasetType = data.type || dataset.type || 'unknown';
            var createdAt = data.created_at || data.generated_at || 'ä¸æ˜';
            
            infoDiv.innerHTML = `
              <strong>âœ… é¸æŠä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼š</strong> ${escapeHtml(dataset.dataset_name)}<br>
              ãƒ•ã‚¡ã‚¤ãƒ«å: ${escapeHtml(dataset.file)} | ã‚¿ã‚¤ãƒ—: ${escapeHtml(datasetType)}<br>
              ãƒ­ã‚°æ•°: ${logs.length}ä»¶ | ä½œæˆæ—¥æ™‚: ${escapeHtml(createdAt)}
            `;
            infoDiv.className = 'dataset-info';
            
            // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            document.getElementById('dashboard').classList.add('active');
            
            // åˆ†æã‚’å®Ÿè¡Œ
            AnalysisDashboard.analyze(logs);
          } else {
            throw new Error('æœ‰åŠ¹ãªãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
          }
        })
        .catch(function(error) {
          const errorDiv = document.getElementById('dataset-error');
          errorDiv.style.display = 'block';
          errorDiv.innerHTML = '<strong>âŒ ã‚¨ãƒ©ãƒ¼</strong><br>' + escapeHtml(error.message);
          
          infoDiv.style.display = 'none';
        });
    }

    // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
    function createNewDatasetFile() {
      const datasetName = document.getElementById('new-dataset-name').value.trim();
      const datasetType = document.getElementById('new-dataset-type').value;

      if (!datasetName) {
        alert('ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      try {
        // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
        const newDataset = DatasetLoader.createNewDataset(datasetName, datasetType);
        
        // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆï¼ˆdataset_name + ".json" ã«çµ±ä¸€ï¼‰
        const fileName = datasetName.replace(/[^a-zA-Z0-9_]/g, '_') + '.json';
        
        // JSON ãƒ•ã‚¡ã‚¤ãƒ«æœ¬ä½“ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const jsonStr = JSON.stringify(newDataset, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(url);
        
        // index.json ã‚’æ›´æ–°ï¼ˆæ–°ã—ã„ã‚¨ãƒ³ãƒˆãƒªã‚’è¿½åŠ ï¼‰
        DatasetLoader.updateIndexJson(fileName, datasetName, datasetType)
          .then(function(success) {
            const infoDiv = document.getElementById('dataset-info');
            infoDiv.style.display = 'block';
            infoDiv.className = 'dataset-info';
            
            if (success) {
              infoDiv.innerHTML = `
                <strong>âœ… ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ</strong><br>
                ãƒ•ã‚¡ã‚¤ãƒ«å: ${escapeHtml(fileName)}<br>
                students/${escapeHtml(fileName)} ã¨ students/index.json ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
              `;
              
              // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
              document.getElementById('new-dataset-name').value = '';
              
              // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
              setTimeout(function() {
                loadDatasetList();
              }, 1000);
            } else {
              infoDiv.innerHTML = `
                <strong>âš ï¸ ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ä½œæˆã•ã‚Œã¾ã—ãŸãŒã€index.json ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ</strong><br>
                ãƒ•ã‚¡ã‚¤ãƒ«å: ${escapeHtml(fileName)}<br>
                students/${escapeHtml(fileName)} ã¨æ‰‹å‹•ã§ students/index.json ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚
              `;
            }
          })
          .catch(function(error) {
            alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
          });
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    }

    // index.json ã‚’å†ç”Ÿæˆ
    function regenerateIndex() {
      const infoDiv = document.getElementById('dataset-info');
      infoDiv.style.display = 'block';
      infoDiv.innerHTML = '<strong>â³ index.json ã‚’å†ç”Ÿæˆä¸­...</strong><br>students/ ãƒ•ã‚©ãƒ«ãƒ€å†…ã® JSON ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã„ã¾ã™...';
      infoDiv.className = 'dataset-info';

      GenerateIndex.main()
        .then(function(indexData) {
          infoDiv.innerHTML = `
            <strong>âœ… index.json ã®å†ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ</strong><br>
            ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆæ•°: ${indexData.datasets.length}ä»¶<br>
            students/index.json ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¦ã‹ã‚‰ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚
          `;
          infoDiv.className = 'dataset-info';
          
          // 3ç§’å¾Œã«ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
          setTimeout(function() {
            loadDatasetList();
          }, 3000);
        })
        .catch(function(error) {
          const errorDiv = document.getElementById('dataset-error');
          errorDiv.style.display = 'block';
          errorDiv.innerHTML = '<strong>âŒ ã‚¨ãƒ©ãƒ¼</strong><br>' + escapeHtml(error.message);
          
          infoDiv.style.display = 'none';
        });
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
      if (text == null) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä¸€è¦§ã‚’å–å¾—
    window.addEventListener('DOMContentLoaded', function() {
      loadDatasetList();
    });
  </script>
</body>
</html>



