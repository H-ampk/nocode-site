<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœ¬æ£š</title>
  <link rel="stylesheet" href="../public/css/main.css" />
  <link rel="stylesheet" href="../public/css/admin.css" />
  <script src="../src/admin/pin.js" defer></script>
  <script>window.addEventListener('DOMContentLoaded',function(){ if(window.AdminAuth) AdminAuth.init({admin:true}); });</script>
  <style>
    body {
      background: #f5f5f5;
      padding: 20px;
    }
    .header {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .filter-bar {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .filter-tag {
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .filter-tag:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .filter-tag.active {
      border-color: #333;
      font-weight: bold;
    }
    .clear-filter {
      margin-left: 10px;
      padding: 6px 12px;
      background: #e0e0e0;
      border: none;
      border-radius: 20px;
      cursor: pointer;
    }
    .clear-filter:hover {
      background: #d0d0d0;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœ¬æ£š</h1>
    <div class="menu">
      <a href="admin.html">â† ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
      <button id="btn-create-project" class="create-project-btn" style="background: #4CAF50; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; margin-left: 10px; font-size: 0.9em;">
        ï¼‹ æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
      </button>
    </div>
  </div>

  <div class="filter-bar">
    <h3 style="margin: 0 0 10px 0;">ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿</h3>
    <div class="filter-tags" id="filter-tags">
      <span style="color: #666;">èª­ã¿è¾¼ã¿ä¸­...</span>
    </div>
    <button class="clear-filter" onclick="clearFilters()">ã™ã¹ã¦è¡¨ç¤º</button>
  </div>

  <div id="project-list" class="project-grid"></div>

  <!-- æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="createProjectModal" class="modal hidden">
    <div class="modal-content">
      <h3>æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</h3>
      <label style="display: block; margin-bottom: 8px; font-weight: 600;">ã‚¿ã‚¤ãƒˆãƒ«</label>
      <input id="newProjectTitle" type="text" placeholder="ä¾‹ï¼šæ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; margin-bottom: 16px; box-sizing: border-box;" />
      
      <label style="display: block; margin-bottom: 8px; font-weight: 600;">èª¬æ˜</label>
      <textarea id="newProjectDesc" placeholder="èª¬æ˜ã‚’å…¥åŠ›" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; margin-bottom: 16px; min-height: 80px; resize: vertical; box-sizing: border-box;"></textarea>

      <label style="display: block; margin-bottom: 8px; font-weight: 600;">ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
      <input id="newProjectTags" type="text" placeholder="ä¾‹ï¼šmath,logic" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px; margin-bottom: 20px; box-sizing: border-box;" />

      <div class="modal-actions">
        <button id="createProjectConfirm" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.95em;">ä½œæˆ</button>
        <button id="createProjectCancel" style="background: #718096; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.95em;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <script>
    // =======================
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è‡ªå‹•è¿½åŠ ï¼ˆsavedProjectsã«çµ±åˆï¼‰
    // =======================
    (function ensureTemplates() {
      try {
        const templates = [
          {
            id: "template_quiz_basic",
            title: "ãƒ†ãƒ³ãƒ—ãƒ¬: é¸æŠå¼ã‚¯ã‚¤ã‚º",
            description: "æ­´å²ã¨ç§‘å­¦ã®äºŒå•æ§‹æˆã®ã‚¯ã‚¤ã‚ºãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",
            tags: ["template", "quiz"],
            updated_at: new Date().toISOString(),
            questionCount: 2
          },
          {
            id: "template_flashcard_basic",
            title: "ãƒ†ãƒ³ãƒ—ãƒ¬: å¾©ç¿’ã‚«ãƒ¼ãƒ‰",
            description: "æš—è¨˜ã‚«ãƒ¼ãƒ‰å½¢å¼ã§å‰é¢ã¨è£é¢ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ",
            tags: ["template", "flashcard"],
            updated_at: new Date().toISOString(),
            questionCount: 2
          }
        ];

        const list = JSON.parse(localStorage.getItem("savedProjects") || "[]");
        let updated = false;

        templates.forEach(t => {
          if (!list.find(x => x.id === t.id)) {
            list.push(t);
            updated = true;
            console.log("ğŸ“˜ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è¿½åŠ :", t.id);
          }
        });

        if (updated) {
          localStorage.setItem("savedProjects", JSON.stringify(list));
          console.log("âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’savedProjectsã«è¿½åŠ ã—ã¾ã—ãŸ");
        }
      } catch (e) {
        console.warn("âš ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¿½åŠ ã‚¨ãƒ©ãƒ¼:", e);
      }
    })();

    // =======================
    // ã‚¿ã‚°ã‚«ãƒ©ãƒ¼ç”Ÿæˆ
    // =======================
    const tagColorMap = {};

    function getTagColor(tag) {
      if (!tagColorMap[tag]) {
        let hash = 0;
        for (let i = 0; i < tag.length; i++) {
          hash = tag.charCodeAt(i) + ((hash << 5) - hash);
        }
        const hue = Math.abs(hash % 360);
        tagColorMap[tag] = `hsl(${hue}, 70%, 85%)`;
      }
      return tagColorMap[tag];
    }

    // =======================
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿
    // =======================
    let allProjects = [];
    let selectedTags = new Set();

    async function loadProjects() {
      const list = document.getElementById("project-list");
      list.innerHTML = '<p style="text-align:center; padding:40px;">èª­ã¿è¾¼ã¿ä¸­...</p>';

      try {
        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
        // æ³¨æ„: ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸€è¦§ã‚’å–å¾—ã™ã‚‹ã“ã¨ã¯ã§ããªã„ãŸã‚ã€
        // æ—¢çŸ¥ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’åˆ—æŒ™ã™ã‚‹ã‹ã€ã‚µãƒ¼ãƒãƒ¼å´APIãŒå¿…è¦
        // å°†æ¥çš„ã«ã¯ projects/index.json ã®ã‚ˆã†ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’æ¨å¥¨
        const projectFolders = ['default', 'vector_test', 'dummy_project', 'sample_project', 'demo_project_01', 'demo_project_02', 'demo_project_03'];
        
        // projects/index.json ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ï¼ˆå°†æ¥ã®æ‹¡å¼µï¼‰
        try {
          const indexRes = await fetch('../projects/index.json');
          if (indexRes && indexRes.ok) {
            const indexData = await indexRes.json();
            if (indexData.projects && Array.isArray(indexData.projects)) {
              projectFolders.length = 0;
              indexData.projects.forEach(p => {
                if (p.id) projectFolders.push(p.id);
              });
              console.log("ğŸ“ index.json ã‹ã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’èª­ã¿è¾¼ã¿:", projectFolders.length, "ä»¶");
            }
          } else {
            console.warn("âš ï¸ projects/index.json ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆ404ï¼‰ã€‚æ—¢çŸ¥ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
          }
        } catch (e) {
          // index.json ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ—¢çŸ¥ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨
          console.warn("âš ï¸ projects/index.json ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", e.message);
          console.log("   æ—¢çŸ¥ã®ãƒ•ã‚©ãƒ«ãƒ€ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚index.json ã‚’ç”Ÿæˆã™ã‚‹ã«ã¯: node projects/generate_index.js");
        }
        
        allProjects = [];

        for (const folder of projectFolders) {
          try {
            const projectPath = `../projects/${folder}/project.json`;
            const quizPath = `../projects/${folder}/quiz.json`;
            
            const [projectRes, quizRes] = await Promise.all([
              fetch(projectPath).catch(() => null),
              fetch(quizPath).catch(() => null)
            ]);

            if (projectRes && projectRes.ok) {
              const projectData = await projectRes.json();
              let quizData = null;
              
              if (quizRes && quizRes.ok) {
                quizData = await quizRes.json();
              }

              // project_id ã®æ±ºå®š: project.json ã® project_id ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ãƒ•ã‚©ãƒ«ãƒ€å
              const projectId = projectData.project_id || folder;
              
              // è³ªå•æ•°ã‚’å–å¾—
              const questionCount = quizData?.questions?.length || 0;

              // æ›´æ–°æ—¥æ™‚ã‚’å–å¾—
              // ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚æ›´æ–°æ—¥æ™‚ã¯å–å¾—ã§ããªã„ãŸã‚ã€project.json ã® updated_at ã¾ãŸã¯ç¾åœ¨æ™‚åˆ»ã‚’ä½¿ç”¨
              let updatedAt = projectData.updated_at || new Date().toISOString();
              if (quizData && quizData.version_date) {
                updatedAt = quizData.version_date;
              }

              allProjects.push({
                id: projectId,  // project.json ã® project_id ã‚’å„ªå…ˆä½¿ç”¨
                title: projectData.title || quizData?.title || folder,
                description: projectData.description || quizData?.description || '',
                tags: projectData.tags || quizData?.tags || [],
                questionCount: questionCount,
                updated_at: updatedAt,
                projectPath: projectPath,
                quizPath: quizPath,
                folder: folder  // ãƒ•ã‚©ãƒ«ãƒ€åã‚‚ä¿æŒï¼ˆfetchãƒ‘ã‚¹ç”¨ï¼‰
              });
            }
          } catch (e) {
            console.warn(`Failed to load project ${folder}:`, e);
          }
        }

        // localStorage ã‹ã‚‰ã‚‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã‚€ï¼ˆsavedProjectså„ªå…ˆï¼‰
        try {
          // savedProjects[] ã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼ˆæ–°å½¢å¼ï¼‰
          const savedProjects = JSON.parse(localStorage.getItem("savedProjects") || "[]");
          savedProjects.forEach(p => {
            if (p && p.id) {
              // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å ´åˆã¯ç‰¹åˆ¥å‡¦ç†
              if (p.id.startsWith("template_")) {
                allProjects.push({
                  id: p.id,
                  title: p.title || 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ',
                  description: p.description || '',
                  tags: p.tags || [],
                  questionCount: p.questionCount || 0,
                  updated_at: p.updated_at || new Date().toISOString(),
                  isTemplate: true
                });
              } else {
                // é€šå¸¸ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼ˆproject_<id>ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼‰
                const dataStr = localStorage.getItem("project_" + p.id);
                if (dataStr) {
                  try {
                    const data = JSON.parse(dataStr);
                    allProjects.push({
                      id: p.id,
                      title: p.title || data.title || 'ç„¡é¡Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
                      description: p.description || data.description || '',
                      tags: p.tags || data.tags || [],
                      questionCount: data.questions?.length || 0,
                      updated_at: p.updated_at || new Date().toISOString(),
                      isLocalStorage: true,
                      data: data
                    });
                  } catch (e) {
                    console.warn("Failed to parse project data:", p.id, e);
                  }
                } else {
                  // project_<id> ãŒãªã„å ´åˆã¯ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿è¡¨ç¤º
                  allProjects.push({
                    id: p.id,
                    title: p.title || 'ç„¡é¡Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
                    description: p.description || '',
                    tags: p.tags || [],
                    questionCount: p.questionCount || 0,
                    updated_at: p.updated_at || new Date().toISOString(),
                    isLocalStorage: true
                  });
                }
              }
            }
          });
        } catch (e) {
          console.warn("Failed to load localStorage projects:", e);
        }
        
        // æ—§å½¢å¼ï¼ˆprojects[]ï¼‰ã‚‚äº’æ›æ€§ã®ãŸã‚ã«èª­ã¿è¾¼ã‚€
        try {
          const oldProjects = JSON.parse(localStorage.getItem("projects") || "[]");
          oldProjects.forEach(p => {
            if (p.data && !allProjects.find(ap => ap.id === (p.filename || `local_${Date.now()}`))) {
              allProjects.push({
                id: p.filename || `local_${Date.now()}`,
                title: p.name || p.data.title || 'ç„¡é¡Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ',
                description: p.data.description || '',
                tags: p.tags || p.data.tags || [],
                questionCount: p.data.questions?.length || 0,
                updated_at: p.updated_at || new Date().toISOString(),
                isLocalStorage: true,
                data: p.data
              });
            }
          });
        } catch (e) {
          console.warn("Failed to load old format projects:", e);
        }

        renderProjects();
        renderFilterTags();
      } catch (e) {
        console.error("Failed to load projects:", e);
        list.innerHTML = '<p style="text-align:center; padding:40px; color:#e53e3e;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
      }
    }

    // =======================
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚«ãƒ¼ãƒ‰è¡¨ç¤º
    // =======================
    function renderProjects() {
      const list = document.getElementById("project-list");
      if (!list) return;

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      let filtered = allProjects;
      if (selectedTags.size > 0) {
        filtered = allProjects.filter(p => {
          const projectTags = p.tags || [];
          return Array.from(selectedTags).every(tag => projectTags.includes(tag));
        });
      }

      if (filtered.length === 0) {
        list.innerHTML = '<p style="text-align:center; padding:40px; color:#666;">è©²å½“ã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }

      list.innerHTML = "";

      filtered.forEach(project => {
        if (!project || !project.id) {
          console.warn("âš ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™:", project);
          return;
        }
        
        const card = document.createElement("div");
        card.className = "project-card";
        card.setAttribute("data-project-id", project.id);

        const tagHTML = (project.tags || [])
          .map(t => {
            const color = getTagColor(t);
            return `<span class="tag-pill" style="background: ${color}; color: #333;">${escapeHtml(t)}</span>`;
          })
          .join("");

        const templateBadge = (project.tags && project.tags.includes('template')) 
          ? '<span class="badge badge-template" style="background: #4aa3ff; color: white; padding: 3px 8px; border-radius: 5px; font-size: 10px; margin-left: 6px;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</span>'
          : '';
        
        const projectId = project.id;
        
        card.innerHTML = `
          <h4 style="display: flex; align-items: center; gap: 8px;">${escapeHtml(project.title)}${templateBadge}</h4>
          <p style="color:#999; font-size:0.9em; margin:5px 0;">${escapeHtml(project.description || 'èª¬æ˜ãªã—')}</p>
          <div class="tag-area">${tagHTML || '<span style="color:#999;">ã‚¿ã‚°ãªã—</span>'}</div>
          <div style="display:flex; justify-content:space-between; margin-top:auto; padding-top:10px; border-top:1px solid #333;">
            <span style="color:#999; font-size:0.85em;">è³ªå•æ•°: ${project.questionCount || 0}</span>
            <span style="color:#999; font-size:0.85em;">${project.isTemplate || (project.tags && project.tags.includes('template')) ? 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ' : new Date(project.updated_at).toLocaleDateString('ja-JP')}</span>
          </div>
          <div style="display:flex; gap:8px; margin-top:10px;">
            <button class="open-btn" style="flex:1; padding:8px; background:#2d7bf4; color:white; border:none; border-radius:6px; cursor:pointer;" onclick="event.stopPropagation(); openEditor('${escapeHtml(projectId)}');">ç·¨é›†</button>
            <button class="open-btn" style="flex:1; padding:8px; background:#4a5568; color:white; border:none; border-radius:6px; cursor:pointer;" onclick="event.stopPropagation(); window.location.href='project_manager.html?projectId=${escapeHtml(projectId)}'">è¨­å®š</button>
            <button class="delete-btn" style="background:#ff4d4d; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-size:0.9em;" onclick="event.stopPropagation(); if(confirm('ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { deleteProject('${escapeHtml(projectId)}'); }">å‰Šé™¤</button>
          </div>
        `;

        card.addEventListener("click", () => loadProjectToEditor(project));
        list.appendChild(card);
      });
    }

    // =======================
    // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿è¡¨ç¤º
    // =======================
    function renderFilterTags() {
      const container = document.getElementById("filter-tags");
      if (!container) return;

      // å…¨ã‚¿ã‚°ã‚’åé›†
      const allTags = new Set();
      allProjects.forEach(p => {
        (p.tags || []).forEach(tag => allTags.add(tag));
      });

      if (allTags.size === 0) {
        container.innerHTML = '<span style="color:#666;">ã‚¿ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</span>';
        return;
      }

      container.innerHTML = "";

      Array.from(allTags).sort().forEach(tag => {
        const tagEl = document.createElement("span");
        tagEl.className = "filter-tag";
        if (selectedTags.has(tag)) {
          tagEl.classList.add("active");
        }
        tagEl.style.background = getTagColor(tag);
        tagEl.style.color = "#333";
        tagEl.textContent = tag;
        tagEl.addEventListener("click", (e) => {
          e.stopPropagation();
          toggleTagFilter(tag);
        });
        container.appendChild(tagEl);
      });
    }

    // =======================
    // ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿åˆ‡ã‚Šæ›¿ãˆ
    // =======================
    function toggleTagFilter(tag) {
      if (selectedTags.has(tag)) {
        selectedTags.delete(tag);
      } else {
        selectedTags.add(tag);
      }
      renderProjects();
      renderFilterTags();
    }

    function clearFilters() {
      selectedTags.clear();
      renderProjects();
      renderFilterTags();
    }

    // =======================
    // ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ãé–¢æ•°
    // =======================
    function openEditor(projectId) {
      if (!projectId) {
        console.warn("âš ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
        return;
      }
      const url = '../src/editor/editor.html?project_id=' + encodeURIComponent(projectId);
      console.log('ğŸ“ ç·¨é›†ãƒœã‚¿ãƒ³: é·ç§»å…ˆURL =', url);
      window.location.href = url;
    }

    // =======================
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤æ©Ÿèƒ½
    // =======================
    function deleteProject(id) {
      if (!id) {
        console.warn("âš ï¸ å‰Šé™¤å¯¾è±¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
        return;
      }
      
      try {
        // savedProjects[] ã‹ã‚‰å‰Šé™¤
        const list = JSON.parse(localStorage.getItem("savedProjects") || "[]");
        const filtered = list.filter(proj => proj.id !== id);
        localStorage.setItem("savedProjects", JSON.stringify(filtered));
        
        // project_<id> ã‹ã‚‰ã‚‚å‰Šé™¤
        localStorage.removeItem("project_" + id);
        
        console.log("âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ:", id);
        
        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ›´æ–°
        location.reload();
      } catch (e) {
        console.error("âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:", e);
        alert("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      }
    }

    // =======================
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¨ãƒ‡ã‚£ã‚¿ã«èª­ã¿è¾¼ã¿
    // =======================
    async function loadProjectToEditor(project) {
      try {
        // projectId ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ç›´æ¥ã‚¨ãƒ‡ã‚£ã‚¿ã«é·ç§»ï¼ˆproject_idãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ï¼‰
        if (project && project.id) {
          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å ´åˆã¯ç‰¹åˆ¥å‡¦ç†ï¼ˆlocalStorageã«ä¿å­˜ã—ã¦ã‹ã‚‰é·ç§»ï¼‰
          if (project.isTemplate || (project.id && project.id.startsWith("template_"))) {
            console.log("ğŸ“˜ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿:", project.id);
            // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã¯loadProjectFromIdã§å‡¦ç†ã•ã‚Œã‚‹ãŸã‚ã€ç›´æ¥é·ç§»
            window.location.href = `../src/editor/editor.html?project_id=${encodeURIComponent(project.id)}`;
            return;
          }
          
          // é€šå¸¸ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚‚ project_id ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§é·ç§»
          if (!project.isLocalStorage) {
            window.location.href = `../src/editor/editor.html?project_id=${encodeURIComponent(project.id)}`;
            return;
          }
        }
        
        let projectData = null;

        if (project.isLocalStorage && project.data) {
          // localStorage ã‹ã‚‰èª­ã¿è¾¼ã¿
          projectData = project.data;
        } else {
          // ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿
          const quizPath = project.quizPath;
          if (quizPath) {
            const response = await fetch(quizPath);
            if (response.ok) {
              projectData = await response.json();
            }
          }
        }

        if (!projectData) {
          alert("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          return;
        }

        // ã‚¨ãƒ‡ã‚£ã‚¿ã«æ¸¡ã™ãŸã‚ã« localStorage ã«ä¿å­˜
        localStorage.setItem("editor_current_project", JSON.stringify(projectData));
        
        // ã‚¨ãƒ‡ã‚£ã‚¿ãƒšãƒ¼ã‚¸ã«é·ç§»
        window.location.href = "../src/editor/editor.html?mode=edit";
      } catch (e) {
        console.error("Failed to load project:", e);
        alert("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      }
    }

    // =======================
    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    // =======================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // =======================
    // æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæ©Ÿèƒ½
    // =======================
    (function initCreateProjectModal() {
      const btnCreate = document.getElementById('btn-create-project');
      const modal = document.getElementById('createProjectModal');
      const btnConfirm = document.getElementById('createProjectConfirm');
      const btnCancel = document.getElementById('createProjectCancel');
      
      if (!btnCreate || !modal || !btnConfirm || !btnCancel) {
        console.warn("âš ï¸ æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        return;
      }
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      btnCreate.onclick = () => {
        document.getElementById('newProjectTitle').value = '';
        document.getElementById('newProjectDesc').value = '';
        document.getElementById('newProjectTags').value = '';
        modal.classList.remove('hidden');
      };
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      btnCancel.onclick = () => {
        modal.classList.add('hidden');
      };
      
      // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      modal.onclick = (e) => {
        if (e.target === modal) {
          modal.classList.add('hidden');
        }
      };
      
      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Ÿè¡Œ
      btnConfirm.onclick = async () => {
        const title = document.getElementById('newProjectTitle').value.trim();
        const desc = document.getElementById('newProjectDesc').value.trim();
        const tags = document.getElementById('newProjectTags').value.trim()
          .split(',')
          .map(s => s.trim())
          .filter(s => s);
        
        if (!title) {
          alert("ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™");
          return;
        }
        
        // ãƒ•ã‚©ãƒ«ãƒ€åã‚’ã‚¹ãƒ©ãƒƒã‚°åŒ–ï¼ˆè‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿è¨±å¯ï¼‰
        const folder = title
          .replace(/[^\w\s\-]/g, '') // è‹±æ•°å­—ã€ç©ºç™½ã€ãƒã‚¤ãƒ•ãƒ³ä»¥å¤–ã‚’å‰Šé™¤
          .replace(/\s+/g, '_')      // ç©ºç™½ã‚’ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã«å¤‰æ›
          .toLowerCase()
          .substring(0, 50); // æœ€å¤§50æ–‡å­—
        
        if (!folder) {
          alert("ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ãƒ•ã‚©ãƒ«ãƒ€åã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è‹±æ•°å­—ã‚’å«ã‚€ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        
        try {
          // ä½œæˆè¦æ±‚ã‚’ã‚µãƒ¼ãƒãƒ¼ã¸é€ã‚‹
          const res = await fetch('/admin-api/create-project', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ folder, title, desc, tags })
          });
          
          const data = await res.json();
          
          if (!res.ok) {
            alert("ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + (data.error || res.status));
            return;
          }
          
          // å®Œäº†ã—ãŸã‚‰ index.json å†ç”Ÿæˆ
          try {
            await fetch('/admin-api/generate-index');
          } catch (e) {
            console.warn("âš ï¸ index.json ã®å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
          }
          
          // localStorage ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
          try {
            const savedProjects = JSON.parse(localStorage.getItem("savedProjects") || "[]");
            const newProject = {
              id: folder,
              title: title,
              description: desc,
              tags: tags,
              updated_at: new Date().toISOString(),
              questionCount: 0
            };
            
            // æ—¢å­˜ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ï¼ˆé‡è¤‡ã‚’é˜²ãï¼‰
            const filtered = savedProjects.filter(p => p.id !== folder);
            filtered.push(newProject);
            localStorage.setItem("savedProjects", JSON.stringify(filtered));
          } catch (e) {
            console.warn("âš ï¸ localStorage ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
          }
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          modal.classList.add('hidden');
          
          // ã‚¨ãƒ‡ã‚£ã‚¿ã¸é·ç§»
          window.location.href = `../src/editor/editor.html?project_id=${encodeURIComponent(folder)}`;
        } catch (e) {
          console.error("âŒ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:", e);
          alert("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
        }
      };
    })();

    // =======================
    // åˆæœŸåŒ–
    // =======================
    document.addEventListener('DOMContentLoaded', loadProjects);
  </script>
</body>
</html>

