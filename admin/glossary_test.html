<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Glossary Loader Test</title>
  <link rel="stylesheet" href="../public/css/main.css" />
  <script src="../src/core/config.js"></script>
  <script src="../src/core/GlossaryLoader.js"></script>
  <script src="../src/auth/pin.js" defer></script>
  <script>window.addEventListener('DOMContentLoaded',function(){ if(window.AdminAuth) AdminAuth.init({admin:true}); });</script>
  <style>
    body {
      background: #f5f5f5;
      color: #222;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
    }
    .test-section {
      background: #fff;
      padding: 20px;
      margin-top: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      margin-top: 0;
      color: #333;
      font-size: 1.3rem;
    }
    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .controls label {
      font-weight: 500;
      color: #555;
    }
    .controls input[type="text"] {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    button {
      padding: 10px 20px;
      cursor: pointer;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      font-weight: 500;
      transition: background 0.2s;
    }
    button:hover {
      background: #357abd;
    }
    .result {
      margin-top: 15px;
    }
    #resultArea {
      margin-top: 15px;
    }
    .glossary-card {
      background: #ffffff;
      border: 1px solid #ddd;
      border-left: 4px solid #4a90e2;
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .glossary-term {
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    .glossary-term-id {
      font-size: 0.9rem;
      font-weight: normal;
      color: #888;
      margin-left: 8px;
    }
    .glossary-definition {
      margin-top: 8px;
      font-size: 1rem;
      line-height: 1.6;
      color: #555;
    }
    .glossary-tags {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .tag {
      display: inline-block;
      background: #e9f2ff;
      border: 1px solid #bcd7ff;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.85rem;
      color: #2c5aa0;
    }
    .glossary-empty {
      text-align: center;
      padding: 30px;
      color: #888;
      font-style: italic;
    }
    .domain-summary-card {
      background: #ffffff;
      border: 2px solid #4a90e2;
      padding: 18px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .domain-summary-card h2 {
      margin-top: 0;
      margin-bottom: 12px;
      color: #333;
      font-size: 1.2rem;
    }
    .keyword-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .keyword {
      background: #eef7ff;
      border: 1px solid #bcd7ff;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 0.9rem;
      color: #2c5aa0;
    }
    .term-card {
      background: #ffffff;
      border: 1px solid #ddd;
      border-left: 4px solid #4a90e2;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .term-name {
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    .term-section {
      margin-top: 10px;
      font-size: 0.95rem;
      line-height: 1.6;
      color: #555;
    }
    .term-section-title {
      font-weight: bold;
      color: #555;
      margin-right: 5px;
    }
    .section {
      margin-bottom: 20px;
    }
    .section h2 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #333;
      font-size: 1.2rem;
    }
    .controls select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    .global-term-card {
      background: #ffffff;
      border: 1px solid #ddd;
      border-left: 4px solid #4a90e2;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .global-term-name {
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    .fields-list, .links-list {
      margin-top: 8px;
    }
    .field-tag {
      background: #eef7ff;
      border: 1px solid #bcd7ff;
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 0.85rem;
      margin-right: 6px;
      display: inline-block;
      color: #2c5aa0;
    }
    .link-item {
      margin-top: 4px;
      font-size: 0.9rem;
    }
    .link-item a {
      color: #4a90e2;
      text-decoration: none;
    }
    .link-item a:hover {
      text-decoration: underline;
    }
    .example-box {
      margin-top: 10px;
      padding: 8px 12px;
      background: #fafafa;
      border-left: 3px solid #888;
      border-radius: 6px;
      font-size: 0.95rem;
      color: #555;
      line-height: 1.6;
    }
    .merge-section-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin: 20px 0 10px;
      color: #333;
    }
    .keyword-tag {
      background: #eef7ff;
      border: 1px solid #bcd7ff;
      padding: 4px 10px;
      border-radius: 10px;
      margin-right: 6px;
      margin-bottom: 6px;
      display: inline-block;
      color: #2c5aa0;
      font-size: 0.9rem;
    }
    .other-entry-card {
      background: #ffffff;
      border: 1px solid #bbb;
      border-left: 4px solid #999;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .other-entry-title {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 6px;
      color: #333;
    }
    .other-entry-card pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.85rem;
      margin: 0;
    }
    .policy-card {
      background: #ffffff;
      border: 1px solid #ccc;
      border-left: 4px solid #6a5acd;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .policy-title {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
    }
    .policy-card pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.85rem;
      margin-top: 8px;
    }
    /* Glossaryãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠUI */
    .glossary-template-box {
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .glossary-template-box h3 {
      margin-top: 0;
      margin-bottom: 12px;
      color: #333;
      font-size: 1.2rem;
    }
    #glossaryTemplateSelect {
      padding: 8px 12px;
      margin-right: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
      min-width: 300px;
    }
    #loadGlossaryTemplateBtn {
      padding: 8px 16px;
      background: #6a5be2;
      color: white;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    #loadGlossaryTemplateBtn:hover {
      background: #5548c4;
    }
    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æ©Ÿèƒ½ */
    .accordion-card {
      cursor: pointer;
      transition: 0.3s ease;
    }
    .accordion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      font-size: 1.1rem;
      padding: 10px 0;
    }
    .accordion-body {
      display: none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    .accordion-card.active .accordion-body {
      display: block;
    }
    .accordion-icon {
      transition: transform 0.3s;
      font-size: 0.9rem;
      color: #666;
      margin-left: 10px;
    }
    .accordion-card.active .accordion-icon {
      transform: rotate(180deg);
    }
    /* ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ */
    body.theme-blue .glossary-card,
    body.theme-blue .global-term-card,
    body.theme-blue .term-card {
      border-left-color: #4a90e2;
    }
    body.theme-green .glossary-card,
    body.theme-green .global-term-card,
    body.theme-green .term-card {
      border-left-color: #3cb371;
    }
    body.theme-purple .glossary-card,
    body.theme-purple .global-term-card,
    body.theme-purple .term-card {
      border-left-color: #9370db;
    }
    body.theme-light .glossary-card,
    body.theme-light .global-term-card,
    body.theme-light .term-card {
      border-left-color: #444;
    }
    body.theme-blue .domain-summary-card {
      border-color: #4a90e2;
    }
    body.theme-green .domain-summary-card {
      border-color: #3cb371;
    }
    body.theme-purple .domain-summary-card {
      border-color: #9370db;
    }
    body.theme-light .domain-summary-card {
      border-color: #444;
    }
    body.theme-blue .policy-card {
      border-left-color: #4a90e2;
    }
    body.theme-green .policy-card {
      border-left-color: #3cb371;
    }
    body.theme-purple .policy-card {
      border-left-color: #9370db;
    }
    body.theme-light .policy-card {
      border-left-color: #444;
    }
    /* ãƒ‰ãƒ¡ã‚¤ãƒ³å›³å¼åŒ– */
    #domainMapArea {
      margin-top: 20px;
      padding: 15px;
      background: #fafafa;
      border-radius: 8px;
    }
    #domainMapArea h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #333;
    }
    #domainMapArea canvas {
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
      max-width: 100%;
    }
    pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <h1>Glossary Loader ãƒ†ã‚¹ãƒˆ</h1>
  <div class="menu">
    <a href="admin.html">â† ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
  </div>

  <div class="glossary-template-box">
    <h3>ğŸ“š Glossary ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ</h3>
    <div class="controls">
      <label>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:</label>
      <select id="glossaryTemplateSelect">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <option value="thinking_skills">â‘  æ€è€ƒã‚¹ã‚­ãƒ«ï¼ˆè«–ç†ãƒ»åˆ†æãƒ»çµ±åˆï¼‰</option>
        <option value="psychology_old">â‘¡ æ•™è‚²å¿ƒç†ï¼ˆèªçŸ¥ãƒ»è¨˜æ†¶ãƒ»æ³¨æ„ï¼‰</option>
        <option value="future_skills">â‘¢ AIæ™‚ä»£ã®å­¦åŠ›ï¼ˆå•é¡Œè§£æ±ºãƒ»ãƒ¡ã‚¿èªçŸ¥ãƒ»è‡ªå·±èª¿æ•´ï¼‰</option>
        <option value="learning_science">â‘£ æ•™è‚²å­¦ï¼ˆå­¦ç¿’ç§‘å­¦ï¼šç†è§£åº¦ãƒ»è»¢ç§»ãƒ»ãƒ¡ã‚¿èªçŸ¥ãƒ»å­¦ç¿’æ–¹ç•¥ï¼‰</option>
        <option value="psychology">â‘¤ å¿ƒç†å­¦ï¼ˆèªçŸ¥ï¼šæ³¨æ„ãƒ»è¨˜æ†¶ãƒ»æ¨è«–ãƒ»å‡¦ç†é€Ÿåº¦ï¼‰</option>
        <option value="ai_literacy">â‘¥ AIãƒªãƒ†ãƒ©ã‚·ãƒ¼ï¼ˆæ‰¹åˆ¤çš„æ€è€ƒãƒ»ãƒ‡ãƒ¼ã‚¿æ€è€ƒãƒ»AIå”åƒï¼‰</option>
      </select>
      <button id="loadGlossaryTemplateBtn">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã‚€</button>
    </div>
    <div id="templatePreviewArea" style="margin-top: 15px;"></div>
  </div>

  <div class="test-section" style="margin-top: 0;">
    <h2>âš™ï¸ UIè¨­å®š</h2>
    <div class="controls">
      <label>ãƒ†ãƒ¼ãƒ:</label>
      <select id="themeSelector">
        <option value="light">Light</option>
        <option value="blue" selected>Blue</option>
        <option value="green">Green</option>
        <option value="purple">Purple</option>
      </select>
      <label>ã‚¿ã‚°æ¤œç´¢:</label>
      <input type="text" id="tagSearchInput" placeholder="ã‚¿ã‚°æ¤œç´¢ï¼ˆanalysis, memoryâ€¦ï¼‰" style="flex: 1; max-width: 300px;" />
    </div>
  </div>

  <div class="test-section">
    <h2>1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆGlossaryèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</h2>
    <div class="controls">
      <label>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDï¼š</label>
      <input type="text" id="projectIdInput" value="default" />
      <button id="loadProjectBtn">èª­ã¿è¾¼ã‚€</button>
    </div>
    <div id="resultArea"></div>
  </div>

  <div class="test-section">
    <h2>2. ãƒ‰ãƒ¡ã‚¤ãƒ³Glossaryèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</h2>
    <div class="controls">
      <label>ãƒ‰ãƒ¡ã‚¤ãƒ³åï¼š</label>
      <select id="domainSelect">
        <option value="psychology">psychology</option>
        <option value="AI">AI</option>
      </select>
      <button id="loadDomainBtn">èª­ã¿è¾¼ã‚€</button>
    </div>
    <div id="domainResultArea"></div>
    <div id="domainMapArea"></div>
  </div>

  <div class="test-section">
    <h2>3. ã‚°ãƒ­ãƒ¼ãƒãƒ«Glossaryèª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</h2>
    <div class="controls">
      <button id="loadGlobalBtn">èª­ã¿è¾¼ã‚€</button>
    </div>
    <div id="globalResultArea"></div>
  </div>

  <div class="test-section">
    <h2>4. ãƒãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ</h2>
    <div class="controls">
      <button id="runMergeBtn">ãƒãƒ¼ã‚¸ã‚’å®Ÿè¡Œ</button>
    </div>
    <div id="mergeResultArea"></div>
  </div>

  <div class="test-section">
    <h2>5. Policy ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</h2>
    <div class="controls">
      <label>Mode:</label>
        <select id="policyMode">
          <option value="project">project</option>
          <option value="domain">domain</option>
          <option value="global">global</option>
        </select>
      <label>Domains:</label>
      <input type="text" id="policyDomains" placeholder="psychology,AI" value="psychology,AI" />
      <button id="runPolicyBtn">èª­ã¿è¾¼ã‚€</button>
    </div>
    <div id="policyInfo"></div>
    <div id="policyResultArea"></div>
  </div>

  <script>
    // Glossaryãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®šç¾©
    const GLOSSARY_TEMPLATES = {
      thinking_skills: {
        terms: {
          "skill.logic": {
            id: "skill.logic",
            name: "è«–ç†",
            definition: "ç­‹é“ç«‹ã¦ã¦è€ƒãˆã‚‹åŠ›ã€‚",
            example: "åŸå› ã¨çµæœã‚’æ•´ç†ã™ã‚‹ã€‚",
            tags: ["thinking"]
          },
          "skill.analysis": {
            id: "skill.analysis",
            name: "åˆ†æ",
            definition: "æ§‹æˆè¦ç´ ã‚„é–¢ä¿‚æ€§ã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹åŠ›ã€‚",
            example: "è¤‡é›‘ãªå•é¡Œã‚’åˆ†è§£ã—ã¦ç†è§£ã™ã‚‹ã€‚",
            tags: ["thinking"]
          },
          "skill.synthesis": {
            id: "skill.synthesis",
            name: "çµ±åˆ",
            definition: "è¤‡æ•°ã®è¦ç´ ã‚’çµ„ã¿åˆã‚ã›æ–°ã—ã„ç†è§£ã‚’ä½œã‚‹åŠ›ã€‚",
            example: "è¤‡æ•°ã®è³‡æ–™ã‚’ã¾ã¨ã‚ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’æ›¸ãã€‚",
            tags: ["thinking"]
          }
        }
      },
      psychology_old: {
        terms: {
          "psy.cognition": {
            id: "psy.cognition",
            name: "èªçŸ¥",
            definition: "æƒ…å ±ã‚’å‡¦ç†ã—ç†è§£ã™ã‚‹å¿ƒçš„æ©Ÿèƒ½ã€‚",
            example: "å•é¡Œè§£æ±ºã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ¤œè¨ã™ã‚‹ã€‚",
            tags: ["psychology"]
          },
          "psy.memory": {
            id: "psy.memory",
            name: "è¨˜æ†¶",
            definition: "æƒ…å ±ã‚’ä¿æŒã—æƒ³èµ·ã™ã‚‹èƒ½åŠ›ã€‚",
            example: "é‡è¦ãªæ¦‚å¿µã‚’è¨˜æ†¶ã—ã¦èª¬æ˜ã™ã‚‹ã€‚",
            tags: ["psychology"]
          },
          "psy.attention": {
            id: "psy.attention",
            name: "æ³¨æ„",
            definition: "åˆºæ¿€ã‚„æƒ…å ±ã«æ„è­˜ã‚’å‘ã‘ã‚‹èƒ½åŠ›ã€‚",
            example: "è¤‡æ•°ã®é¸æŠè‚¢ã‹ã‚‰1ã¤ã‚’é¸ã¶ã¨ãã®é›†ä¸­ã€‚",
            tags: ["psychology"]
          }
        }
      },
      future_skills: {
        terms: {
          "future.problem_solving": {
            id: "future.problem_solving",
            name: "å•é¡Œè§£æ±º",
            definition: "èª²é¡Œã«å¯¾ã—ã¦è§£æ±ºæ–¹æ³•ã‚’æ§‹ç¯‰ã™ã‚‹èƒ½åŠ›ã€‚",
            example: "æƒ…å ±ã‚’æ•´ç†ã—ã¦æœ€é©è§£ã‚’å°ãã€‚",
            tags: ["21st"]
          },
          "future.metacognition": {
            id: "future.metacognition",
            name: "ãƒ¡ã‚¿èªçŸ¥",
            definition: "è‡ªåˆ†ã®æ€è€ƒã®éç¨‹ã‚’ç†è§£ã—èª¿æ•´ã™ã‚‹åŠ›ã€‚",
            example: "è‡ªåˆ†ã®è€ƒãˆæ–¹ã‚’æŒ¯ã‚Šè¿”ã‚‹ã€‚",
            tags: ["21st"]
          },
          "future.self_regulation": {
            id: "future.self_regulation",
            name: "è‡ªå·±èª¿æ•´",
            definition: "è‡ªåˆ†ã®è¡Œå‹•ã‚„å­¦ç¿’ã‚’ç®¡ç†ã™ã‚‹èƒ½åŠ›ã€‚",
            example: "è¨ˆç”»ã‚’ç«‹ã¦ã€å®Ÿè¡Œã—ã€æ”¹å–„ã™ã‚‹ã€‚",
            tags: ["21st"]
          }
        }
      },
      learning_science: {
        terms: {
          "learning.understanding": {
            id: "learning.understanding",
            name: "ç†è§£åº¦",
            definition: "æ¦‚å¿µåŒå£«ã®é–¢ä¿‚æ€§ã‚’ç†è§£ã—ã¦ã„ã‚‹ã‹ã€‚",
            example: "é–¢é€£ã™ã‚‹æ¦‚å¿µã®é•ã„ã‚„ç¹‹ãŒã‚Šã‚’èª¬æ˜ã§ãã‚‹ã€‚",
            tags: ["learning"]
          },
          "learning.transfer": {
            id: "learning.transfer",
            name: "è»¢ç§»å¯èƒ½æ€§",
            definition: "å­¦ã‚“ã å†…å®¹ã‚’æ–°ã—ã„çŠ¶æ³ã«å¿œç”¨ã§ãã‚‹åŠ›ã€‚",
            example: "æ—¢ç¿’äº‹é …ã‚’ä½¿ã£ã¦åˆ¥ã®å•é¡Œã‚’è§£ã‘ã‚‹ã€‚",
            tags: ["learning"]
          },
          "learning.metacognition": {
            id: "learning.metacognition",
            name: "ãƒ¡ã‚¿èªçŸ¥",
            definition: "è‡ªåˆ†ã®ç†è§£çŠ¶æ…‹ã‚’æŠŠæ¡ã—èª¿æ•´ã§ãã‚‹åŠ›ã€‚",
            example: "ã©ã“ãŒã‚ã‹ã£ã¦ã„ãªã„ã‹è¨€èªåŒ–ã§ãã‚‹ã€‚",
            tags: ["learning"]
          },
          "learning.strategy": {
            id: "learning.strategy",
            name: "å­¦ç¿’æ–¹ç•¥",
            definition: "æœ‰åŠ¹ãªå­¦ç¿’æ–¹æ³•ã‚’ä½¿ãˆã‚‹ã‹ã€‚",
            example: "é‡è¦éƒ¨åˆ†ã‚’è¦ç´„ã—ã¦æ•´ç†ã™ã‚‹ã€‚",
            tags: ["learning"]
          }
        }
      },
      psychology: {
        terms: {
          "cognition.attention": {
            id: "cognition.attention",
            name: "æ³¨æ„",
            definition: "å¿…è¦ãªæƒ…å ±ã«ç„¦ç‚¹ã‚’åˆã‚ã›ã‚‹èƒ½åŠ›ã€‚",
            example: "é‡è¦ç®‡æ‰€ã«é›†ä¸­ã™ã‚‹ã€‚",
            tags: ["cognition"]
          },
          "cognition.memory": {
            id: "cognition.memory",
            name: "è¨˜æ†¶",
            definition: "å­¦ç¿’å†…å®¹ã‚’ä¿æŒãƒ»æƒ³èµ·ã™ã‚‹èƒ½åŠ›ã€‚",
            example: "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ„å‘³ã‚’æ­£ç¢ºã«è¦šãˆã¦ã„ã‚‹ã€‚",
            tags: ["cognition"]
          },
          "cognition.reasoning": {
            id: "cognition.reasoning",
            name: "æ¨è«–",
            definition: "æƒ…å ±ã‚’çµ„ã¿åˆã‚ã›ã¦çµè«–ã‚’å°ãèƒ½åŠ›ã€‚",
            example: "å› æœé–¢ä¿‚ã‚’èª¬æ˜ã§ãã‚‹ã€‚",
            tags: ["cognition"]
          },
          "cognition.processing": {
            id: "cognition.processing",
            name: "å‡¦ç†é€Ÿåº¦",
            definition: "æƒ…å ±å‡¦ç†ã®é€Ÿã•ã¨åŠ¹ç‡ã€‚",
            example: "çŸ­æ™‚é–“ã§å†…å®¹ã‚’ç†è§£ã™ã‚‹ã€‚",
            tags: ["cognition"]
          }
        }
      },
      ai_literacy: {
        terms: {
          "ai.critical": {
            id: "ai.critical",
            name: "æ‰¹åˆ¤çš„æ€è€ƒ",
            definition: "AIã®å‡ºåŠ›ã‚’éµœå‘‘ã¿ã«ã›ãšæ¤œè¨¼ã™ã‚‹åŠ›ã€‚",
            example: "AIã®å›ç­”ã®å¦¥å½“æ€§ã‚’åˆ¤æ–­ã™ã‚‹ã€‚",
            tags: ["ai"]
          },
          "ai.data_reason": {
            id: "ai.data_reason",
            name: "ãƒ‡ãƒ¼ã‚¿æ€è€ƒ",
            definition: "ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ„å‘³ã‚’èª­ã¿å–ã‚‹åŠ›ã€‚",
            example: "ã‚°ãƒ©ãƒ•ã‚’èª­ã¿å–ã‚Šå‚¾å‘ã‚’èª¬æ˜ã™ã‚‹ã€‚",
            tags: ["ai"]
          },
          "ai.meta": {
            id: "ai.meta",
            name: "AIæ™‚ä»£ã®ãƒ¡ã‚¿èªçŸ¥",
            definition: "AIã¨äººé–“ã®å½¹å‰²ã‚’ä½¿ã„åˆ†ã‘ã‚‹åŠ›ã€‚",
            example: "AIã«ä¾å­˜ã›ãšã€è‡ªåˆ†ã®ç†è§£é™ç•Œã‚’åˆ¤æ–­ã™ã‚‹ã€‚",
            tags: ["ai"]
          },
          "ai.collaboration": {
            id: "ai.collaboration",
            name: "AIå”åƒ",
            definition: "AIã‚’åˆ©ç”¨ã—ã¦å•é¡Œè§£æ±ºã‚’é€²ã‚ã‚‹èƒ½åŠ›ã€‚",
            example: "AIã®ææ¡ˆã‚’äººé–“ã®åˆ¤æ–­ã§æ”¹å–„ã™ã‚‹ã€‚",
            tags: ["ai"]
          }
        }
      }
    };

    // window.currentGlossary ã¯ã‚¨ãƒ‡ã‚£ã‚¿ã§ç›´æ¥ä½¿ç”¨ã•ã‚Œã‚‹

    function escapeHtml(text) {
      if (!text) return '';
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderGlossaryCards(glossaryObj) {
      const container = document.getElementById("resultArea");
      container.innerHTML = "";

      if (!glossaryObj || Object.keys(glossaryObj).length === 0) {
        container.innerHTML = '<div class="glossary-empty">GlossaryãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
        return;
      }

      Object.values(glossaryObj).forEach(function(entry) {
        if (!entry) return;
        
        const div = document.createElement("div");
        div.className = "glossary-card accordion-card";

        const termName = escapeHtml(entry.name || 'ï¼ˆåç§°ãªã—ï¼‰');
        const termId = escapeHtml(entry.id || '');
        const definition = escapeHtml(entry.definition || 'ï¼ˆå®šç¾©ãªã—ï¼‰');
        const tags = entry.tags || entry.fields || [];
        const tagsStr = tags.join(',');

        div.setAttribute("data-tags", tagsStr);

        div.innerHTML = 
          '<div class="accordion-header">' +
          '<span class="glossary-term">' + termName + 
          (termId ? '<span class="glossary-term-id">ï¼ˆ' + termId + 'ï¼‰</span>' : '') + 
          '</span>' +
          '<span class="accordion-icon">â–¼</span>' +
          '</div>' +
          '<div class="accordion-body">' +
          '<div class="glossary-definition">' + definition + '</div>' +
          (tags.length > 0 ? 
            '<div class="glossary-tags">' + 
            tags.map(function(t) { 
              return '<span class="tag">' + escapeHtml(t) + '</span>'; 
            }).join('') + 
            '</div>' : '') +
          '</div>';

        container.appendChild(div);
      });

      // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
      initAccordion(container);
    }

    document.getElementById("loadProjectBtn").addEventListener("click", function() {
      const projectId = document.getElementById("projectIdInput").value || 'default';
      const container = document.getElementById("resultArea");
      container.innerHTML = '<div class="glossary-empty">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      GlossaryLoader.loadProjectGlossary(projectId, { admin: true })
        .then(function(glossary) {
          renderGlossaryCards(glossary);
        })
        .catch(function(error) {
          container.innerHTML = '<div class="glossary-empty" style="color: #d32f2f;">ã‚¨ãƒ©ãƒ¼: ' + escapeHtml(error.message) + '</div>';
        });
    });

    function renderDomainGlossary(domainGlossary) {
      const area = document.getElementById("domainResultArea");
      area.innerHTML = "";

      if (!domainGlossary || (Object.keys(domainGlossary).length === 0 && !domainGlossary.domain_definition && !domainGlossary.keywords && !domainGlossary.terms)) {
        area.innerHTML = '<div class="glossary-empty">GlossaryãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
        return;
      }

      // --- ãƒ‰ãƒ¡ã‚¤ãƒ³æ¦‚è¦ ---
      if (domainGlossary.domain_definition) {
        const summary = document.createElement("div");
        summary.className = "domain-summary-card";
        summary.innerHTML = 
          '<h2>ğŸ“˜ ãƒ‰ãƒ¡ã‚¤ãƒ³æ¦‚è¦</h2>' +
          '<div>' + escapeHtml(domainGlossary.domain_definition) + '</div>';
        area.appendChild(summary);
      }

      // --- ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ ---
      if (domainGlossary.keywords && domainGlossary.keywords.length > 0) {
        const kwBox = document.createElement("div");
        kwBox.className = "section";
        kwBox.innerHTML = '<h2>ğŸ”‘ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</h2>';
        
        const kwList = document.createElement("div");
        kwList.className = "keyword-list";

        domainGlossary.keywords.forEach(function(k) {
          const tag = document.createElement("span");
          tag.className = "keyword";
          tag.textContent = k;
          kwList.appendChild(tag);
        });

        kwBox.appendChild(kwList);
        area.appendChild(kwBox);
      }

      // --- ç”¨èªä¸€è¦§ ---
      if (domainGlossary.terms && Object.keys(domainGlossary.terms).length > 0) {
        const termsBox = document.createElement("div");
        termsBox.className = "section";
        termsBox.innerHTML = '<h2>ğŸ“™ ç”¨èªä¸€è¦§</h2>';

        Object.values(domainGlossary.terms).forEach(function(t) {
          if (!t) return;
          
          const card = document.createElement("div");
          card.className = "term-card accordion-card";

          const termName = escapeHtml(t.name || 'ï¼ˆåç§°ãªã—ï¼‰');
          const termId = escapeHtml(t.id || '');
          const definition = escapeHtml(t.definition || 'â€•');
          const domainDef = t.domain_definition ? escapeHtml(t.domain_definition) : '';
          const example = t.example ? escapeHtml(t.example) : '';
          const note = t.note ? escapeHtml(t.note) : '';
          const tags = t.tags || t.fields || [];
          const tagsStr = tags.join(',');

          card.setAttribute("data-tags", tagsStr);

          var cardHtml = 
            '<div class="accordion-header">' +
            '<span class="term-name">' + termName + 
            (termId ? 'ï¼ˆ' + termId + 'ï¼‰' : '') + 
            '</span>' +
            '<span class="accordion-icon">â–¼</span>' +
            '</div>' +
            '<div class="accordion-body">' +
            '<div class="term-section">' +
            '<span class="term-section-title">å®šç¾©ï¼š</span>' +
            definition +
            '</div>';

          if (domainDef) {
            cardHtml += 
              '<div class="term-section">' +
              '<span class="term-section-title">ãƒ‰ãƒ¡ã‚¤ãƒ³å®šç¾©ï¼š</span>' +
              domainDef +
              '</div>';
          }

          if (example) {
            cardHtml += 
              '<div class="term-section">' +
              '<span class="term-section-title">ä¾‹ï¼š</span>' +
              example +
              '</div>';
          }

          if (note) {
            cardHtml += 
              '<div class="term-section">' +
              '<span class="term-section-title">è£œè¶³ï¼š</span>' +
              note +
              '</div>';
          }

          cardHtml += '</div>';

          card.innerHTML = cardHtml;
          termsBox.appendChild(card);
        });

        area.appendChild(termsBox);
      }

      if (area.innerHTML === "") {
        area.innerHTML = '<div class="glossary-empty">GlossaryãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
      }

      // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
      initAccordion(area);

      // ãƒ‰ãƒ¡ã‚¤ãƒ³å›³å¼åŒ–
      if (domainGlossary.keywords && domainGlossary.keywords.length > 0) {
        renderDomainMap(domainGlossary);
      }
    }

    document.getElementById("loadDomainBtn").addEventListener("click", function() {
      const domain = document.getElementById("domainSelect").value;
      const area = document.getElementById("domainResultArea");
      area.innerHTML = '<div class="glossary-empty">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      GlossaryLoader.loadDomainGlossary(domain, { admin: true })
        .then(function(glossary) {
          renderDomainGlossary(glossary);
        })
        .catch(function(error) {
          area.innerHTML = '<div class="glossary-empty" style="color: #d32f2f;">ã‚¨ãƒ©ãƒ¼: ' + escapeHtml(error.message) + '</div>';
        });
    });

    function renderGlobalGlossary(globalGlossary) {
      const area = document.getElementById("globalResultArea");
      area.innerHTML = "";

      if (!globalGlossary || !globalGlossary.terms || Object.keys(globalGlossary.terms).length === 0) {
        area.innerHTML = '<div class="glossary-empty">GlossaryãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
        return;
      }

      Object.values(globalGlossary.terms).forEach(function(term) {
        if (!term) return;
        
        const card = document.createElement("div");
        card.className = "global-term-card accordion-card";

        const termName = escapeHtml(term.name || 'ï¼ˆåç§°ãªã—ï¼‰');
        const termId = escapeHtml(term.id || '');
        const definition = escapeHtml(term.definition || 'â€•');
        const fields = term.fields || [];
        const links = term.links || [];
        const example = term.example ? escapeHtml(term.example) : '';
        const tagsStr = fields.join(',');

        card.setAttribute("data-tags", tagsStr);

        const fieldsHtml = fields.length > 0 ? 
          fields.map(function(f) { 
            return '<span class="field-tag">' + escapeHtml(f) + '</span>'; 
          }).join('') : '';

        const linksHtml = links.length > 0 ? 
          links.map(function(l) { 
            return '<div class="link-item"><a href="' + escapeHtml(l) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(l) + '</a></div>'; 
          }).join('') : '';

        var cardHtml = 
          '<div class="accordion-header">' +
          '<span class="global-term-name">' + termName + 
          (termId ? 'ï¼ˆ' + termId + 'ï¼‰' : '') + 
          '</span>' +
          '<span class="accordion-icon">â–¼</span>' +
          '</div>' +
          '<div class="accordion-body">' +
          '<div class="term-section">' +
          '<span class="term-section-title">å®šç¾©ï¼š</span>' +
          definition +
          '</div>';

        if (fieldsHtml) {
          cardHtml += 
            '<div class="fields-list">' +
            '<span class="term-section-title">åˆ†é‡ï¼š</span>' +
            fieldsHtml +
            '</div>';
        }

        if (linksHtml) {
          cardHtml += 
            '<div class="links-list">' +
            '<span class="term-section-title">é–¢é€£ãƒªãƒ³ã‚¯ï¼š</span>' +
            linksHtml +
            '</div>';
        }

        if (example) {
          cardHtml += 
            '<div class="example-box">' +
            'ã€ä¾‹ã€‘' + example +
            '</div>';
        }

        cardHtml += '</div>';

        card.innerHTML = cardHtml;
        area.appendChild(card);
      });

      // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
      initAccordion(area);
    }

    document.getElementById("loadGlobalBtn").addEventListener("click", function() {
      const area = document.getElementById("globalResultArea");
      area.innerHTML = '<div class="glossary-empty">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      GlossaryLoader.loadGlobalGlossary({ admin: true })
        .then(function(glossary) {
          renderGlobalGlossary(glossary);
        })
        .catch(function(error) {
          area.innerHTML = '<div class="glossary-empty" style="color: #d32f2f;">ã‚¨ãƒ©ãƒ¼: ' + escapeHtml(error.message) + '</div>';
        });
    });

    function renderMergeResult(merged) {
      const area = document.getElementById("mergeResultArea");
      area.innerHTML = "";

      if (!merged || Object.keys(merged).length === 0) {
        area.innerHTML = '<div class="glossary-empty">ãƒãƒ¼ã‚¸çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
        return;
      }

      // ===== 1) terms ã‚»ã‚¯ã‚·ãƒ§ãƒ³ =====
      if (merged.terms && Object.keys(merged.terms).length > 0) {
        const title = document.createElement("div");
        title.className = "merge-section-title";
        title.textContent = "ğŸ“™ çµ±åˆæ¸ˆã¿ç”¨èªä¸€è¦§";
        area.appendChild(title);

        Object.values(merged.terms).forEach(function(term) {
          if (!term) return;
          
          const card = document.createElement("div");
          card.className = "global-term-card accordion-card";

          const termName = escapeHtml(term.name || 'ï¼ˆåç§°ãªã—ï¼‰');
          const termId = escapeHtml(term.id || '');
          const definition = escapeHtml(term.definition || 'â€•');
          const domainDef = term.domain_definition ? escapeHtml(term.domain_definition) : '';
          const note = term.note ? escapeHtml(term.note) : '';
          const fields = term.fields || [];
          const links = term.links || [];
          const example = term.example ? escapeHtml(term.example) : '';
          const tags = term.tags || fields || [];
          const tagsStr = tags.join(',');

          card.setAttribute("data-tags", tagsStr);

          const fieldsHtml = fields.length > 0 ? 
            fields.map(function(f) { 
              return '<span class="field-tag">' + escapeHtml(f) + '</span>'; 
            }).join('') : '';

          const linksHtml = links.length > 0 ? 
            links.map(function(l) { 
              return '<div class="link-item"><a href="' + escapeHtml(l) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(l) + '</a></div>'; 
            }).join('') : '';

          var cardHtml = 
            '<div class="accordion-header">' +
            '<span class="global-term-name">' + termName + 
            (termId ? 'ï¼ˆ' + termId + 'ï¼‰' : '') + 
            '</span>' +
            '<span class="accordion-icon">â–¼</span>' +
            '</div>' +
            '<div class="accordion-body">' +
            '<div class="term-section">' +
            '<span class="term-section-title">å®šç¾©ï¼š</span>' +
            definition +
            '</div>';

          if (domainDef) {
            cardHtml += 
              '<div class="term-section">' +
              '<span class="term-section-title">ãƒ‰ãƒ¡ã‚¤ãƒ³å®šç¾©ï¼š</span>' +
              domainDef +
              '</div>';
          }

          if (note) {
            cardHtml += 
              '<div class="term-section">' +
              '<span class="term-section-title">è£œè¶³ï¼š</span>' +
              note +
              '</div>';
          }

          if (fieldsHtml) {
            cardHtml += 
              '<div class="fields-list">' +
              '<span class="term-section-title">åˆ†é‡ï¼š</span>' +
              fieldsHtml +
              '</div>';
          }

          if (linksHtml) {
            cardHtml += 
              '<div class="links-list">' +
              '<span class="term-section-title">é–¢é€£ãƒªãƒ³ã‚¯ï¼š</span>' +
              linksHtml +
              '</div>';
          }

          if (example) {
            cardHtml += 
              '<div class="example-box">' +
              'ã€ä¾‹ã€‘' + example +
              '</div>';
          }

          cardHtml += '</div>';

          card.innerHTML = cardHtml;
          area.appendChild(card);
        });
      }

      // ===== 2) keywords ã‚»ã‚¯ã‚·ãƒ§ãƒ³ =====
      if (merged.keywords) {
        const title = document.createElement("div");
        title.className = "merge-section-title";
        title.textContent = "ğŸ”‘ çµ±åˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰";
        area.appendChild(title);

        const kwBox = document.createElement("div");
        kwBox.style.marginBottom = "20px";
        
        var keywordsArray = [];
        if (Array.isArray(merged.keywords)) {
          keywordsArray = merged.keywords;
        } else if (typeof merged.keywords === 'object') {
          keywordsArray = Object.values(merged.keywords);
        }
        
        keywordsArray.forEach(function(k) {
          if (!k) return;
          const span = document.createElement("span");
          span.className = "keyword-tag";
          span.textContent = k;
          kwBox.appendChild(span);
        });

        area.appendChild(kwBox);
      }

      // ===== 3) ãã®ä»–ã®å˜ç‹¬é …ç›® =====
      Object.keys(merged).forEach(function(key) {
        if (key === "terms" || key === "keywords") return; // skip main sections

        const item = merged[key];
        if (item === null || item === undefined) return;

        const card = document.createElement("div");
        card.className = "other-entry-card";

        const itemStr = typeof item === 'object' ? JSON.stringify(item, null, 2) : String(item);

        card.innerHTML = 
          '<div class="other-entry-title">' + escapeHtml(key) + '</div>' +
          '<pre>' + escapeHtml(itemStr) + '</pre>';

        area.appendChild(card);
      });

      if (area.innerHTML === "") {
        area.innerHTML = '<div class="glossary-empty">ãƒãƒ¼ã‚¸çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
      }

      // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
      initAccordion(area);
    }

    document.getElementById("runMergeBtn").addEventListener("click", function() {
      const area = document.getElementById("mergeResultArea");
      area.innerHTML = '<div class="glossary-empty">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      Promise.all([
        GlossaryLoader.loadGlobalGlossary({ admin: true }),
        GlossaryLoader.loadDomainGlossary('psychology', { admin: true }),
        GlossaryLoader.loadProjectGlossary('default', { admin: true })
      ]).then(function(glossaries) {
        const merged = GlossaryLoader.mergeGlossaries(glossaries);
        renderMergeResult(merged);
      })
      .catch(function(error) {
        area.innerHTML = '<div class="glossary-empty" style="color: #d32f2f;">ã‚¨ãƒ©ãƒ¼: ' + escapeHtml(error.message) + '</div>';
      });
    });

    function renderPolicyInfo(policy) {
      const box = document.getElementById("policyInfo");
      const mode = escapeHtml(policy.mode || '');
      const domainsStr = (policy.domains || []).map(function(d) { return escapeHtml(d); }).join(", ");
      const policyJson = JSON.stringify(policy, null, 2);
      
      box.innerHTML = 
        '<div class="policy-card">' +
        '<div class="policy-title">ğŸ“˜ ç¾åœ¨ã® Policy è¨­å®š</div>' +
        '<div style="margin-bottom: 6px;"><strong>Modeï¼š</strong> ' + mode + '</div>' +
        '<div style="margin-bottom: 6px;"><strong>Domainsï¼š</strong> ' + (domainsStr || 'ï¼ˆãªã—ï¼‰') + '</div>' +
        '<div style="margin-top: 10px;">' +
        '<strong>Policy JSON:</strong>' +
        '<pre>' + escapeHtml(policyJson) + '</pre>' +
        '</div>' +
        '</div>';
    }

    function renderPolicyResult(result) {
      const area = document.getElementById("policyResultArea");
      area.innerHTML = "";

      if (!result || Object.keys(result).length === 0) {
        area.innerHTML = '<div class="glossary-empty">GlossaryãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
        return;
      }

      const title = document.createElement("div");
      title.className = "merge-section-title";
      title.textContent = "ğŸ“™ Policy é©ç”¨å¾Œã® Glossary";
      area.appendChild(title);

      // resultãŒtermsã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã€ç›´æ¥termsã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ç¢ºèª
      var termsObj = result.terms || result;
      
      if (!termsObj || Object.keys(termsObj).length === 0) {
        area.innerHTML = '<div class="glossary-empty">ç”¨èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
        return;
      }

        Object.values(termsObj).forEach(function(term) {
        if (!term) return;
        
        const card = document.createElement("div");
        card.className = "global-term-card accordion-card";

        const termName = escapeHtml(term.name || 'ï¼ˆåç§°ãªã—ï¼‰');
        const termId = escapeHtml(term.id || '');
        const definition = escapeHtml(term.definition || 'â€•');
        const tags = term.tags || term.fields || [];
        const domainDef = term.domain_definition ? escapeHtml(term.domain_definition) : '';
        const note = term.note ? escapeHtml(term.note) : '';
        const links = term.links || [];
        const example = term.example ? escapeHtml(term.example) : '';
        const tagsStr = tags.join(',');

        card.setAttribute("data-tags", tagsStr);

        const tagsHtml = tags.length > 0 ? 
          tags.map(function(t) { 
            return '<span class="tag">' + escapeHtml(t) + '</span>'; 
          }).join('') : '';

        const linksHtml = links.length > 0 ? 
          links.map(function(l) { 
            return '<div class="link-item"><a href="' + escapeHtml(l) + '" target="_blank" rel="noopener noreferrer">' + escapeHtml(l) + '</a></div>'; 
          }).join('') : '';

        var cardHtml = 
          '<div class="accordion-header">' +
          '<span class="global-term-name">' + termName + 
          (termId ? 'ï¼ˆ' + termId + 'ï¼‰' : '') + 
          '</span>' +
          '<span class="accordion-icon">â–¼</span>' +
          '</div>' +
          '<div class="accordion-body">' +
          '<div class="term-section">' +
          '<span class="term-section-title">å®šç¾©ï¼š</span>' +
          definition +
          '</div>';

        if (domainDef) {
          cardHtml += 
            '<div class="term-section">' +
            '<span class="term-section-title">ãƒ‰ãƒ¡ã‚¤ãƒ³å®šç¾©ï¼š</span>' +
            domainDef +
            '</div>';
        }

        if (note) {
          cardHtml += 
            '<div class="term-section">' +
            '<span class="term-section-title">è£œè¶³ï¼š</span>' +
            note +
            '</div>';
        }

        if (tagsHtml) {
          cardHtml += 
            '<div class="fields-list">' +
            '<span class="term-section-title">ã‚¿ã‚°ï¼š</span>' +
            tagsHtml +
            '</div>';
        }

        if (linksHtml) {
          cardHtml += 
            '<div class="links-list">' +
            '<span class="term-section-title">é–¢é€£ãƒªãƒ³ã‚¯ï¼š</span>' +
            linksHtml +
            '</div>';
        }

        if (example) {
          cardHtml += 
            '<div class="example-box">' +
            'ã€ä¾‹ã€‘' + example +
            '</div>';
        }

        cardHtml += '</div>';

        card.innerHTML = cardHtml;
        area.appendChild(card);
      });

      // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–
      initAccordion(area);
    }

    document.getElementById("runPolicyBtn").addEventListener("click", function() {
      const projectId = document.getElementById("projectIdInput") ? document.getElementById("projectIdInput").value : 'default';
      const mode = document.getElementById("policyMode").value;
      const domainsStr = document.getElementById("policyDomains").value;
      const domains = domainsStr ? domainsStr.split(',').map(function(s) { return s.trim(); }).filter(function(s) { return s; }) : [];
      
      const policy = {
        mode: mode,
        domains: domains
      };

      // Policy è¨­å®šè¡¨ç¤º
      renderPolicyInfo(policy);

      // Policy é©ç”¨æ¸ˆã¿ Glossaryå–å¾—
      const area = document.getElementById("policyResultArea");
      area.innerHTML = '<div class="glossary-empty">èª­ã¿è¾¼ã¿ä¸­...</div>';

      GlossaryLoader.loadGlossaryByPolicy(projectId, policy, { admin: true })
        .then(function(merged) {
          renderPolicyResult(merged);
        })
        .catch(function(error) {
          area.innerHTML = '<div class="glossary-empty" style="color: #d32f2f;">ã‚¨ãƒ©ãƒ¼: ' + escapeHtml(error.message) + '</div>';
        });
    });

    // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³æ©Ÿèƒ½ã®åˆæœŸåŒ–
    function initAccordion(container) {
      const cards = container.querySelectorAll(".accordion-card");
      cards.forEach(function(card) {
        card.addEventListener("click", function() {
          card.classList.toggle("active");
        });
      });
    }

    // ã‚¿ã‚°æ¤œç´¢æ©Ÿèƒ½
    document.getElementById("tagSearchInput").addEventListener("input", function(e) {
      const q = e.target.value.toLowerCase().trim();
      const cards = document.querySelectorAll(".accordion-card, .glossary-card, .global-term-card, .term-card");
      
      cards.forEach(function(card) {
        const tags = card.getAttribute("data-tags") || "";
        if (q === "" || tags.toLowerCase().includes(q)) {
          card.style.display = "block";
        } else {
          card.style.display = "none";
        }
      });
    });

    // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
    document.getElementById("themeSelector").addEventListener("change", function(e) {
      document.body.className = "theme-" + e.target.value;
    });

    // åˆæœŸãƒ†ãƒ¼ãƒã‚’è¨­å®š
    document.body.className = "theme-blue";

    // ãƒ‰ãƒ¡ã‚¤ãƒ³å›³å¼åŒ–æ©Ÿèƒ½
    function renderDomainMap(domainGlossary) {
      const area = document.getElementById("domainMapArea");
      if (!area) return;
      
      area.innerHTML = "<h3>ğŸ“Š ãƒ‰ãƒ¡ã‚¤ãƒ³æ§‹é€ å›³</h3>";

      const canvas = document.createElement("canvas");
      canvas.width = 600;
      canvas.height = 300;
      area.appendChild(canvas);

      const ctx = canvas.getContext("2d");

      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒ¼ãƒ‰ã¨ã—ã¦å¯è¦–åŒ–
      const keywords = domainGlossary.keywords || [];
      
      if (keywords.length === 0) {
        area.innerHTML = "";
        return;
      }

      // èƒŒæ™¯ã‚’ã‚¯ãƒªã‚¢
      ctx.fillStyle = "#fff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å††ã§å¯è¦–åŒ–
      const centerY = canvas.height / 2;
      const spacing = Math.min(120, (canvas.width - 200) / keywords.length);
      const startX = 100;

      keywords.forEach(function(k, i) {
        const x = startX + (i * spacing);
        const y = centerY;

        // å††ã‚’æç”»
        ctx.beginPath();
        ctx.arc(x, y, 35, 0, Math.PI * 2);
        ctx.fillStyle = "#eef7ff";
        ctx.fill();
        ctx.strokeStyle = "#4a90e2";
        ctx.lineWidth = 2;
        ctx.stroke();

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’æç”»
        ctx.fillStyle = "#333";
        ctx.font = "14px sans-serif";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        
        // ãƒ†ã‚­ã‚¹ãƒˆãŒé•·ã„å ´åˆã¯çŸ­ç¸®
        const displayText = k.length > 8 ? k.substring(0, 8) + "..." : k;
        ctx.fillText(displayText, x, y);
      });

      // ç”¨èªé–“ã®é–¢é€£ç·šã‚’æç”»ï¼ˆç°¡æ˜“ç‰ˆï¼‰
      if (domainGlossary.terms && Object.keys(domainGlossary.terms).length > 0) {
        const terms = Object.values(domainGlossary.terms);
        terms.forEach(function(term) {
          if (term.fields && term.fields.length > 0) {
            term.fields.forEach(function(field) {
              const keywordIndex = keywords.indexOf(field);
              if (keywordIndex >= 0) {
                const x = startX + (keywordIndex * spacing);
                const y = centerY;
                
                // é–¢é€£ç·šã‚’æç”»ï¼ˆç‚¹ç·šï¼‰
                ctx.beginPath();
                ctx.setLineDash([5, 5]);
                ctx.strokeStyle = "#ccc";
                ctx.lineWidth = 1;
                ctx.moveTo(x, y + 35);
                ctx.lineTo(x, canvas.height - 20);
                ctx.stroke();
                ctx.setLineDash([]);
              }
            });
          }
        });
      }
    }

    function testProjectGlossary() {
      var projectId = document.getElementById('projectId') ? document.getElementById('projectId').value : 
                      (document.getElementById('projectIdInput') ? document.getElementById('projectIdInput').value : 'default');
      var resultDiv = document.getElementById('projectResult');
      if (resultDiv) {
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<p>èª­ã¿è¾¼ã¿ä¸­...</p>';
      
      GlossaryLoader.loadProjectGlossary(projectId, { admin: true })
        .then(function(glossary) {
          resultDiv.innerHTML = '<h3>çµæœ:</h3><pre>' + JSON.stringify(glossary, null, 2) + '</pre>';
        })
        .catch(function(error) {
          resultDiv.innerHTML = '<p style="color:red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
        });
      }
    }

    function testDomainGlossary() {
      var domainName = document.getElementById('domainSelect') ? document.getElementById('domainSelect').value : 
                      (document.getElementById('domainName') ? document.getElementById('domainName').value : 'psychology');
      var resultDiv = document.getElementById('domainResult');
      if (resultDiv) {
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<p>èª­ã¿è¾¼ã¿ä¸­...</p>';
      
      GlossaryLoader.loadDomainGlossary(domainName, { admin: true })
        .then(function(glossary) {
          resultDiv.innerHTML = '<h3>çµæœ:</h3><pre>' + JSON.stringify(glossary, null, 2) + '</pre>';
        })
        .catch(function(error) {
          resultDiv.innerHTML = '<p style="color:red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
        });
      }
    }

    function testGlobalGlossary() {
      var resultDiv = document.getElementById('globalResult');
      if (resultDiv) {
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<p>èª­ã¿è¾¼ã¿ä¸­...</p>';
      
      GlossaryLoader.loadGlobalGlossary({ admin: true })
        .then(function(glossary) {
          resultDiv.innerHTML = '<h3>çµæœ:</h3><pre>' + JSON.stringify(glossary, null, 2) + '</pre>';
        })
        .catch(function(error) {
          resultDiv.innerHTML = '<p style="color:red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
        });
      }
    }

    function testMerge() {
      var resultDiv = document.getElementById('mergeResult');
      if (resultDiv) {
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<p>èª­ã¿è¾¼ã¿ä¸­...</p>';
      
      Promise.all([
        GlossaryLoader.loadGlobalGlossary({ admin: true }),
        GlossaryLoader.loadDomainGlossary('psychology', { admin: true }),
        GlossaryLoader.loadProjectGlossary('default', { admin: true })
      ]).then(function(glossaries) {
        var merged = GlossaryLoader.mergeGlossaries(glossaries);
        resultDiv.innerHTML = '<h3>ãƒãƒ¼ã‚¸çµæœ:</h3><pre>' + JSON.stringify(merged, null, 2) + '</pre>';
      })
      .catch(function(error) {
        resultDiv.innerHTML = '<p style="color:red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
      });
      }
    }

    function testPolicyLoad() {
      var projectId = (document.getElementById('projectId') ? document.getElementById('projectId').value : 
                      (document.getElementById('projectIdInput') ? document.getElementById('projectIdInput').value : 'default')) || 'default';
      var mode = document.getElementById('policyMode').value;
      var domainsStr = document.getElementById('policyDomains').value;
      var domains = domainsStr ? domainsStr.split(',').map(function(s) { return s.trim(); }).filter(function(s) { return s; }) : [];
      
      var policy = {
        mode: mode,
        domains: domains
      };
      
      var resultDiv = document.getElementById('policyResult');
      if (resultDiv) {
      resultDiv.style.display = 'block';
      resultDiv.innerHTML = '<p>èª­ã¿è¾¼ã¿ä¸­...</p>';
      
      GlossaryLoader.loadGlossaryByPolicy(projectId, policy, { admin: true })
        .then(function(glossary) {
          resultDiv.innerHTML = '<h3>Policy: ' + JSON.stringify(policy, null, 2) + '</h3>' +
            '<h3>çµ±åˆçµæœ:</h3><pre>' + JSON.stringify(glossary, null, 2) + '</pre>';
        })
        .catch(function(error) {
          resultDiv.innerHTML = '<p style="color:red;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p>';
        });
    }
    }

    // =========================
    // Glossary ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿å‡¦ç†
    // =========================
    window.addEventListener('DOMContentLoaded', function() {
      const loadTemplateBtn = document.getElementById('loadGlossaryTemplateBtn');
      if (!loadTemplateBtn) {
        console.warn('loadGlossaryTemplateBtn not found');
        return;
      }

      loadTemplateBtn.addEventListener('click', function() {
        const selected = document.getElementById('glossaryTemplateSelect').value;

        if (!selected) {
          alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        const glossary = GLOSSARY_TEMPLATES[selected];

        if (!glossary) {
          alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
          return;
        }

        // ===========================
        // â‘  window.currentGlossary ã«è¨­å®šï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ã§ç›´æ¥ä½¿ç”¨ï¼‰
        // å¸¸ã« { terms: {...} } ã®å½¢å¼ã§ä¿æŒ
        // ===========================
        const glossaryData = { terms: glossary.terms || glossary };
        
        // window.currentGlossary ã«è¨­å®šï¼ˆã‚¨ãƒ‡ã‚£ã‚¿ã§ç›´æ¥ä½¿ç”¨ï¼‰
        window.currentGlossary = glossaryData;
        console.log('[Glossary] window.currentGlossary ã‚’è¨­å®šã—ã¾ã—ãŸ:', glossaryData);
        
        // localStorage ã«ä¿å­˜ï¼ˆæ°¸ç¶šåŒ–ï¼‰
        try {
          localStorage.setItem('currentGlossary', JSON.stringify(glossaryData));
          console.log('[Glossary] localStorage ã«ä¿å­˜ã—ã¾ã—ãŸ');
        } catch (e) {
          console.warn('[Glossary] localStorage ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
        }
        
        // ã‚¨ãƒ‡ã‚£ã‚¿ã®ãƒ™ã‚¯ãƒˆãƒ«è¨­å®šUIã‚’æ›´æ–°ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        if (typeof window.refreshVectorAxis === 'function') {
          window.refreshVectorAxis();
          console.log('[Glossary] ãƒ™ã‚¯ãƒˆãƒ«è¨­å®šUIã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        }

        // ===========================
        // â‘¡ Glossary Loader ã®ã‚«ãƒ¼ãƒ‰ã«è¡¨ç¤ºï¼ˆresultAreaï¼‰
        // ===========================
        // Glossaryã‚«ãƒ¼ãƒ‰ã‚’å¿…ãšè¡¨ç¤º
        const termsToDisplay = glossary.terms || glossary;
        if (typeof renderGlossaryCards === 'function') {
          renderGlossaryCards(termsToDisplay);
        } else {
          console.warn('renderGlossaryCards function not found');
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥resultAreaã«è¡¨ç¤º
          const resultArea = document.getElementById('resultArea');
          if (resultArea) {
            resultArea.innerHTML = '';
            Object.values(termsToDisplay).forEach(function(term) {
              const div = document.createElement('div');
              div.className = 'glossary-card';
              div.innerHTML = 
                '<div class="glossary-term">' + escapeHtml(term.name) + 
                '<span class="glossary-term-id">(' + escapeHtml(term.id) + ')</span></div>' +
                '<div class="glossary-definition">' + escapeHtml(term.definition) + '</div>' +
                (term.example ? '<div class="example-box">ã€ä¾‹ã€‘' + escapeHtml(term.example) + '</div>' : '');
              resultArea.appendChild(div);
            });
          }
        }

        // ===========================
        // â‘¢ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã«ã‚‚è¡¨ç¤ºï¼ˆtemplatePreviewAreaï¼‰
        // ===========================
        const previewArea = document.getElementById('templatePreviewArea');
        if (previewArea) {
          const templateName = selected === 'thinking_skills' ? 'æ€è€ƒã‚¹ã‚­ãƒ«' : 
                               selected === 'psychology' ? 'æ•™è‚²å¿ƒç†' : 
                               'AIæ™‚ä»£ã®å­¦åŠ›';
          
          previewArea.innerHTML = '<div style="padding: 10px; background: #e6f3ff; border-radius: 8px; margin-bottom: 10px;"><strong>âœ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ' + 
            escapeHtml(templateName) + 'ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ</strong></div>';
          
          // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç”¨èªã‚’ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
          const termsForPreview = glossary.terms || glossary;
          if (termsForPreview && Object.keys(termsForPreview).length > 0) {
            const termsHtml = Object.values(termsForPreview).map(function(term) {
              return '<div class="glossary-card" style="margin-bottom: 10px;">' +
                '<div class="glossary-term">' + escapeHtml(term.name) + 
                '<span class="glossary-term-id">(' + escapeHtml(term.id) + ')</span></div>' +
                '<div class="glossary-definition">' + escapeHtml(term.definition) + '</div>' +
                (term.example ? '<div class="example-box">ã€ä¾‹ã€‘' + escapeHtml(term.example) + '</div>' : '') +
                '</div>';
            }).join('');
            previewArea.innerHTML += termsHtml;
          }
        }

        // ===========================
        // â‘£ ãƒ™ã‚¯ãƒˆãƒ«è¨­å®šUIã®æ›´æ–°ã¯ä¸Šè¨˜ã§ refreshVectorAxis ã‚’å‘¼ã³å‡ºã—ã¦å®Ÿè¡Œ
        // ===========================

        alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼\nã‚¨ãƒ‡ã‚£ã‚¿ã®ãƒ™ã‚¯ãƒˆãƒ«è¨­å®šUIã§ä½¿ç”¨ã§ãã¾ã™ã€‚');
      });
    });
  </script>
</body>
</html>

