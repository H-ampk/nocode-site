# 2025-11-20 生徒ログ記録システム（Student Logging System）の完全統合

## 概要
Player で取得できるすべての学習行動データを `students/{id}.json` に保存する仕組みを完全統合しました。vector（評価軸）を選択肢から自動コピーしてログへ埋め込み、`quiz_log_dummy.json` と互換性のある形式でログ生成を行います。複数セッションにも対応し、`students/index.json` を自動生成・更新する仕組みも実装しました。analysis.js が生徒ログを読み込み、ベクトル分析・反応時間・迷いパターン等にアクセスできるようにしました。

## 変更ファイル

### src/player/logging.js
- **完全な StudentLogManager を実装**
  - `init(userId)`: ユーザーID、セッションID、作成日時を初期化
  - `record(event)`: 学習行動イベントを記録（questionId, final_answer, correct, response_time, path, vector, glossaryShown, conceptTags）
  - `exportLog()`: `quiz_log_dummy.json` と互換性のある形式でログをエクスポート
    - 形式: `{ user_id, generated_at, session_id, logs: [...] }`
  - `saveToLocalStorage()`: ローカルストレージに保存（analysis ダッシュボードで参照可能）
  - `download()`: JSONファイルとしてダウンロード

### src/player/player.js
- **StudentLogManager との統合**
  - `loadQuiz()` 内で `StudentLogManager.init()` を呼び出し、クイズ開始時にロギングマネージャーを初期化
  - `confirmAnswer()` 内で以下を実装:
    - 選択肢の `vector` を自動コピーしてログに埋め込み
    - `StudentLogManager.record()` でログ記録
      - `questionId`, `final_answer`, `correct`, `response_time`, `path`, `vector`, `glossaryShown`, `conceptTags` を記録
  - `showResult()` 内で:
    - `StudentLogManager.saveToLocalStorage()` でローカルストレージに保存
    - `StudentLogManager.download()` でJSONファイルをダウンロード
  - `shownGlossaryTerms` 変数を追加し、Glossary表示履歴を記録

### students/generate_index.js
- **Node.js版に完全置き換え**
  - ブラウザ版からNode.js版に変更
  - `fs.readdirSync()` で `students/` フォルダ内の JSON ファイルをスキャン
  - `index.json` を自動生成:
    - 形式: `{ students: [{ id, session_id, file, last_update }, ...] }`
    - `user_id` または `dataset_name` から `id` を抽出
    - `generated_at` または `created_at` から `last_update` を抽出

### src/admin/dataset_loader.js
- **studentLogs 読み込み機能を追加**
  - `loadStudentLog(userId, sessionId)`: 生徒ログファイルを読み込む関数を追加
    - ファイル名形式: `{userId}_{sessionId}.json`
    - ファイルが存在しない場合は `null` を返す
  - `loadDataset(dataset, config)`: `config` パラメータを追加
    - `config.student_id` と `config.session_id` が提供されている場合、`student_log` を読み込んで結果に含める
    - 戻り値に `student_log` フィールドを追加
  - `loadStudentLog` をグローバルに公開

### src/admin/analysis.js
- **ベクトル分析の完全統合**
  - `computeVectorStats(logs)`: ベクトル平均計算関数を追加
    - ログ配列から `vector` フィールドを集計
    - 軸ごとの平均値を計算して返す
  - `computeVectorStats` をグローバルに公開
  - 既存の `renderVectorAnalysis()` 関数と統合

### admin/analysis.html
- **vector_math.js の読み込みを追加**
  - `<script type="module">` で `vector_math.js` を読み込み
  - `cosineSimilarity` 関数をグローバルに公開
  - 既存のベクトル分析UI（`vector-analysis` セクション）は維持

### src/utils/vector_math.js（新規作成）
- **ベクトル計算ユーティリティ関数**
  - `cosineSimilarity(a, b)`: コサイン類似度を計算
    - ベクトルの長さが異なる場合の処理を実装
    - 0-1の範囲で値を返す
    - エラーハンドリングを実装

## 実装の詳細

### ログ形式の互換性
- `quiz_log_dummy.json` と完全互換の形式:
  ```json
  {
    "user_id": "student",
    "generated_at": "2025-11-20T...",
    "session_id": "session_...",
    "logs": [
      {
        "session_id": "session_...",
        "timestamp": "2025-11-20T...",
        "questionId": "q001",
        "final_answer": "c1",
        "correct": true,
        "response_time": 5.2,
        "path": ["c1", "c2", "c1"],
        "vector": { "理解度": 0.8, "転移可能性": 0.6 },
        "glossaryShown": ["term1", "term2"],
        "conceptTags": ["認知負荷", "メタ認知"]
      }
    ]
  }
  ```

### 複数セッション対応
- 各セッションごとに `session_id` を生成（`session_${Date.now()}`）
- `generated_at` でセッションの作成日時を記録
- `students/index.json` でセッション情報を管理

### 自動インデックス生成
- `students/generate_index.js` を実行すると、`students/` フォルダ内のすべての JSON ファイルをスキャン
- `index.json` を自動生成・更新
- 各生徒ログファイルの `user_id`, `session_id`, `generated_at` を抽出

### analysis との連携
- `dataset_loader.js` の `loadDataset()` で `student_log` を読み込み可能
- `analysis.js` の `computeVectorStats()` でベクトル分析が可能
- `renderVectorAnalysis()` で理想ベクトルとの一致度を表示

## 使用方法

### Player でのログ記録
1. Player でクイズを開始すると、自動的に `StudentLogManager` が初期化される
2. 各問題に回答すると、ログが自動的に記録される
3. クイズ終了時に、ローカルストレージに保存され、JSONファイルがダウンロードされる

### index.json の生成
```bash
node students/generate_index.js
```

### analysis での分析
1. `admin/analysis.html` でデータセットを選択
2. ベクトル分析タブで理想ベクトルとの一致度を確認
3. その他の分析タブで反応時間・迷いパターン等を確認

## 本番レベルの実装（追加改善）

### src/player/demo.html
- **生徒ID入力UIを追加**
  - クイズ開始前に生徒IDを入力するUIを追加
  - ローカルストレージに最後に入力したIDを保存し、次回自動入力
  - ID入力後にクイズアプリを表示

### src/player/logging.js（完全版に更新）
- **複数セッション対応の完全実装**
  - `sessions` 配列で複数セッションを管理
  - `startSession()`: 新しいセッションを開始
  - `pushSession()`: 現在のセッションを `sessions` 配列に追加
  - `export()`: multi-session 構造でエクスポート
    - 形式: `{ user_id, sessions: [{ session_id, generated_at, logs: [...] }] }`
  - `saveToLocal()`: localStorage に保存（キー: `student_{userId}`）
  - `download()`: JSONファイルとしてダウンロード（ファイル名: `{userId}_sessions.json`）
- **エラー処理の追加**
  - すべての主要メソッドに try-catch を追加
  - エラー発生時もアプリケーションが停止しないように実装

### src/player/player.js（完全統合）
- **ログ記録処理の完全統合**
  - `loadQuiz()` 内で `StudentLogManager.init()` と `startSession()` を呼び出し
  - `confirmAnswer()` 内で以下を完全実装:
    - 選択肢の `vector` を自動コピー
    - `path`（選択肢遷移パターン）を記録
    - `glossaryShown`（表示されたGlossary用語）を記録
    - `conceptTags`（概念タグ）を記録
    - `response_time`（反応時間）を記録
  - `showResult()` 内で:
    - `pushSession()` でセッションを保存
    - `saveToLocal()` でローカルストレージに保存
    - `download()` でJSONファイルをダウンロード

### src/admin/dataset_loader.js（multi-session 対応）
- **localStorage からの multi-session 読み込み**
  - `loadStudentLogForId(studentId)`: localStorage から multi-session 構造を読み込む関数を追加
    - キー形式: `student_{studentId}`
    - エラーハンドリングを実装（`no_data`, `parse_error` を返す）
  - `loadDataset(dataset, config)`: `config.student_id` が提供されている場合、`student_log` を読み込んで結果に含める
  - `loadStudentLogForId` をグローバルに公開

### src/admin/analysis.js（全セッション合算機能）
- **全セッション合算機能を追加**
  - `mergeAllSessions(studentData)`: 複数セッションのログを1つの配列に統合
    - `studentData.sessions` 配列からすべての `logs` を結合
    - 戻り値: 合算されたログの配列
  - `mergeAllSessions` をグローバルに公開

### admin/analysis.html（セッション選択UI）
- **セッション選択UIを追加**
  - セッション選択セクションを追加（`session-selector`）
  - セレクトボックスで個別セッションを選択可能
  - 「表示」ボタン: 選択したセッションのログのみを分析
  - 「全セッション合算」ボタン: すべてのセッションを合算して分析
  - `renderSessionSelector(studentData)`: セッション一覧を表示する関数を追加
  - `loadAndAnalyze()` を拡張し、multi-session 構造のデータを自動検出して処理

### scripts/merge_student_logs.js（新規作成）
- **ログマージスクリプト（CLI）**
  - 複数の生徒ログファイルを1つに統合するNode.jsスクリプト
  - 使用方法: `node scripts/merge_student_logs.js file1.json file2.json ...`
  - 対応形式:
    - multi-session 構造: `{ user_id, sessions: [...] }`
    - 単一セッション構造: `{ user_id, session_id, generated_at, logs: [...] }`
    - 配列形式: `[...]`
  - 出力: `merged_student_log.json`
  - エラーハンドリング: 存在しないファイルやパースエラーをスキップして処理を継続

## 実装の詳細（本番レベル）

### Multi-Session 構造
- 1人の生徒が複数回クイズを受講しても、すべてのセッションを管理:
  ```json
  {
    "user_id": "student001",
    "sessions": [
      {
        "session_id": "session_1734681234567",
        "generated_at": "2025-11-20T10:00:00.000Z",
        "logs": [...]
      },
      {
        "session_id": "session_1734687890123",
        "generated_at": "2025-11-20T14:30:00.000Z",
        "logs": [...]
      }
    ]
  }
  ```

### エラー処理
- すべての主要操作に try-catch を実装
- localStorage の容量制限やパースエラーに対応
- エラー発生時もアプリケーションが継続動作するように設計

### セッション管理
- クイズ開始時に `startSession()` でセッションを開始
- クイズ終了時に `pushSession()` でセッションを保存
- 複数セッションを1つのファイルに統合して管理

### ログマージ機能
- 複数のログファイルを統合して分析可能に
- 異なる形式のログファイルにも対応
- セッションIDの重複を避けるため、自動生成機能を実装

## 使用方法（本番レベル）

### Player でのログ記録（本番版）
1. `src/player/demo.html` を開く
2. 生徒IDを入力して「開始」ボタンをクリック
3. クイズを回答すると、自動的にログが記録される
4. クイズ終了時に、ローカルストレージに保存され、JSONファイルがダウンロードされる
5. 複数回クイズを受講すると、すべてのセッションが統合される

### ログファイルのマージ
```bash
node scripts/merge_student_logs.js student001_sessions.json student002_sessions.json
# 出力: merged_student_log.json
```

### analysis でのセッション分析
1. `admin/analysis.html` でデータセットを選択
2. セッション選択UIが表示される（multi-session 構造の場合）
3. 個別セッションを選択して「表示」ボタンをクリック
4. または「全セッション合算」ボタンで全セッションを統合して分析
5. ベクトル分析・反応時間・迷いパターン等を確認

## 今後の拡張可能性
- サーバー側でのログ保存機能
- リアルタイムでのログ分析
- 複数生徒の比較分析機能
- ベクトル分析の詳細可視化
- セッション間の学習進捗比較機能

## ダミーログ生成・検証スクリプトの改善（追加改善）

### scripts/generate_dummy_logs.py
- **未使用引数の削除**
  - `generatePath()` から `responseTime` 引数を削除
  - `generateLog()` から `index` 引数を削除
- **`generateClicks` 関数の改善**
  - 空の `path` チェックを追加
  - `response_time` が0以下の場合の処理を追加（最小値0.1に設定）
  - 負の値や累積時間のオーバーフローを防止
  - ロジックを簡素化し、より安全な時間計算を実装
- **既存データの保持機能**
  - `vector_test_sessions` を保持（既存のベクトルテストデータを上書きしない）
  - 既存の `dataset_name`, `type`, `created_at` を保持
- **エラーハンドリングの改善**
  - ファイル読み込みエラーの詳細表示
  - JSON解析エラーの詳細表示
  - ファイル書き込みエラーの処理

### scripts/generate_vector_sessions.py
- **未使用引数の削除**
  - `generatePath()` から `responseTime` 引数を削除
- **エラーハンドリングの追加**
  - ファイルが見つからない場合の処理（新規作成）
  - JSON解析エラーの処理（エラーメッセージ表示）
  - ファイル書き込みエラーの処理
  - 既存データの保持（`logs` を保持）

### scripts/verify_dummy_logs.py
- **エラーハンドリングの追加**
  - ファイルが見つからない場合の処理
  - JSON解析エラーの処理
  - `logs` が空の場合の処理
- **データ整合性チェックの改善**
  - `path` と `clicks` の存在確認
  - 空の配列のチェック
  - `choiceId` の存在確認
  - 最後のクリック時間と `response_time` の整合性チェック
- **`vector_test_sessions` の検証機能**
  - セッション数、総ログ数の表示
  - ベクトル値の型チェック（int/float）
  - ベクトル値の範囲チェック（-1, 0, 1 のみ許可）
  - エラーメッセージの改善（セッションIDとログインデックスを含む）

### scripts/generate_dummy_logs.js（JavaScript版）
- **Python版と同等の改善を適用**
  - 未使用引数の削除（`generatePath()`, `generateLog()`）
  - `generateClicks` 関数の改善（空のpathチェック、response_timeが0以下の処理）
  - 既存データの保持（`vector_test_sessions` を保持）
  - エラーハンドリングの改善（ファイル読み込み・書き込みエラー）

### scripts/generate_vector_sessions.js（JavaScript版）
- **Python版と同等の改善を適用**
  - 未使用引数の削除（`generatePath()`）
  - エラーハンドリングの追加（ファイルが見つからない場合、JSON解析エラー、ファイル書き込みエラー）
  - 既存データの保持（`logs` を保持）

### scripts/merge_student_logs.js（JavaScript版）
- **エラーハンドリングの改善**
  - マージ結果が空の場合の処理
  - ファイル書き込みエラーの処理
  - エラー時の適切な終了コード

## 改善の詳細（ダミーログ生成・検証スクリプト）

### エラーハンドリングの強化
- すべてのファイル操作に try-catch を実装
- エラーメッセージを詳細化（ファイルパス、エラー内容を含む）
- エラー発生時も処理を継続できるように設計

### データ整合性の向上
- `generateClicks` 関数で負の値やオーバーフローを防止
- `verify_dummy_logs.py` で包括的なデータ検証を実装
- ベクトル値の型と範囲を厳密にチェック

### 既存データの保護
- 既存の `vector_test_sessions` を上書きしない
- 既存の `logs` を保持
- メタデータ（`dataset_name`, `type`, `created_at`）を保持

### コード品質の向上
- 未使用引数を削除してコードを簡潔に
- ロジックを改善してより安全な処理を実装
- Python版とJavaScript版の機能を統一

## プロジェクト単位での quiz.json 保存機能の追加（追加改善）

### src/editor/editor.html
- **保存ボタンの追加**
  - 「💾 quiz.json を保存」ボタンを追加（「プロジェクトを保存」の下）
  - ボタンのスタイルを追加

### editor.js
- **`saveQuiz()` 関数の実装**
  - `localStorage` または `project.json` から `project_id` を取得
  - `buildQuizDataFromEditor()` で `gameData` から `quiz.json` 形式を構築
  - `GlossaryLoader.getCurrentGlossaryForQuiz()` で現在のGlossaryを取得して統合
  - `downloadJSON()` で `quiz.json` としてダウンロード
- **`buildQuizDataFromEditor()` 関数の追加**
  - `gameData` を `quiz.json` 形式に変換
  - `questions` と `results` を適切な形式に変換
  - `vector` 情報を保持
- **`downloadJSON()` ヘルパー関数の追加**
  - JSONデータをダウンロード

### src/core/GlossaryLoader.js
- **`getCurrentGlossaryForQuiz()` 関数の追加**
  - `window.currentGlossary` からGlossaryを取得
  - フォールバックとして `localStorage` から取得
  - `GlossaryLoader` オブジェクトに公開

### admin/project_manager.html
- **Project ID設定UIの追加**
  - Project ID入力欄と保存ボタン
  - `localStorage` に保存
  - `project.json` を生成してダウンロード
  - 現在のProject IDを自動表示

## クイズ保存方式のバージョン管理システムへのアップグレード（追加改善）

### src/editor/editor.html
- **ボタンテキストの変更**
  - 「💾 quiz.json を保存」から「💾 バージョン保存」に変更

### editor.js
- **`saveQuiz()` 関数のバージョン管理方式への改修**
  - 日付（YYYYMMDD-HHmm）と設計者名からバージョンファイル名を生成
  - バージョンファイル名形式: `{YYYYMMDDHHmm}-{author}-quiz.json`
  - `latest.json` を自動更新（常に最新のバージョンに更新）
  - バックアップファイルを自動生成（`backup_{YYYYMMDDHHmm}-{author}-quiz.json`）
  - バージョン情報（`version`, `version_date`, `author`, `project_id`）を quiz.json に追加
- **`downloadJSON()` 関数の改善**
  - バックアップファイル名の処理を追加（`backup_` プレフィックスを自動付与）

### admin/project_manager.html
- **設計者名設定UIの追加**
  - 設計者名入力欄と保存ボタン
  - `localStorage` に保存（キー: `quiz_author`）
  - 保存された設計者名を自動表示
  - バージョンファイル名に設計者名が含まれることを説明

### src/player/player.js
- **`getCurrentQuizVersion()` 関数の追加**
  - `latest.json` からクイズバージョンを取得
  - プロジェクトIDに基づいて適切なパスから読み込み
  - エラーハンドリングを実装
- **`StudentLogManager.record()` への `quiz_version` 追加**
  - 非同期でバージョンを取得してログに記録
  - バージョン取得に失敗した場合は "unknown" を記録

### src/admin/analysis.js
- **`getQuizVersionsFromLogs()` 関数の追加**
  - ログから quiz_version の一覧を取得（重複なし）
  - ソート済みの配列を返す
- **`filterLogsByVersion()` 関数の追加**
  - ログを quiz_version でフィルタリング
  - `null` または `'all'` の場合は全件を返す
- **グローバルに公開**
  - `AnalysisDashboard` オブジェクトに追加

### admin/admin.html
- **バージョン一覧UIの追加**
  - `latest.json` の情報を表示（バージョン、作成日時、作成者）
  - ローカルストレージからバージョン履歴を表示（あれば）
  - プロジェクトIDを表示
  - ページ読み込み時に自動的にバージョン一覧を読み込む

### src/core/GlossaryLoader.js
- **`loadLatestQuizVectors()` 関数の追加**
  - `latest.json` から `glossary_vector` を読み込む
  - プロジェクトIDに基づいて適切なパスから読み込み
  - エラーハンドリングを実装（ファイルが存在しない場合は空オブジェクトを返す）
  - `GlossaryLoader` オブジェクトに公開

## バージョン管理システムの仕様

### ファイル命名規則
- **バージョンファイル**: `{YYYYMMDDHHmm}-{author}-quiz.json`
  - 例: `20251120-1200-ray-quiz.json`
- **最新版**: `latest.json`（常に最新のバージョンに更新）
- **バックアップ**: `backup_{YYYYMMDDHHmm}-{author}-quiz.json`

### 保存先
- `projects/{projectId}/quiz_versions/` に保存
- `backup/` フォルダにも自動保存（手動で配置）

### ログとの紐付け
- 生徒ログに `quiz_version` フィールドを追加
- 分析時にバージョンでフィルタリング可能
- バージョンごとの学習データを比較分析可能

### 使用方法

#### 設計者名の設定（初回のみ）
1. `admin/project_manager.html` を開く
2. 「設計者名設定」セクションで設計者名を入力
3. 「保存」ボタンをクリック

#### バージョン保存
1. `src/editor/editor.html` を開く
2. 質問や選択肢を作成・編集
3. 「💾 バージョン保存」ボタンをクリック
4. バージョンファイル、`latest.json`、バックアップファイルがダウンロードされる
5. `projects/{projectId}/quiz_versions/` に配置

#### バージョン管理
1. `admin/admin.html` でバージョン一覧を確認
2. `latest.json` の情報（バージョン、作成日時、作成者）を表示
3. 分析時にバージョンでフィルタリング可能

### 特徴
- **既存構造との互換性**: `gameData` 構造を維持し、既存機能と衝突しない
- **Glossary統合**: 現在のGlossaryを自動的に `glossary_vector` として統合
- **プロジェクト単位管理**: `project_id` に基づいて保存先を決定
- **バージョン履歴管理**: すべてのバージョンを保持し、過去のバージョンにアクセス可能
- **自動バックアップ**: バージョン保存時に自動的にバックアップを生成
- **エラーハンドリング**: エラー発生時に適切なメッセージを表示

## dataset_loader.js のパス不整合修正と analysis UI の null 参照エラー修正（追加改善）

### src/admin/dataset_loader.js
- **パス生成の安全性向上**
  - `folderPart` が `undefined` になる問題を修正
  - `config.dataset_folder` を優先的に使用し、なければ `dataset.folder` を使用
  - 末尾スラッシュを正規化（`replace(/\/?$/, '/')`）してパス切れを防止
  - デバッグ用の `console.log` を追加（読み込みパスを表示）
  - 修正により、`quiz_log_dummy.json` が `../students/undefinedquiz_log_dummy.json` ではなく、正しく `../students/quiz_log_dummy.json` として読み込まれるように改善

### src/admin/analysis.js
- **null 参照エラーの防止**
  - `document.getElementById('analysis-banner')` に null チェックを追加
  - エラー発生時もアプリケーションが停止しないように改善

### admin/analysis.html
- **すべての `getElementById` に null チェックを追加**
  - `loadAndAnalyze()` 関数内:
    - `dataset-error` の null チェック
    - `dataset-info` の null チェック
    - `dashboard` の null チェック（2箇所）
    - 存在しない `clusterSection` ID の参照を削除
  - `createNewDatasetFile()` 関数内:
    - `new-dataset-name` と `new-dataset-type` の null チェック
  - `regenerateIndex()` 関数内:
    - `dataset-info` と `dataset-error` の null チェック
  - `loadDatasetList()` 関数内:
    - `dataset-list` の null チェック
  - `renderSessionSelector()` 関数内:
    - `session-selector` と `session-select` の null チェック
  - イベントリスナー:
    - `view-session` ボタンの null チェック
    - `view-all-sessions` ボタンの null チェック
    - `diffResult` の null チェック（2箇所）
    - `improveChart` の null チェック

## 改善の詳細（パス不整合と null 参照エラー修正）

### パス生成の安全性
- `config.dataset_folder` と `dataset.folder` の両方に対応
- `undefined` との文字列結合を防止
- パス末尾のスラッシュを正規化して一貫性を確保
- デバッグログで実際の読み込みパスを確認可能

### null 参照エラーの防止
- すべての DOM 要素参照に null チェックを実装
- 要素が存在しない場合でも処理を継続
- エラーメッセージを適切に表示
- UI の安定性を大幅に向上

### エラーハンドリングの改善
- 存在しない要素へのアクセスを防止
- エラー発生時もページ全体が停止しない
- ユーザー体験の向上

## クラスタリング分析機能の追加（追加改善）

### scripts/generate_cluster_dummy.js（新規作成）
- **クラスタリング分析用ダミーデータ生成スクリプト**
  - 20〜30セッションのランダムダミーデータを生成
  - 各セッションに以下のフィールドを含む:
    - `user_id`, `session_id`: セッション識別子
    - `timestamp_start`, `timestamp_end`: セッションの開始/終了時刻
    - `answer_logs[]`: 問題回答ログ（question_id, choice_id, correct, reaction_time, path）
    - `vector_summary`: ベクトルサマリー（logic, analysis, creativity, comprehension, application、各-3〜+3の整数）
    - `cluster_features`: クラスタ特徴量（[0,1]の連続値ベクトル）
    - `cluster_ground_truth`: テスト用クラスタラベル（1, 2, 3）
  - クラスタごとの特徴を設定:
    - クラスタ1（素早い判断）: 高正答率(80%)、短い反応時間(1-5秒)
    - クラスタ2（探索的）: 中正答率(60%)、中程度の反応時間(5-15秒)
    - クラスタ3（慎重）: 低正答率(40%)、長い反応時間(15-30秒)
  - 出力: `students/cluster_dummy.json`
  - `students/index.json` に自動登録

### projects/vector_test/quiz.json（新規作成）
- **ベクトル分析テスト用クイズ**
  - 5問の診断問題（`diagnostic_question` タイプ）
  - 各選択肢に `vector` を設定（logic, analysis, creativity, comprehension, application）
  - ベクトル値: -1, 0, +1 の範囲で設定
  - `id`: `vector_test_questions`
  - `glossary_vector`: 空オブジェクト

### projects/vector_test/project.json（新規作成）
- **ベクトル分析テスト用プロジェクト設定**
  - `project_id`: `vector_test`
  - `values`: 理想ベクトル（すべての軸を1に設定）
  - `access_mode`: `public`

### projects/vector_test/glossary.json（新規作成）
- **空のGlossaryファイル**
  - `terms`: 空配列

### admin/analysis.html
- **クラスタ分析セクション（フロントエンド）を追加**
  - `clusterAnalysisFrontendSection` セクションを追加
  - `<canvas id="clusterScatter">`: 散布図表示用
  - `<div id="clusterTable">`: クラスタ一覧テーブル
  - `<pre id="clusterDebug">`: デバッグ情報表示

### src/admin/analysis.js
- **クラスタリング分析機能を追加**
  - `renderClusterAnalysis(datasetData)`: クラスタリング分析をレンダリング
    - `cluster_features` を抽出（`sessions` または `student_log.sessions` から）
    - Julia出力（`julia_output`）があれば優先使用
    - なければフロントエンドで簡易 k-means を実行
  - `simpleKMeans(features, k)`: フロントエンドで k-means クラスタリングを実行
  - `renderClusterScatter(features, labels, sessionInfo)`: Chart.js を使用して散布図を描画
  - `renderClusterTable(labels, sessionInfo)`: クラスタID、ユーザーID、セッションID、サマリーを表示
  - `loadAndAnalyze()` 関数内でデータセット読み込み後に `renderClusterAnalysis()` を自動呼び出し

### admin/analysis.html（クイズバージョン差分表示UI）
- **クイズバージョン一覧セクションを上部に追加**
  - プロジェクト選択ドロップダウン（`versionProjectSelect`）
  - バージョン選択ドロップダウン（`quizVersionList`）
  - 差分表示ボタン（`loadVersionDiffBtn`）
  - 差分表示コンテナ（`diffContainer`）
  - `loadQuizVersionList()`: バージョン一覧を読み込む関数
  - プロジェクト選択変更時にバージョン一覧を再読み込み
  - 差分表示ボタンで選択されたバージョンと `latest.json` を比較

### src/admin/dataset_loader.js
- **`listQuizVersions(projectId)` 関数を追加**
  - プロジェクトフォルダからクイズバージョン一覧を取得
  - `latest.json` と localStorage の履歴からバージョンを収集
  - バージョンファイル名の配列を返す

### src/admin/analysis.js（JSON diff algorithm）
- **`computeJSONDiff(oldObj, newObj, path)` 関数を追加**
  - 再帰的にJSON diffを計算
  - プリミティブ、配列、オブジェクトに対応
  - 各差分に `type`（`add`, `delete`, `change`）を付与
- **`renderJSONDiff(diff, containerId)` 関数を追加**
  - diffをHTMLテーブルで描画
  - 色分け表示:
    - 追加: 緑（`#c2f7c2`）
    - 削除: 赤（`#f7c2c2`）
    - 変更: 黄（`#fff8b3`）
  - パス、タイプ、旧値、新値を表示

### analysis/clustering.jl（新規作成）
- **Juliaクラスタリング分析スクリプト**
  - `JSON3`, `DataFrames`, `Clustering`, `Statistics` を使用
  - 入力: `students/cluster_dummy.json`
  - `sessions` 配列から `cluster_features` を抽出
  - k-means クラスタリング（k=3）を実行
  - 各セッションのクラスタ割り当てと距離を計算
  - 出力: `analysis/cluster_output.json`
  - 出力形式:
    ```json
    {
      "total_sessions": 25,
      "k": 3,
      "feature_dimension": 8,
      "results": [
        {
          "session_id": "session_...",
          "assigned_cluster": 1,
          "distance": 0.23
        }
      ]
    }
    ```

## 改善の詳細（クラスタリング分析機能）

### クラスタリング分析のワークフロー
1. **データ生成**: `generate_cluster_dummy.js` でテストデータを生成
2. **Julia分析**: `clustering.jl` で k-means クラスタリングを実行
3. **フロントエンド可視化**: `analysis.html` で結果を散布図とテーブルで表示
4. **Julia出力優先**: Julia出力があれば優先使用、なければフロントエンドで簡易 k-means を実行

### JSON diff algorithm
- 再帰的な構造比較を実装
- 配列の追加・削除・変更を検出
- オブジェクトのネストされた構造に対応
- 視覚的な色分けで差分を明確に表示

### ベクトル分析テスト環境
- `vector_test` プロジェクトでベクトル分析をテスト可能
- 各選択肢にベクトル値を設定して分析の精度を検証
- 理想ベクトルとの比較が可能

