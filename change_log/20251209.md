# 改変履歴 - 2025年12月9日

## 📝 概要
editor.htmlをproject_idなしで開いた場合でも正常に動作する「Zero-Project Mode」を実装しました。また、初期化の二重発火を防ぐガードを追加しました。

---

## 🌐 Zero-Project Mode の実装

### 背景
従来、editor.htmlを開く際にはURLパラメータで`project_id`を指定する必要がありました。これがない場合、コンソールエラーが発生し、エディタが正常に動作しない問題がありました。

### 実装内容

#### 1. 自動プロジェクト生成機能（`src/editor/editor_main.js`）
- URLパラメータに`project_id`が指定されていない場合、自動的にタイムスタンプ付きの`temp_project_{timestamp}`を生成
- localStorageに初期データを保存（`project_id`と`project_{projectId}`の両方）
- Zero-Project Modeとして起動し、新規プロジェクトとして編集可能

```javascript
// Zero-Project Mode -------------------------
if (!projectId) {
    const timestamp = new Date().toISOString().replace(/[-:T.]/g,"").slice(0,14);
    projectId = `temp_project_${timestamp}`;
    console.warn(`[Editor] project_id がないため Zero-Project Mode で新規作成: ${projectId}`);

    // 新規プロジェクトを初期化
    window.localStorage.setItem("project_id", projectId);
    window.localStorage.setItem(`project_${projectId}`, JSON.stringify({
        title: "新規プロジェクト",
        questions: [],
        glossary: {},
        results: [],
        created_at: timestamp
    }));
}
```

#### 2. プロジェクト読み込みの改善（`src/editor/editor_init.js`）
- `loadGameData`関数にZero-Project Mode対応を追加
  - `temp_project_`で始まるIDの場合はファイル読み込みをスキップ
  - localStorageから直接読み込む（存在しない場合は新規作成）
- `project.json`が見つからない場合のfallback処理を改善
  - localStorageからの取得を優先的に試行

```javascript
// Zero-Project Mode: temp_project_で始まるIDの場合はファイル読み込みをスキップ
if (projectId && projectId.startsWith('temp_project_')) {
    console.log("⭐ Zero-Project Mode: localStorageから読み込みます");
    const stored = window.localStorage.getItem(`project_${projectId}`);
    if (stored) {
        // localStorageから読み込み
        const data = JSON.parse(stored);
        window.gameData = data;
        // ...
    } else {
        // 新規作成
        window.gameData = {
            title: "新規プロジェクト",
            questions: [],
            results: [],
            // ...
        };
    }
}
```

#### 3. オートセーブ機能の改善（`editor.js`）
- `startAutosave`関数を修正
  - `autosave_project`と`project_{projectId}`の両方に保存
  - Zero-Project Modeでも正しく動作

```javascript
function startAutosave() {
    // ...
    autosaveInterval = setInterval(function() {
        const json = JSON.stringify(gameData);
        if (json !== lastSavedState) {
            try {
                // Zero-Project Mode対応: projectIdを使って保存
                const projectId = window.projectId || localStorage.getItem("project_id") || "temp_project";
                localStorage.setItem("autosave_project", json);
                localStorage.setItem(`project_${projectId}`, json);
                // ...
            } catch (e) {
                console.warn("[Editor] オートセーブに失敗:", e);
            }
        }
    }, 3000);
}
```

#### 4. プロジェクト保存機能の改善（`editor.js`）
- `saveProjectAs`関数を修正
  - `project_{projectId}`としても保存
  - Zero-Project Modeで作成したプロジェクトも正しく保存される

```javascript
// localStorage に保存
try {
    // Zero-Project Mode対応: projectIdを使って保存
    const projectId = window.projectId || localStorage.getItem("project_id") || "temp_project";
    // ...
    localStorage.setItem(`project_${projectId}`, JSON.stringify(gameData));
    // ...
} catch (storageError) {
    console.warn("[Editor] localStorage への保存に失敗しました:", storageError);
}
```

---

## 🔧 初期化の二重発火防止

### 問題
複数の`DOMContentLoaded`イベントリスナーが存在し、初期化処理が二重に実行される可能性がありました。

### 解決策
- `editor.js`の先頭に初期化ガードを追加
  - `window.__editor_initialized`フラグで初期化状態を管理
  - 既に初期化済みの場合は警告を出力してスキップ

```javascript
// ==========================================================
// 初期化の二重発火を防ぐ（editor_main.js と統合）
// ==========================================================
if (window.__editor_initialized) {
    console.warn("[Editor] initialization skipped (already initialized)");
    return;
}
window.__editor_initialized = true;
```

---

## 📊 変更ファイル一覧

### 変更
1. `src/editor/editor_main.js`
   - Zero-Project Modeの自動プロジェクト生成機能を追加
   
2. `src/editor/editor_init.js`
   - `loadGameData`関数にZero-Project Mode対応を追加
   - `project.json`読み込み失敗時のfallback処理を改善
   - `loadProject`関数で`window.projectId`を優先的に使用するように修正

3. `editor.js`
   - 初期化の二重発火を防ぐガードを追加
   - `startAutosave`関数を修正（projectId対応）
   - `saveProjectAs`関数を修正（projectId対応）

---

## 🎯 動作確認

### Zero-Project Mode
- [x] `editor.html`をproject_idなしで開いた場合、自動で新規プロジェクトが生成される
- [x] localStorageに`temp_project_{timestamp}`として保存される
- [x] 質問・選択肢の追加・編集が正常に動作する
- [x] オートセーブが正常に動作する
- [x] プロジェクト保存が正常に動作する

### 初期化の二重発火防止
- [x] 複数のDOMContentLoadedリスナーがあっても初期化が一度だけ実行される
- [x] 既に初期化済みの場合は適切にスキップされる

---

## 📌 今後の展開

- Zero-Project Modeで作成したプロジェクトを正式プロジェクトとして管理する機能
- project_managerからJSONを読み込んで正式プロジェクトとして登録する機能
- temp_projectの自動クリーンアップ機能（オプション）

---

## 🔄 技術的詳細

### プロジェクトIDの生成規則
- フォーマット: `temp_project_{YYYYMMDDHHmmss}`
- 例: `temp_project_20251209143025`
- タイムスタンプはUTC時間をISO形式から生成

### localStorage保存構造
- `project_id`: 現在のプロジェクトID
- `project_{projectId}`: プロジェクトデータ本体
- `autosave_project`: オートセーブデータ（後方互換性のため保持）

### ファイル読み込みの優先順位
1. localStorageの`project_{projectId}`
2. `../../projects/{projectId}/project.json`
3. 新規作成（Zero-Project Modeのみ）

---

## ✅ 互換性

- 既存の`project_id`パラメータを使用した起動方法は引き続きサポート
- 既存のlocalStorageデータとの互換性を維持
- 後方互換性を保持しながら新機能を追加

---

## 📚 データ構造の正式仕様化（v2.0/v3.0）

### quiz.json v2.0仕様への統一

#### 背景
quiz.jsonのデータ構造を統一し、理解階層（measure）やメタ情報を標準化しました。

#### 実装内容

##### 1. quiz.json API の追加（`server.js`）

**`GET /api/project/:projectId/quiz`**
- quiz.jsonを配列形式で読み込み（v2.0構造前提）
- 存在しない場合は空配列`[]`を返却

**`POST /api/project/:projectId/quiz/save`**
- v2.0構造を強制適用
  - 各質問に`meta`（created_at, updated_at）を自動追加
  - 各質問に`measure`（6軸オブジェクト）を保証
  - 各選択肢に`tags`（配列）を保証

```javascript
// v2.0 構造強制
const now = new Date().toISOString();
if (Array.isArray(data)) {
  data.forEach(q => {
    q.meta = q.meta || {};
    q.meta.updated_at = now;
    q.measure = q.measure || {
      "識別": 0, "説明": 0, "適用": 0,
      "区別": 0, "転移": 0, "構造化": 0
    };
    // choice tags の構造保証
    q.choices.forEach(c => {
      if (!Array.isArray(c.tags)) c.tags = [];
    });
  });
}
```

##### 2. quiz.json自動修復API（`server.js`）

**`POST /api/dev/repair-quiz-json`**
- 既存プロジェクトのquiz.jsonをスキャン
- v1→v2移行を自動実行
  - `measure`（6軸オブジェクト）の追加
  - `meta`情報の追加
  - 選択肢の`tags`配列の保証

##### 3. エディタ側の更新

**`src/editor/modules/actions/nodes.js`**
- `addQuestion()`関数をv2.0仕様に更新
  - `measure`オブジェクト（6軸）を初期化
  - `meta`情報を追加
  - 選択肢に`id`（ランダム生成）、`tags`配列、`is_correct`を追加

**`editor.js`**
- `addChoice()`関数をv2.0仕様に更新
  - 選択肢に`id`（ランダム生成）を追加
  - `tags`配列を追加
  - `is_correct`フィールドを追加（後方互換性のため旧フィールドも維持）
- `createNewQuestion()`関数を追加（v2.0仕様）

**`src/editor/editor.html`**
- measure編集UI（6軸版）を追加
  - 6軸（識別、説明、適用、区別、転移、構造化）のグリッドUI
  - クリック可能なカード形式

##### 4. 初期化処理の更新

- 新規プロジェクト作成時: quiz.jsonを空配列`[]`で初期化（v2.0仕様）
- 旧構造削除API: quiz.jsonを空配列`[]`で初期化

---

### glossary.json v3.0仕様への対応

#### 背景
Glossary（概念リスト）のデータ構造をv3.0仕様に統一し、理解階層レベル、メタ認知情報、関係性、誤概念情報を標準化しました。

#### 実装内容

##### 1. glossary.json API の追加（`server.js`）

**`GET /api/project/:projectId/glossary`**
- glossary.jsonを読み込み（v3.0構造前提）
- 存在しない場合は`{ version: 3, concepts: [] }`を返却
- versionが無い場合はv3とみなす

**`POST /api/project/:projectId/glossary/save`**
- v3.0構造を強制適用
  - `version: 3`を設定
  - 各概念に`tags`（配列）を保証
  - 各概念に`level`（6軸オブジェクト）を保証
  - 各概念に`metacog`（metacognition_level, tom_level）を保証
  - 各概念に`relations`（prerequisites, related）を保証
  - 各概念に`misconceptions`（配列）を保証

```javascript
// 必須構造を保証（v3.0）
data.version = 3;
data.concepts = data.concepts || [];

data.concepts.forEach(c => {
  c.tags = c.tags || [];
  c.level = c.level || {
    "識別": 0, "説明": 0, "適用": 0,
    "区別": 0, "転移": 0, "構造化": 0
  };
  c.metacog = c.metacog || {
    metacognition_level: 0,
    tom_level: 0
  };
  c.relations = c.relations || {
    prerequisites: [],
    related: []
  };
  c.misconceptions = c.misconceptions || [];
});
```

##### 2. glossary.json自動アップグレードAPI（`server.js`）

**`POST /api/dev/repair-glossary-json`**
- 既存プロジェクトのglossary.jsonをスキャン
- v1/v2→v3移行を自動実行
  - `version: 3`の追加
  - 各概念に`level`（6軸オブジェクト）の追加
  - 各概念に`metacog`情報の追加
  - 各概念に`relations`情報の追加
  - 各概念に`misconceptions`配列の追加
  - 各概念に`tags`配列の保証

##### 3. エディタUIの追加（`src/editor/editor.html`）

- Glossary編集パネルを追加
  - フルスクリーンモーダル形式
  - ヘッダーに「Glossary（概念リスト）v3.0」タイトル
  - 閉じるボタン
  - 概念一覧表示エリア（`#glossaryList`）
  - 「概念を追加」ボタン（`#addConceptBtn`）
  - デフォルトで非表示（JavaScriptで表示制御可能）

##### 4. 初期化処理の更新

- 新規プロジェクト作成時: glossary.jsonを`{ version: 3, concepts: [] }`で初期化
- 旧構造削除API: glossary.jsonを`{ version: 3, concepts: [] }`で初期化

---

## 📊 変更ファイル一覧（追加）

### サーバー側（`server.js`）
- quiz.json API追加（GET/POST）
- quiz.json自動修復API追加
- glossary.json API追加（GET/POST）
- glossary.json自動アップグレードAPI追加
- 新規プロジェクト作成時の初期化処理をv2.0/v3.0仕様に更新
- 旧構造削除APIの初期化処理をv2.0/v3.0仕様に更新

### クライアント側

**`src/editor/modules/actions/nodes.js`**
- `addQuestion()`関数をv2.0仕様に更新
- `defaultMeasure`定数を追加

**`editor.js`**
- `createNewQuestion()`関数を追加（v2.0仕様）
- `addChoice()`関数をv2.0仕様に更新
- `defaultMeasure`定数を追加

**`src/editor/editor.html`**
- measure編集UI（6軸版）を追加
- Glossary編集パネルUIを追加

---

## 🎯 動作確認（追加）

### quiz.json v2.0
- [x] 新規プロジェクト作成時に空配列`[]`で初期化される
- [x] quiz.json APIで読み書きが正常に動作する
- [x] 自動修復APIで既存データがv2.0仕様にアップグレードされる
- [x] エディタで新規問題作成時にv2.0構造が適用される
- [x] 選択肢追加時に`id`、`tags`、`is_correct`が設定される

### glossary.json v3.0
- [x] 新規プロジェクト作成時に`{ version: 3, concepts: [] }`で初期化される
- [x] glossary.json APIで読み書きが正常に動作する
- [x] 自動アップグレードAPIで既存データがv3.0仕様にアップグレードされる
- [x] Glossary編集パネルUIが表示される（JavaScript実装待ち）

---

## 📌 今後の展開（追加）

### quiz.json v2.0
- measure編集UIのJavaScript実装
- 選択肢の`tags`編集機能
- メタ情報（difficulty, rt_expected）の編集UI

### glossary.json v3.0
- Glossary編集パネルのJavaScript実装
- 概念の追加・編集・削除機能
- 理解階層レベル（level）の編集UI
- メタ認知情報（metacog）の編集UI
- 関係性（relations）の編集UI
- 誤概念（misconceptions）の編集UI

---

## 🔄 技術的詳細（追加）

### quiz.json v2.0構造

```javascript
// 配列形式
[
  {
    id: "q_1234567890",
    question: "質問文",
    type: "single",
    choices: [
      {
        id: "c_abc123",  // v2.0: ランダム生成ID
        text: "選択肢1",
        tags: [],  // v2.0
        is_correct: false  // v2.0
      }
    ],
    measure: {  // v2.0: 6軸オブジェクト
      "識別": 0,
      "説明": 0,
      "適用": 0,
      "区別": 0,
      "転移": 0,
      "構造化": 0
    },
    meta: {  // v2.0
      difficulty: "medium",
      rt_expected: 1500,
      created_at: "2025-12-09T14:30:25.000Z",
      updated_at: "2025-12-09T14:30:25.000Z"
    }
  }
]
```

### glossary.json v3.0構造

```javascript
{
  version: 3,
  concepts: [
    {
      id: "concept_1",
      name: "概念名",
      definition: "定義",
      tags: [],  // v3.0
      level: {  // v3.0: 6軸オブジェクト
        "識別": 0,
        "説明": 0,
        "適用": 0,
        "区別": 0,
        "転移": 0,
        "構造化": 0
      },
      metacog: {  // v3.0
        metacognition_level: 0,
        tom_level: 0
      },
      relations: {  // v3.0
        prerequisites: [],
        related: []
      },
      misconceptions: []  // v3.0
    }
  ]
}
```

---

## ✅ 互換性（追加）

### quiz.json v2.0
- 既存のv1形式（オブジェクト形式）は自動修復APIでv2.0に変換可能
- 選択肢の`isCorrect`、`correct`フィールドは後方互換性のため維持
- `value`、`nextId`フィールドは互換性のため維持

### glossary.json v3.0
- 既存のv1/v2形式は自動アップグレードAPIでv3.0に変換可能
- `terms`構造から`concepts`構造への移行をサポート
- 既存データの自動補完により安全にアップグレード可能

---

