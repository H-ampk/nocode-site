# 2025-11-17 プロジェクト再構成・公開方式・admin分離 変更履歴

## 重要変更（破壊的）
- ルート直下のHTML/JSを役割別フォルダへ強制移動（元ファイルは削除）。ルート直下は `main.html / README.md / package.json / LICENSE / .gitignore` のみ。
- エントリーポイントを `main.html` に統一（トップページ）。

## ディレクトリ再編
- 新規作成/整理
  - `src/`（ロジック本体）: `core/`, `editor/`, `player/`, `glossary/`, `concepts/`, `diagnostic/`, `explanation/`, `utils/`, `auth/`
  - `public/`（静的ファイル）: `public/css/`, `public/img/`
  - `player/`（一般利用画面）: `player/index.html`, `player/demo.html`
  - `admin/`（管理画面）: `admin/admin.html`, `admin/editor.html`, `admin/glossary.html`, `admin/project_manager.html`, `admin/login.html`
  - `projects/`（ユーザープロジェクト）: `projects/sample_project/`（`quiz.json`, `editor.json`, `glossary.json`, `concept_graph.json`, `project.json`）
  - `docs/`（ドキュメント）: `README.md`, `architecture.md`, `roadmap.md`, `glossary_spec.md`, `concept_graph_spec.md`, `diagnostic_logic.md`, `README_legacy.html`
  - `archive/`（一時退避）: `archive/README.md`

## 公開方式（public/pin/login）導入
- `projects/{id}/project.json` に公開方式を保存:
  - `access_mode`: `"public" | "pin" | "login"`（初期値 `"public"`）
  - `pin_code`: `"1234"` など（`pin` 以外では `null`）
- サンプル `projects/sample_project/project.json` を `{"access_mode":"public","pin_code":null}` に修正。

## 管理画面のPIN認証
- 追加: `src/auth/pin.js`（`window.AdminAuth.init({admin:true})`）
- `admin/*` はPINロジックを必ず読み込み。挙動:
  - `public`: 認証不要
  - `pin`: `project.json.pin_code` 一致時に `localStorage` に認証フラグ保存
  - `login`: 未実装メッセージを表示してアクセス不可（将来対応）

## エントリ/UI
- `main.html` を入口に統一。メニュー: Player・Admin・Projects。
- 公開設定UI（main / admin 両方）
  - ラジオ: `public`（初期選択）/`pin`/`login`（将来機能）
  - `pin` 選択時のみPIN入力欄を表示
  - `project.json` の読み込み/ダウンロード保存を実装
- 共通設定ユーティリティ: `src/core/config.js`（`window.ProjectConfig.load/download/normalize`）

## プレイヤー/エディタ
- `player/index.html`（一般公開画面）を整備。デモ遷移先を `player/demo.html` に変更。
- `player/demo.html` を新設し、ルートの `demo.html` は削除。
- エディタは `admin/editor.html`（iframeで `src/editor/editor.html` を埋め込み）へ一本化。
- `src/editor/editor.js` は当面レガシー互換ローダ（将来本体移設予定）。

## 静的ファイル
- CSSを `public/css/main.css` に統一。各HTMLの `<link>` を更新。
- 画像は今後 `public/img/` へ集約（段階移行方針を `public/README.md` に記載）。

## ドキュメント更新
- `README.md` に新ディレクトリ構成・公開方式・PIN仕様・利用手順・ユーティリティを追記。
- 旧 `README.html` は `docs/README_legacy.html` へ移動。

## ルートから削除（移動後）
- `editor.html`, `glossary.html`, `player.html`, `login.html`, `demo.html`, `README.html`, `auth.js`

## Glossary システム（3層構造）の実装
- **GlossaryLoader.js** (`src/core/GlossaryLoader.js`) を新規作成
  - `loadProjectGlossary()`: プロジェクト固有の用語集を読み込み
  - `loadDomainGlossary()`: 学問領域ごとの用語集を読み込み
  - `loadGlobalGlossary()`: 分野横断の基底辞書を読み込み
  - `mergeGlossaries()`: 複数のGlossaryを統合（優先順位: project > domain > global）
  - `loadGlossaryByPolicy()`: glossary_policyに基づいて自動読み込み・統合
- **project.json の拡張**
  - `glossary_policy` プロパティを追加:
    - `mode`: `"project" | "domain" | "global"`（デフォルト: `"project"`）
    - `domains`: ドメイン名の配列（例: `["psychology", "AI"]`）
  - `src/core/config.js` の `normalize()` 関数でデフォルト値を設定
- **Glossary接続設定UI**
  - `admin/project_manager.html` に Glossary接続設定セクションを追加
    - 3つのモード（プロジェクトのみ / 学問別で共有 / グローバル辞書と接続）を選択可能
    - ドメイン選択チェックボックス（心理学、AI、数学、物理学、生物学、化学）
    - 設定の読み込み・保存機能を実装
- **サンプルファイルの作成**
  - `glossary/global.json`: グローバルGlossary（3つの用語）
  - `glossary/domains/psychology.json`: 心理学ドメインGlossary（3つの用語）
  - `glossary/domains/AI.json`: AIドメインGlossary（3つの用語）
- **テストページ**
  - `admin/glossary_test.html`: 各機能の動作確認用テストページを追加
- **互換性**
  - 既存の `terms` 配列形式と `terms` オブジェクト形式の両方に対応
  - 深いマージ機能（ネストされたオブジェクトも統合、配列フィールドの重複排除）

## Glossary Editor（フォームベース編集）の実装
- **glossary.js** (`admin/glossary.js`) を新規作成
  - `loadGlossary()`: 既存の glossary.json を読み込み、互換性変換（name→word、tags→domains）
  - `renderTermList()`: 用語一覧を動的に表示
  - `addTerm()`: 用語を追加または更新（編集中の場合は上書き）
  - `editTerm()`: 用語を編集モードでフォームに読み込み
  - `deleteTerm()`: 用語を削除
  - `saveGlossary()`: glossary.json を Blob でダウンロード
  - `addCustomDomain()`: カスタム分野を追加（カンマ区切りで複数追加可能）
- **glossary.html の更新**
  - フォームベースの UI を追加:
    - 用語名入力（input）
    - 説明文入力（textarea）
    - 分野チェックボックス（デフォルト: 心理学、認知科学、教育学、AI、哲学）
    - カスタム分野追加機能
    - 用語追加/更新ボタン
    - 保存ボタン（glossary.json ダウンロード）
  - 用語一覧表示エリア（編集・削除ボタン付き）
  - プロジェクトID表示（localStorage から自動取得）
- **データ構造**
  - `termId`: 自動生成（`crypto.randomUUID()`）
  - `word`: 用語名（UI入力）
  - `definition`: 説明文（UI入力）
  - `domains`: 選択された分野の配列
  - `updatedAt`: 自動生成（ISO8601形式）
- **既存データとの互換性**
  - `name` → `word` の自動変換
  - `tags` → `domains` の自動変換
  - `id` がない場合は自動生成
  - `updatedAt` がない場合は現在時刻を設定

## Player の理解ログ取得・解析・Glossary 自動提示システムの実装
- **logging.js** (`src/player/logging.js`) を新規作成
  - `startQuestion()`: 問題表示開始を記録
  - `recordClick()`: 選択肢クリックを記録（choiceId と相対時間）
  - `finalizeAnswer()`: 回答確定時にログを完成
  - `downloadLogs()`: quiz_log.json をダウンロード
  - 記録データ: questionId, timestamp, clicks, final_answer, correct, response_time, path
- **recommendation.js** (`src/player/recommendation.js`) を新規作成
  - `setGlossary()`: 統合済みGlossaryを設定
  - `findTermsByTags()`: 選択肢タグから関連用語を検索
  - `analyzeHesitationPattern()`: 迷いパターンを解析
  - `recommendExplanation()`: 誤答時に最適な解説を推奨
- **player.js** (`src/player/player.js`) を新規作成
  - `loadProject()`: プロジェクト設定とGlossaryを読み込み
  - `loadQuiz()`: クイズデータを読み込み
  - `showQuestion()`: 問題を表示
  - `handleChoiceClick()`: 選択肢クリックを処理
  - `confirmAnswer()`: 回答確定とGlossary解説表示
  - `nextQuestion()`: 次の問題に進む
  - `downloadLogs()`: 学習ログをダウンロード
- **player/demo.html の更新**
  - 解説エリアを追加（誤答時に自動表示）
  - 学習ログダウンロードボタンを追加
  - 選択肢の選択状態を視覚化
  - 正誤フィードバックを表示
  - GlossaryLoader を統合（glossary_policy に従って読み込み）
- **データ構造**
  - 選択肢に `tags` プロパティを追加可能（例: `{ id: "c1", text: "...", tags: ["短期記憶"] }`）
  - quiz_log.json の形式: `{ version, generated_at, logs: [...] }`

## Glossary Recommendation Algorithm の実装
- **recommendation.js の拡張**
  - `analyze()` 関数を実装: ログデータを解析して最適な用語解説を選ぶ
    - 戻り値: `{ recommended_terms: [term objects], reason: "why this term was chosen" }`
  - `calculateTagMatchScore()`: conceptTag と glossary.tags の一致度を計算（0-1のスコア）
  - `determineTermDepth()`: 用語の深さレベルを判定（'basic' | 'intermediate' | 'deep'）
  - `analyzePath()`: path（迷いの軌跡）を解析
    - ユニーク要素数、往復パターン、深い混乱を検出
  - `classifyByResponseTime()`: 反応時間による分類
  - `hasRepeatedErrorPattern()`: 同じ誤答パターンが複数回続くかチェック
- **アルゴリズムの判定項目**
  - **反応時間による分類**:
    - 短い（0-3秒）→ basic レベルの用語を優先
    - 中間（3-15秒）→ intermediate レベルの用語を優先
    - 長い（15秒以上）→ deep レベルの用語を優先
  - **path（迷いの軌跡）解析**:
    - ユニーク要素数が1 → 即答型 → 基本定義のみ
    - 2-3選択肢間を往復 → 概念混同 → 対概念の比較解説を提示
    - 4以上遷移 → 深い混乱 → 関連用語まとめを提示（最大3つ）
  - **conceptTag と glossary.tags の一致度計算**: 一致度スコアでソートし、最も高い用語を優先表示
  - **同じ誤答パターンが複数回続く場合**: links を持つ用語を優先的に提示
- **Player UI の更新**
  - 解説エリアに理由表示を追加（`explanation.reason` を表示）
  - 複数の推奨用語に対応（`recommended_terms` 配列を表示）
  - 反応時間やpath解析に基づいて表示内容を選択（definition, example, note, links）

## Player の反応時間プロファイル設定機能の実装
- **config.js の更新**
  - `timing_profile` のデフォルト値を追加:
    - `instant_threshold: 3`（直感の判定閾値）
    - `deliberate_threshold: 15`（熟慮の判定閾値）
    - `profile_name: 'default'`
  - 不正値の自動修正（`instant_threshold > deliberate_threshold` の場合）
- **project_manager.html の更新**
  - 反応時間プロファイル設定UIを追加:
    - プロファイル選択（general / slow / fast / custom）
    - カスタム設定（直感の閾値、熟慮の閾値、プロファイル名）
    - 説明文を追加（「反応の速さは能力を示すものではありません」）
  - プロファイルプリセット機能:
    - `general`: instant=3, deliberate=15（標準）
    - `slow`: instant=7, deliberate=25（ASD・境界知能などを想定）
    - `fast`: instant=1.5, deliberate=8（ギフテッド想定）
    - `custom`: 自由入力
  - 設定の読み込み・保存機能を実装
- **recommendation.js の更新**
  - `classifyByResponseTime()` を `timing_profile` に対応
    - `thinkingType` を返す（'instant' | 'searching' | 'deliberate'）
    - `timing_profile` の閾値を使用して分類
  - `analyze()` 関数に `timingProfile` パラメータを追加
  - 思考タイプに応じたGlossary提示内容:
    - `instant` → definition（基礎解説）
    - `searching` → example / note（補足）
    - `deliberate` → domain_definition / links（深い背景）
- **player.js の更新**
  - `timingProfile` 変数を追加
  - `loadProject()` で `timing_profile` を読み込み
  - `confirmAnswer()` で `timingProfile` を `analyze()` に渡す
- **思考タイプの判定ロジック**
  - `response_time <= instant_threshold` → `instant`（直感）
  - `instant_threshold < response_time < deliberate_threshold` → `searching`（探索的思考）
  - `response_time >= deliberate_threshold` → `deliberate`（熟慮）

## 備考 / 今後のタスク
- `data/` 配下の画像/音源は段階的に `public/img/` へ移行し、参照パスを置換予定。
- `src/editor/editor.js` の本体移設（ローダ脱却）を継続。
- quiz_log.json に recommended_terms を保存する機能は将来実装予定。
- timing_profile は将来的に per-student カスタマイズにも拡張可能な形式。


