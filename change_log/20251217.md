# 改変履歴 - 2025年12月17日

## 📝 概要
学習データ分析ダッシュボードの統計計算レイヤを統一し、研究用の詳細分析機能を実装しました。LLMを使用せず、テンプレートベースで研究用の傾向サマリを自動生成する機能も追加しました。

---

## 🎯 1. 統計計算レイヤの統一（stats_core.js）

### 改善内容

#### 統一的な統計計算モジュールの作成
- `src/core/stats_core.js`を新規作成
- ログデータから基本的な統計情報を計算する統一レイヤを実装
- 複数のログ形式に対応（`log.correct`、`log.selected.correct`、`log.response_time`など）

#### 計算される統計情報
- 総回答数、正答数、誤答数、正答率
- 概念別スコア集計
- 誤答ランキング
- 反応時間統計（平均、中央値、標準偏差、最小値、最大値）
- パス長統計（平均パス長）
- セッション数
- 概念別詳細統計（正答率、平均反応時間、平均パス長、Glossary表示率）

### 変更ファイル
- `src/core/stats_core.js` - 新規作成

---

## 🎯 2. 詳細分析レポート生成（insights_core.js）

### 改善内容

#### 研究用の解釈ロジックを実装
- `src/core/insights_core.js`を新規作成
- 統計データから洞察を生成する機能を実装
- 構造化された洞察オブジェクト（タイプ、カテゴリ、メッセージ、詳細）を返す

#### 生成される洞察の種類
- **総評**: 正答率に基づく全体評価（critical/warning/info/success）
- **弱点概念**: 最も弱い概念の特定
- **反応時間**: 反応時間の分析（長い/短い、ばらつき）
- **誤答パターン**: 誤答が集中している概念
- **データ品質**: データ量の評価

#### 出力形式
- `generateInsights()` - 構造化された洞察オブジェクト
- `generateInsightsText()` - テキスト形式（簡易版）
- `generateInsightsByCategory()` - カテゴリ別にグループ化
- `generateInsightsSorted()` - 重要度順にソート

### 変更ファイル
- `src/core/insights_core.js` - 新規作成
- `src/core/README.md` - 関数一覧を更新

---

## 🎯 3. 個人とクラス平均の比較（class_compare.js）

### 改善内容

#### 相対的な位置づけ分析機能を実装
- `src/core/class_compare.js`を新規作成
- 学習者の統計データをクラス全体の平均と比較する機能を実装

#### 比較の種類
- **全体評価**: 正答率の差に基づく評価（±5%、±10%の閾値）
- **概念別評価**: 各概念の正答率を比較（±15%の閾値）
- **反応時間**: 平均反応時間を比較（±20%の閾値）
- **相対位置**: パーセンタイルと順位を計算

#### 機能
- `compareWithClass()` - 個人とクラス平均を比較
- `compareWithClassText()` - テキスト形式で取得
- `compareMultipleStudents()` - 複数の学習者を一括比較
- `calculateRelativePosition()` - クラス内での相対位置を計算

### 変更ファイル
- `src/core/class_compare.js` - 新規作成
- `src/core/README.md` - 関数一覧を更新

---

## 🎯 4. 理解構造レポートタブの追加

### 改善内容

#### Dashboardへの統合
- `public/dashboard.html`に「理解構造レポート」タブを追加
- `public/js/dashboard.js`にinsights表示ロジックを追加
- データセット選択時に自動で理解構造レポートを生成

#### UI機能
- カテゴリ別にグループ化して表示
- 重要度に応じた色分け表示（critical/warning/info/success）
- 詳細情報の表示（各洞察の詳細説明）

### 変更ファイル
- `public/dashboard.html` - タブとコンテンツセクションを追加
- `public/js/dashboard.js` - insights表示ロジックを追加
- `public/css/dashboard.css` - insightsレポートのスタイルを追加

---

## 🎯 5. ダッシュボード統合（全タブで統計値を共有）

### 改善内容

#### 統一的なデータロード機能
- `loadSessionData()`関数を実装
- 全タブで統計値を共有するため、グローバル変数に保存
- `renderSummary()`, `renderConcept()`, `renderMistake()`, `renderInsights()`を統一呼び出し

#### データフロー
1. データセット選択 → `loadSessionData()`呼び出し
2. ログを抽出 → `computeStats()`で統計計算
3. グローバル変数に保存 → `window.currentStats`, `window.currentLogs`
4. 全タブを更新 → 各レンダリング関数を呼び出し

### 変更ファイル
- `public/js/dashboard.js` - `loadSessionData()`関数を追加

---

## 🎯 6. 基本統計の復元（A_basic_statistics_restore）

### 改善内容

#### 研究用の基本統計を表示
- 総回答数、総セッション数、全体正答率、平均反応時間、平均パス長を計算
- 概念別の集計（正答率、平均反応時間、平均パス長）を実装
- サマリーカードと概念スコアテーブルを表示

#### UIコンポーネント
- **サマリーカード**: 総回答数、平均正答率、最弱理解階層、誤概念ランキング、平均反応時間、平均パス長
- **概念スコアテーブル**: 概念名、回答数、正答率、平均反応時間、平均パス長

### 変更ファイル
- `src/core/stats_core.js` - パス長とセッション数の計算を追加
- `public/dashboard.html` - 平均反応時間と平均パス長のカードを追加
- `public/js/dashboard.js` - `updateSummaryCards()`と`renderConceptScoreTable()`を実装
- `public/css/dashboard.css` - 概念スコアテーブルのスタイルを追加

---

## 🎯 7. 概念理解分析（B_concept_understanding_analysis）

### 改善内容

#### 概念ごとの理解傾向を数値的に可視化
- `normalizeConceptStats()`関数を実装（全体平均からの偏差を計算）
- ヒートマップで概念別の理解傾向を可視化

#### ヒートマップ機能
- **X軸**: メトリクス（正答率、平均反応時間、平均パス長、Glossary表示率）
- **Y軸**: 概念（conceptTags）
- **色スケール**: 全体平均からの偏差（赤=高、白=同等、青=低）

#### 計算されるメトリクス
- 正答率の全体平均からの偏差
- 平均反応時間の全体平均からの偏差
- 平均パス長の全体平均からの偏差
- Glossary表示率の全体平均からの偏差

### 変更ファイル
- `src/core/stats_core.js` - `normalizeConceptStats()`関数を追加、Glossary表示率の計算を追加
- `public/dashboard.html` - 概念理解分析タブを追加
- `public/js/dashboard.js` - `renderConceptUnderstanding()`関数を実装
- `public/css/dashboard.css` - ヒートマップテーブルのスタイルを追加

---

## 🎯 8. 誤答パストポロジー分析（C_mistake_topology）

### 改善内容

#### 誤答時のpath遷移を用いた「迷いの構造」を可視化
- `src/core/mistake_topology.js`を新規作成
- 誤答ログからパストポロジーグラフを構築
- SVGでネットワークグラフを描画

#### グラフ構造
- **ノード**: ユニークなpath状態（選択肢）
- **エッジ**: path[i] → path[i+1]の遷移
- **重み**: 遷移頻度

#### ノードメトリクス
- 平均反応時間
- 平均パス長
- エラー頻度
- 関連概念タグ

#### 可視化
- SVGでネットワークグラフを描画
- ノードサイズ: 頻度に比例（20-60px）
- ノード色: 概念タグがある場合は赤、ない場合は青
- エッジ太さ: 遷移頻度に比例（1-5px）

### 変更ファイル
- `src/core/mistake_topology.js` - 新規作成
- `public/dashboard.html` - 迷いパターン分析タブのコンテンツを追加
- `public/js/dashboard.js` - `renderMistakeTopology()`と`renderTopologySVG()`を実装

---

## 🎯 9. 概念依存関係グラフ（D_concept_dependency_graph）

### 改善内容

#### 概念間の依存関係・誤答連鎖をネットワーク構造として生成
- `src/core/concept_dependency.js`を新規作成
- 概念間の共起関係と誤答連鎖を可視化
- JSON形式でダウンロード可能

#### グラフ構築ロジック
- **ノード**: conceptTags（概念）
- **エッジ**: concept_i ↔ concept_j（無向グラフ）
- **重み**: 共起回数 + 誤答時は+2ボーナス

#### ノード統計
- 正答率（correct_rate）
- 平均反応時間（avg_response_time）
- 総出現回数（total_count）

#### 可視化と出力
- SVGでネットワークグラフを描画
- ノード色: 正答率に基づく（緑=高、赤=低）
- JSON形式でダウンロード可能（`concept_graph.json`）

### 変更ファイル
- `src/core/concept_dependency.js` - 新規作成
- `public/dashboard.html` - 概念依存関係グラフセクションを追加
- `public/js/dashboard.js` - `renderConceptDependency()`と`renderConceptGraphSVG()`を実装

---

## 🎯 10. 反応時間プロファイル（E_response_time_profile）

### 改善内容

#### 概念別・正誤別の反応時間分布を分析
- `src/core/response_time_profile.js`を新規作成
- 反応時間分布を計算（四分位数、平均、最小値、最大値）
- ボックスプロットで可視化

#### 分布分析
- 概念別に分割: 各概念の反応時間を抽出
- 正誤別に分割: 正答と誤答の反応時間を分離
- 全体分布との比較

#### ボックスプロット可視化
- **X軸**: 概念タグ（conceptTags）
- **Y軸**: 反応時間（秒）
- **正誤別オーバーレイ**: 正答（緑、左側）、誤答（赤、右側）
- **全体平均線**: 破線で表示
- **ボックスプロット要素**: Q1-Q3の範囲、中央値線、ひげ（最小値-Q1、Q3-最大値）

### 変更ファイル
- `src/core/response_time_profile.js` - 新規作成
- `public/dashboard.html` - 反応時間プロファイルタブのコンテンツを追加
- `public/js/dashboard.js` - `renderResponseTimeProfile()`と`renderResponseTimeBoxplot()`を実装

---

## 🎯 11. 研究傾向サマリ生成（F_pattern_summary_non_ai）

### 改善内容

#### LLMを使用せず、テンプレートベースで研究用の傾向サマリを自動生成
- `src/core/pattern_summary.js`を新規作成
- 統計結果からパターンを検出し、テンプレートベースでテキスト生成

#### 検出されるパターン
1. **低正答率かつ高パス長**: 正答率が全体平均より10%以上低く、平均パス長が120%以上
2. **反応時間のみが長い**: 正答率は平均的だが、反応時間が130%以上
3. **Glossary表示されたが誤答率が高い**: Glossary表示率が150%以上だが、正答率が15%以上低い
4. **正答率が高いが反応時間も長い**: 正答率が15%以上高いが、反応時間も120%以上長い
5. **誤答時の反応時間が正答時より長い**: 誤答時の平均反応時間が正答時の120%以上
6. **誤答時の反応時間が正答時より短い**: 誤答時の平均反応時間が正答時の80%以下
7. **高パス長かつ低正答率**: 平均パス長が3以上、正答率が50%未満
8. **長い反応時間だが高正答率**: 平均反応時間が5秒以上、正答率が70%以上

#### 出力形式
- 箇条書きサマリ形式
- 研究用言語のみ（数値と事実のみを記述）
- 解釈や人格的評価なし

### 変更ファイル
- `src/core/pattern_summary.js` - 新規作成
- `public/dashboard.html` - 研究傾向サマリタブを追加
- `public/js/dashboard.js` - `renderPatternSummary()`関数を実装

---

## 📊 変更ファイル一覧

### 新規作成
1. `src/core/stats_core.js` - 統計計算の統一レイヤ
2. `src/core/insights_core.js` - 詳細分析レポート生成
3. `src/core/class_compare.js` - 個人とクラス平均の比較
4. `src/core/mistake_topology.js` - 誤答パストポロジー分析
5. `src/core/concept_dependency.js` - 概念依存関係グラフ
6. `src/core/response_time_profile.js` - 反応時間分布分析
7. `src/core/pattern_summary.js` - 研究傾向サマリ生成
8. `change_log/20251217.md` - このファイル

### 変更
- `src/core/README.md` - 関数一覧を更新
- `public/dashboard.html` - 複数のタブとコンテンツセクションを追加
- `public/js/dashboard.js` - 複数のレンダリング関数を追加、統一的なデータロード機能を実装
- `public/css/dashboard.css` - 新しいUIコンポーネントのスタイルを追加

---

## 🔄 動作確認

### 基本統計の表示
- [x] 総回答数、正答率、平均反応時間、平均パス長が表示される
- [x] 概念スコアテーブルが表示される

### 概念理解分析
- [x] ヒートマップが表示される
- [x] 全体平均からの偏差が正しく計算される

### 誤答パストポロジー分析
- [x] ネットワークグラフが表示される
- [x] ノードとエッジが正しく描画される

### 概念依存関係グラフ
- [x] 概念間の共起関係が可視化される
- [x] JSON形式でダウンロードできる

### 反応時間プロファイル
- [x] ボックスプロットが表示される
- [x] 正誤別に色分けされる
- [x] 全体平均線が表示される

### 研究傾向サマリ
- [x] パターンが検出される
- [x] テンプレートベースでテキストが生成される

---

## 🛠️ 技術スタック

- **JavaScript (ES6 Modules)**: 統計計算と可視化
- **SVG**: ネットワークグラフとボックスプロットの描画
- **HTML/CSS**: Dashboard UI

---

## 📝 副作用・移行措置

- 既存の統計計算ロジックは`stats_core.js`に統合されました
- 各タブで統計値を共有するため、グローバル変数（`window.currentStats`, `window.currentLogs`）を使用しています
- 後方互換性のため、既存の関数も保持しています

---

## 🎨 改善効果

- **統計計算の統一**: 全タブで同じ統計計算ロジックを使用
- **研究用分析機能の充実**: 概念理解分析、誤答パターン分析、反応時間分析など
- **LLM不要のサマリ生成**: テンプレートベースで研究用の傾向サマリを自動生成
- **可視化の強化**: ヒートマップ、ネットワークグラフ、ボックスプロットなど

---

## 📝 今後の拡張予定

- より高度なパターン検出ルールの追加
- インタラクティブなグラフ可視化（D3.jsなどの使用）
- 統計結果のエクスポート機能（CSV、PDFなど）
- 複数データセットの比較機能




