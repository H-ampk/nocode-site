# 変更ログ - 2025年11月25日

## 概要
因子分析（Factor Analysis）とクラスタリング機能を中心とした、学習データ分析機能の大幅な拡張を実装しました。

---

## 新規実装機能

### 1. 因子分析（Factor Analysis）モジュール（Task A）

#### 実装ファイル
- `analysis/factor_analysis.js` (新規作成)
- `src/admin/analysis.js` (統合)
- `admin/analysis.html` (UI追加)

#### 機能概要
- 学習ログデータから観測変数を抽出し、PCA（主成分分析）とVarimax回転による因子分析を実行
- Kaiser基準（固有値 > 1）による因子数の自動決定
- 因子負荷量マトリックスと生徒ごとの因子スコアを生成

#### 観測変数
- 正誤（0/1）
- 反応時間（rt）
- 選択遷移回数（choice_steps）
- 戻る回数（back_count）
- 記述抽象度（abstract_score）
- 確信度（confidence）
- ページ滞在時間（dwell）
- 誤答タイプID（error_type）

#### 出力形式
```json
{
  "eigenvalues": [...],
  "num_factors": 3,
  "loadings": { "Q1": [...], "Q2": [...], ... },
  "factor_scores": { "student_id": { "F1": 0.42, "F2": -0.12, ... }, ... }
}
```

#### UI機能
- 固有値一覧表（Kaiser基準で採用/除外を表示）
- 因子負荷量表（Varimax回転後、色分け表示）
- 生徒ごとの因子スコア表（スクロール可能）
- CSVエクスポート機能

---

### 2. 因子ラベリングUI（Task B）

#### 実装ファイル
- `src/admin/analysis.js` (機能追加)

#### 機能概要
- 因子分析実行後に自動生成される因子（F1, F2, ...）に対して、教師が自由に名前を付けられるUI
- 因子ラベルは因子スコア表と因子負荷量表のヘッダーに反映

#### データ永続化
- **localStorage**: `factor_labels_{projectId}` に保存
- **プロジェクトファイル**: `projects/{id}/analysis_labels.json` としてダウンロード

#### UI構成
- 因子数に応じて動的に入力欄を生成
- 「💾 ラベルを保存」ボタンで保存
- 保存後に表のヘッダーを自動更新

---

### 3. k-meansクラスタリング機能（Task C）

#### 実装ファイル
- `analysis/clustering.js` (新規作成)
- `src/admin/analysis.js` (統合)
- `admin/analysis.html` (UI追加)

#### 機能概要
- 因子分析で得た因子スコアを入力として、k-meansクラスタリングを実行
- 生徒を「思考タイプ」としてグループ化

#### アルゴリズム
- k-means実装（最大反復回数: 100）
- ユークリッド距離によるクラスタ割り当て
- ランダム初期化によるクラスタ中心の選択

#### 出力形式
```json
{
  "k": 4,
  "labels": { "studentA": 0, "studentB": 2, ... },
  "cluster_centers": [
    { "F1": 0.2, "F2": -0.1, ... },
    ...
  ],
  "factor_keys": ["F1", "F2", ...],
  "iterations": 15
}
```

#### UI機能
- k選択用セレクトボックス（2〜10）
- クラスタごとの平均因子スコア表（色分け表示）
- 生徒一覧（クラスタ別、色分け表示）
- 2D散布図（Canvas、F1-F2平面、クラスタごとに色分け）
- クラスタ中心を×印で表示
- 凡例表示

---

### 4. 問題貢献度（因子負荷量）UI（Task D）

#### 実装ファイル
- `src/admin/analysis.js` (機能追加)
- `admin/analysis.html` (UI追加)

#### 機能概要
- 因子分析実行後に生成される `loadings` をもとに、各問題がどの因子に最も影響しているかを一覧表示

#### 表示内容
- **Question ID**: 問題ID
- **各因子列（F1, F2, ...）**: 各因子への負荷量（因子ラベルがあればラベル名で表示）
- **支配因子**: 絶対値が最大の因子（色分けで強調）
- **強度 (Strength)**: 支配因子の絶対値

#### 機能
- 支配因子の自動計算（各行で絶対値が最大の因子を自動判定）
- 因子ラベルの適用（`analysis_labels.json`から読み込み）
- 視覚的な強調（支配因子のセルを背景色とボーダーで強調）
- CSVエクスポート機能

---

### 5. Vector Map可視化（Task E）

#### 実装ファイル
- `src/admin/analysis.js` (VectorMapRendererクラス実装)
- `admin/analysis.html` (UI追加)

#### 機能概要
- 因子分析とクラスタリング結果をもとに、「思考の方向性」を2D座標空間で可視化

#### 表示内容
1. **問題ベクトル（青色の矢印）**
   - 原点から各問題への矢印
   - 問題IDを小さく表示

2. **生徒ベクトル（点）**
   - 各生徒の因子スコアをプロット
   - クラスタリング結果があれば色分け

3. **クラスター中心（大きな点）**
   - 各クラスタの中心を大きな点で表示
   - クラスタID（C0, C1, ...）を表示

4. **平均ベクトル（赤色の太い矢印）**
   - すべての問題ベクトルの平均方向を矢印で表示
   - 「平均」ラベルを表示

#### UI機能
- **表示切替チェックボックス**
  - 問題ベクトル
  - 生徒ベクトル
  - クラスター中心
  - 平均ベクトル

- **軸選択UI**
  - X軸：因子を選択（デフォルト: F1）
  - Y軸：因子を選択（デフォルト: F2）
  - 因子ラベルがあればラベル名で表示

- **自動更新**
  - 因子分析実行後に自動表示
  - クラスタリング実行後に自動更新
  - 軸選択変更時に再描画

#### VectorMapRendererクラス
- `setData()`: データを設定
- `calculateBounds()`: 座標範囲を自動計算
- `drawBackground()`: 背景とグリッドを描画
- `drawProblemVectors()`: 問題ベクトルを描画
- `drawStudentVectors()`: 生徒ベクトルを描画
- `drawClusterCenters()`: クラスター中心を描画
- `drawAverageVector()`: 平均ベクトルを描画
- `draw()`: 全体を描画

---

## 技術的な改善点

### データ処理
- 欠損値の自動補完（平均値埋め or 0）
- データの標準化処理
- 共分散行列の計算
- 固有値・固有ベクトルの計算（Jacobi法）
- Varimax回転の実装

### UI/UX改善
- 色分けによる視覚的な強調
- スクロール可能な表
- リアルタイム更新
- インタラクティブな表示切替

### データ永続化
- localStorageによる一時保存
- プロジェクトファイルへの保存
- CSVエクスポート機能

---

## ファイル変更一覧

### 新規作成
- `analysis/factor_analysis.js`
- `analysis/clustering.js`
- `change_log/20251125.md`

### 変更
- `src/admin/analysis.js`
  - 因子分析機能の統合
  - 因子ラベリング機能の追加
  - クラスタリング機能の統合
  - 問題貢献度表示機能の追加
  - VectorMapRendererクラスの実装

- `admin/analysis.html`
  - 因子分析タブの追加
  - 因子ラベル設定UIの追加
  - クラスタリングセクションの追加
  - 問題貢献度セクションの追加
  - Vector Mapセクションの追加

---

## 今後の拡張可能性

1. **因子分析の拡張**
   - 他の回転手法（Oblimin回転など）の追加
   - 因子スコアの予測機能

2. **クラスタリングの拡張**
   - 階層的クラスタリングの追加
   - クラスタ数の自動決定（エルボー法、シルエット分析）

3. **可視化の拡張**
   - 3D可視化
   - インタラクティブなプロット（Chart.js統合）
   - アニメーション機能

4. **分析機能の拡張**
   - 時系列分析
   - 相関分析
   - 回帰分析

---

## 注意事項

- 因子分析は因子数が2以上の場合にVector Mapが表示されます
- クラスタリングは因子分析実行後に利用可能です
- 因子ラベルはプロジェクトごとに保存されます
- CSVエクスポートはUTF-8 BOM付きで出力されます

---

## テスト推奨項目

1. 因子分析の実行と結果表示
2. 因子ラベルの設定と保存
3. クラスタリングの実行（k=2〜10）
4. 問題貢献度の表示とCSVエクスポート
5. Vector Mapの表示と軸選択
6. 表示切替チェックボックスの動作確認

---

以上


