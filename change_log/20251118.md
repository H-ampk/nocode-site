# 2025-11-18 教師向けデータ分析ダッシュボード（理解ログ可視化ツール）の実装

## 概要
quiz_log.json（学習者の行動ログ）を読み込み、生徒の理解・迷い・反応時間・誤答傾向を可視化する教師用ダッシュボードを追加しました。

## 新規ファイル

### admin/analysis.html
- **UI構成**:
  - quiz_log.json を読み込むファイルインポートボタン
  - 分析結果を表示するダッシュボード領域
  - タブ切り替えUI（6つのセクション）
    - 全体概要
    - 問題別分析
    - 概念混同分析（conceptTag）
    - 反応時間プロファイル集計
    - 迷いパターン（path）分析
    - Glossary 提示履歴の集計
- **Chart.js の導入**
  - CDN から Chart.js 4.4.0 を読み込み
  - 棒グラフ・円グラフ・ヒストグラムの描画に対応
- **スタイル**
  - レスポンシブ対応のタブUI
  - 統計カード表示
  - テーブル表示
  - チャートコンテナ

### src/admin/analysis.js
- **データ読み込み機能**
  - `loadQuizLog(fileData)`: quiz_log.json を読み込み、ログ配列を返す
    - バージョン1.0形式（`{ version, generated_at, logs: [...] }`）に対応
    - 配列形式にも対応

- **集計関数の実装**

  **A. computeOverallStats(logs)**
  - 総回答数
  - 正答率（%）
  - 平均反応時間（秒）
  - 思考タイプ分布（instant / searching / deliberate）
    - デフォルト閾値: instant=3秒、deliberate=15秒

  **B. computePerQuestionStats(logs)**
  - 問題ごとの統計:
    - 総回答数
    - 正答率
    - 平均反応時間
    - よく選ばれた誤答（選択肢IDと出現回数）
    - クリック回数分布

  **C. computeConceptConfusions(logs)**
  - 誤答タグランキング（誤答選択肢IDの出現回数）
  - 混同ペアランキング（path から推測した選択肢遷移パターン）
  - 注意: 現在のログには conceptTag が直接含まれていないため、誤答選択肢IDとpathパターンから推測

  **D. computeResponseTimeProfile(logs)**
  - 反応時間のヒストグラム用データ（0-50秒を1秒刻み）
  - 最頻値（モード）
  - 中央値
  - 最大値・最小値

  **E. computePathPatterns(logs)**
  - ユニーク遷移パターン（path 文字列の出現回数）
  - 迷いのステップ数の平均
  - 最も多い path 例（例：A→C→B）
  - パターンランキング

  **F. computeGlossaryUsage(logs)**
  - 提示された glossary term の頻度
  - 思考タイプ別にどの用語が多いか（instant / searching / deliberate）
  - 注意: 現在のログには recommended_terms や glossary_terms が含まれていない可能性がある（将来拡張に対応可能な構造）

- **グラフ描画機能**
  - Chart.js を使用した可視化:
    - **正答率の棒グラフ**（問題別）
    - **反応時間ヒストグラム**（分布）
    - **思考タイプの円グラフ**（ドーナツチャート）
    - **誤答タグランキングのバーグラフ**（横棒）
  - チャートインスタンス管理（再描画時に既存チャートを破棄）

- **レンダリング関数**
  - `renderOverallStats(stats)`: 全体概要セクションの描画
    - 統計カード表示
    - 思考タイプ分布のドーナツチャート
  - `renderQuestionStats(stats)`: 問題別分析セクションの描画
    - 正答率の棒グラフ
    - 問題別統計テーブル
  - `renderConfusionStats(stats)`: 概念混同分析セクションの描画
    - 誤答タグランキングのバーグラフ
    - 混同ペアランキングテーブル
  - `renderResponseTimeStats(stats)`: 反応時間プロファイルセクションの描画
    - 統計カード（最頻値・中央値・最大値・最小値）
    - 反応時間ヒストグラム
  - `renderPathStats(stats)`: 迷いパターン分析セクションの描画
    - 平均迷いステップ数
    - パターンランキングテーブル
  - `renderGlossaryStats(stats)`: Glossary提示履歴セクションの描画
    - 用語頻度テーブル
    - 思考タイプ別の用語提示頻度テーブル
  - `renderAll(logs)`: すべての統計を計算して一括レンダリング

## 更新ファイル

### admin/admin.html
- 「📊 学習データ分析（Analysis）」リンクを追加
- メニューに analysis.html へのリンクを追加

### admin/project_manager.html
- **反応時間プロファイル設定UIの変更**
  - プロファイル名を中立的な名称に変更:
    - `general` → `profileA`（速めの判定）
    - `slow` → `profileB`（標準）
    - `fast` → `profileC`（ゆっくり）
    - `custom` → `カスタム`
  - **ラベルの削除**:
    - 「ASD・境界知能などを想定」「ギフテッド想定」などの特性ラベルを完全に削除
    - 「速め／標準／ゆっくり」のみを表示（中立的な速度プロファイルとして扱う）
  - **構造の変更**:
    - `profile_name` → `preset` に変更
    - カスタム時のプロファイル名入力欄を削除
  - **プリセット値の更新**:
    - `profileA`: instant=2, deliberate=10
    - `profileB`: instant=3, deliberate=15
    - `profileC`: instant=6, deliberate=25

### src/core/config.js
- **timing_profile 構造の変更**
  - `profile_name` → `preset` に変更
  - デフォルト値を `preset: 'profileB'` に設定
- **後方互換性の実装**
  - 旧形式（`profile_name`）から新形式（`preset`）への自動変換を実装
    - `general/default` → `profileB`
    - `slow` → `profileC`
    - `fast` → `profileA`
    - その他 → `custom`
  - 旧データの読み込み時に自動的に変換
- **バリデーション強化**
  - 有効なpreset値（`profileA`, `profileB`, `profileC`, `custom`）のみを許可
  - 不正な値の場合は自動的に `profileB` に設定

### src/player/player.js
- **profile_name 参照の削除**
  - デフォルト値を `preset: 'profileB'` に変更
  - `profile_name` への参照をすべて削除

## データ構造

### quiz_log.json の想定形式
```json
{
  "version": "1.0",
  "generated_at": "2025-11-18T00:00:00.000Z",
  "logs": [
    {
      "questionId": "q_0",
      "timestamp": "2025-11-18T00:00:00.000Z",
      "clicks": [
        { "choiceId": "c1", "time": 1.2 },
        { "choiceId": "c2", "time": 3.5 }
      ],
      "final_answer": "c2",
      "correct": false,
      "response_time": 5.8,
      "path": ["c1", "c2"],
      "conceptTags": ["作業記憶"], // オプション（誤答の場合）
      "recommended_terms": ["短期記憶", "注意制御"] // オプション（誤答の場合）
    }
  ]
}
```

### project.json の timing_profile 構造（変更後）
```json
{
  "timing_profile": {
    "preset": "profileB",
    "instant_threshold": 3,
    "deliberate_threshold": 15
  }
}
```

**変更点**:
- `profile_name` → `preset` に変更
- preset の値: `"profileA"` / `"profileB"` / `"profileC"` / `"custom"` のみ
- 旧形式（`profile_name`）から新形式（`preset`）への自動変換を実装

## UI/UX の特徴

- **タブ切り替え**: 6つのセクションをタブで切り替え
- **統計カード**: 重要指標を一目で確認可能
- **グラフ可視化**: Chart.js による視覚的なデータ表示
- **テーブル表示**: 詳細データを表形式で確認可能
- **レスポンシブ**: モバイルでも利用可能なレイアウト

## 拡張性

- **conceptTag の対応**: 将来ログに tags や conceptTag が含まれる場合は、そのフィールドを使用するように拡張可能
- **Glossary 提示履歴**: ログに recommended_terms や glossary_terms が含まれる場合に自動的に集計
- **CSV/PDF 出力**: 将来的にエクスポート機能を追加可能なモジュール構造
- **AI 連携**: 教師が「この問題の典型的な誤答理由は？」とAIに聞けるように拡張可能な構造

## 思考の流体モデルへの接続

- 全ての集計データは数値配列でまとめており、思考の流体モデルに接続しやすい構造
- 思考タイプ（instant / searching / deliberate）の分類により、学習者の思考プロセスを可視化

## 個人情報の取り扱い

- 個人情報は扱わず、学習者IDはログのまま扱う（匿名前提）
- データはすべてクライアント側で処理（サーバー送信なし）

## 反応時間プロファイルのラベル排除・中立化

### 背景・目的
教育現場での倫理的配慮として、特定の特性（ASD、ギフテッドなど）を想起させるラベルを完全に排除し、反応時間の違いを「速度プロファイル」として中立的に扱う構造に変更しました。

### 変更内容
- **UI表示の変更**:
  - 「プロファイルA（速めの判定）」「プロファイルB（標準）」「プロファイルC（ゆっくり）」「カスタム」のみ表示
  - 「学習者の特性」や「認知ラベル」と誤解される単語を一切使用しない
- **データ構造の変更**:
  - `profile_name` → `preset` に変更
  - preset は「ラベル無しの中立名」のみ（`profileA` / `profileB` / `profileC` / `custom`）
- **後方互換性**:
  - 旧形式のデータを読み込んだ場合、自動的に新形式に変換
  - 既存のproject.jsonとの互換性を維持

### 倫理的配慮
- プロファイルはあくまで「反応時間のパラメータセット」として扱う
- 特性ラベルを表示・保存・入力させない構造を徹底
- 反応の速さは能力を示すものではなく、学習スタイルや思考パターンの違いとして扱う

## ダミーログデータ生成スクリプト

### 新規ファイル

#### scripts/generate_dummy_logs.py
- **目的**: analysis dashboard の検証用に、リアルな疑似データセットを生成
- **生成データ**: 50件のログエントリを含む `quiz_log_dummy.json`
- **生成されるパターン**:
  - **直感即答パターン**: path 1ステップ、response_time 0.5-2秒
  - **探索的思考パターン**: path 2-3ステップ、response_time 3-12秒
  - **熟慮パターン**: path 4ステップ、response_time 15-40秒
  - **誤答データ**: conceptTags（1-2個）、recommended_terms（1-3個）を付与
- **データ分布**:
  - 正答率: 約50%（23-27件程度）
  - 反応時間分類: instant 30%、searching 40%、deliberate 30%の分布
  - path長: 1-4ステップをランダムに生成
- **データ整合性**:
  - clicks と path の整合性を保持
  - response_time と最後の click 時間が一致
  - timestamp は過去30日以内に分散

#### scripts/generate_dummy_logs.js
- JavaScript版の生成スクリプト（ブラウザ環境でも利用可能）

#### scripts/verify_dummy_logs.py
- **目的**: 生成されたダミーログデータの整合性を検証
- **検証項目**:
  - 必須キーの存在確認
  - 正答・誤答の統計
  - conceptTags と recommended_terms の付与確認
  - 反応時間分類の分布確認
  - path長の分布確認
  - clicks と path の整合性チェック

#### data/quiz_log_dummy.json
- **生成されたダミーデータ**: 50件のログエントリ
- **使用目的**:
  - analysis.html のダッシュボード機能のテスト
  - グラフ描画や集計ロジックの検証
  - 反応時間プロファイルの preset A/B/C の挙動確認
- **データ特徴**:
  - すべての思考パターンが混在する「全部入りミックス」データ
  - リアルなデータ特性を再現（clicks と path の整合性、timestamp の分散など）

### 生成データの統計例
- 総ログ数: 50件
- 正答率: 約46-54%（ランダム生成のため変動あり）
- 反応時間分布:
  - instant (≤2秒): 約30%
  - searching (2-15秒): 約40%
  - deliberate (≥15秒): 約30%
- path長分布:
  - 1ステップ: 約34%（即答型）
  - 2ステップ: 約22%（概念混同）
  - 3ステップ: 約18%（迷い）
  - 4ステップ: 約26%（深い迷い）

## Analysis ダッシュボードのデータセット管理機能の実装

### 背景
分析ダッシュボードのデータ読み込み方式を改善し、手動ファイルアップロードからデータセット一覧表示方式へ移行。さらに、安定性と整合性を確保するため、index.json マスターファイル方式を採用。

### 実装の変遷

#### フェーズ1: /data フォルダからの自動一覧表示
- **src/admin/dataset_loader.js** を新規作成
  - `listDatasets()`: `/data/` 配下の JSON ファイル一覧を取得（directory listing を解析）
  - `loadDataset(filename)`: 指定されたファイルを読み込んで JSON を返す
- **admin/analysis.html** の更新
  - ファイルアップロード UI を削除
  - 「利用可能なデータセット一覧」パネルを追加
  - ファイル名クリックでデータをロード → 分析へ進む
- **src/admin/analysis.js** の更新
  - `analyze(logs)` 関数を追加（外部からログデータを受け取り、分析・描画を実行）

#### フェーズ2: /students フォルダの導入（階層構造）
- **フォルダ構造の作成**
  - `/students/` フォルダを作成
  - `/students/classes/` サブフォルダ（クラスデータ用）
  - `/students/individuals/` サブフォルダ（個人データ用）
  - 既存の `quiz_log_dummy.json` を `/students/classes/` に移動
- **dataset_loader.js の改修**
  - `/students/classes/` と `/students/individuals/` を再帰的にスキャン
  - 返り値: `{ classes: [{ name, path, dataset_name, type }], individuals: [...] }`
- **analysis.html の UI 変更**
  - クラス/個人の2段階表示（▼ クラスデータ、▼ 個人データ）
  - 新規データファイル作成UIを追加

#### フェーズ3: A方式への統一（フラット構造）
- **フォルダ構造の簡素化**
  - `/students/classes/` と `/students/individuals/` を削除
  - すべてのJSONファイルを `/students/` 直下に配置
- **dataset_loader.js の更新**
  - `/students/` 直下のみスキャン（再帰スキャン削除）
  - `type` で分類（`class` / `student`）
- **analysis.html の更新**
  - `type` で分類表示（dataset_name を表示）
  - ファイル名を `dataset_name + ".json"` に統一

#### フェーズ4: index.json マスターファイル方式の採用
- **students/index.json** を新規作成
  - マスターファイルとしてデータセット一覧を管理
  - 構造: `{ datasets: [{ file, dataset_name, type }, ...] }`
- **dataset_loader.js の全面リファクタ**
  - directory listing のコードを削除
  - `listDatasets()`: `/students/index.json` のみを読み込み
  - `loadDataset(dataset)`: データセット情報オブジェクトを受け取り、ファイルを読み込む
  - `updateIndexJson(fileName, datasetName, type)`: 新規データセット作成時に index.json を自動更新
- **analysis.html の更新**
  - index.json の結果を受け取り、`type` で分類表示
  - 新規データセット作成時に index.json を自動更新
- **既存データの移行**
  - `quiz_log_dummy.json` を新形式に変換（`dataset_name`, `type`, `created_at` を含む）
  - index.json に登録

#### フェーズ5: index.json 自動生成機能
- **students/generate_index.js** を新規作成
  - `parseDirectoryListing(html)`: HTML の directory listing を解析
  - `loadDatasetInfo(fileName)`: 各JSONファイルを読み込んで `dataset_name` と `type` を取得
    - `dataset_name` が未定義 → ファイル名（拡張子除く）を使用
    - `type` が未定義 → "class" をデフォルト
    - ファイル名から `type` を推測（`student` や `個人` を含む場合は "student"）
  - `generateIndex()`: index.json を生成
  - `main()`: 外部から呼び出すためのメイン関数（index.json を生成してダウンロード）
- **analysis.html の更新**
  - 「🔄 index.json を再生成」ボタンを追加
  - `regenerateIndex()` 関数を実装（GenerateIndex.main() を実行）
  - 成功時に一覧を自動再読み込み（3秒後）

### データセットファイルの標準フォーマット（最終形）
```json
{
  "dataset_name": "classA_2025",
  "type": "class",
  "created_at": "2025-11-18",
  "logs": [
    {
      "questionId": "q_0",
      "timestamp": "2025-11-18T00:00:00.000Z",
      "clicks": [{ "choiceId": "c1", "time": 1.2 }],
      "final_answer": "c2",
      "correct": false,
      "response_time": 5.8,
      "path": ["c1", "c2"],
      "conceptTags": ["作業記憶"],
      "recommended_terms": ["短期記憶", "注意制御"]
    }
  ]
}
```

### students/index.json の構造
```json
{
  "datasets": [
    {
      "file": "quiz_log_dummy.json",
      "dataset_name": "quiz_log_dummy",
      "type": "class"
    },
    {
      "file": "classA_2025.json",
      "dataset_name": "classA_2025",
      "type": "class"
    },
    {
      "file": "student001.json",
      "dataset_name": "student001",
      "type": "student"
    }
  ]
}
```

### 主な改善点
1. **安定性の向上**: Live Server の directory listing に依存しない index.json 方式
2. **整合性の保証**: index.json が一元管理し、UI とデータの整合性を自動的に保つ
3. **自動化**: 新規データセット作成時に index.json を自動更新
4. **再生成機能**: フォルダ内のすべてのJSONファイルから index.json を自動生成可能
5. **手動更新不要**: 自動生成機能により、手動での index.json 編集が不要

### 新規ファイル

#### src/admin/dataset_loader.js
- **index.json 方式に統一**:
  - `listDatasets()`: `/students/index.json` を読み込み、`datasets` 配列を返す
  - `loadDataset(dataset)`: データセット情報オブジェクトを受け取り、`dataset.file` を使用してファイルを読み込む
  - `updateIndexJson(fileName, datasetName, type)`: 新規データセット作成時に index.json を更新（ダウンロード形式）
  - `createNewDataset(datasetName, type)`: 新しいデータセットオブジェクトを作成

#### students/generate_index.js
- **index.json 自動生成機能**:
  - `/students/` フォルダ内のすべての `.json` ファイルをスキャン
  - 各ファイルから `dataset_name` と `type` を取得
  - `index.json` を生成してダウンロード
  - エラーハンドリング: 個別ファイルのエラーでも処理を継続

#### students/index.json
- **マスターファイル**: データセット一覧を管理
- 初期状態で `quiz_log_dummy.json` を登録済み

### 更新ファイル

#### admin/analysis.html
- **UI の改善**:
  - ファイルアップロード UI を削除
  - データセット一覧表示（クラス/個人の2段階表示）
  - 選択中のデータセット情報を表示（データセット名、タイプ、ログ数、作成日時）
  - 新規データファイル作成UI（タイプ選択、自動で index.json を更新）
  - 「🔄 index.json を再生成」ボタン（フォルダ内の全JSONファイルから自動生成）
- **データ読み込み処理**:
  - `loadDatasetList()`: index.json から一覧を取得し、`type` で分類表示
  - `loadAndAnalyze(dataset)`: データセット情報オブジェクトを受け取り、ファイルを読み込んで分析
  - `createNewDatasetFile()`: 新規データセット作成時に index.json も自動更新
  - `regenerateIndex()`: index.json を再生成してダウンロード

#### src/admin/analysis.js
- **`analyze(logs)` 関数を追加**:
  - 外部からログデータを受け取り、分析・描画を実行
  - `renderAll(logs)` のラッパー関数として実装

### データ移行スクリプト

#### scripts/migrate_to_flat_structure.py
- **目的**: 既存の quiz_log.json ファイルを新しいフォーマットに変換
- **機能**:
  - `/students/` フォルダ内のすべての JSON ファイルを処理
  - 旧形式（`version`, `generated_at`, `logs`）から新形式（`dataset_name`, `type`, `created_at`, `logs`）へ変換
  - `dataset_name` と `type` を推測（ファイル名から）
  - 新形式に変換してファイルを上書き

## Julia バックエンド分析機能の実装

### 背景・目的
学習データの詳細分析をJuliaスクリプトで実行できる機能を追加。既存のJavaScriptベースの分析に加え、より高度な統計分析や可視化をバックグラウンドで実行できるようにする。

### 実装内容

#### admin/analysis.html の更新
- **「📊 分析実行」タブを追加**
  - 既存のタブメニュー（全体概要、問題別分析、概念混同分析、反応時間プロファイル、迷いパターン分析、Glossary 提示履歴）に新規タブを追加
  - タブ切り替え時に学生ファイル一覧を自動読み込み
- **分析実行タブのUI**
  - 生徒データファイル選択ドロップダウン（`<select id="analysis-student-file">`）
  - 分析実行ボタン（`<button id="run-analysis-btn">`）
  - 分析完了バナー（緑色、Google Drive型の通知スタイル）
  - 結果表示エリア（JSON形式で結果を表示）
- **CSSスタイルの追加**
  - `.analysis-btn`: 分析ボタンのスタイル（青色、ホバー効果付き）
  - `#analysis-banner`: 分析完了バナーのスタイル（緑色背景、中央揃え）
  - `#analysis-result-area`: 結果表示エリアのスタイル（ダークテーマのJSON表示）

#### src/admin/analysis.js の更新
- **`loadStudentListForAnalysis()` 関数**
  - `/api/student-files` エンドポイントから学生ファイル一覧を取得
  - `students/` フォルダ内の `.json` ファイル（`index.json` を除く）を読み込み
  - ドロップダウンに選択肢として追加
- **分析実行機能**
  - `/api/run-analysis?file=xxx.json` へGETリクエスト
  - ローディング表示（ボタンを無効化し「分析中...」と表示）
  - 分析結果を `window.latestAnalysisResult` に保存
  - エラーハンドリング（分析失敗時にアラート表示）
- **結果表示機能**
  - 「結果を見る」クリックで JSON 結果を整形表示
  - スムーズスクロールで結果エリアまで移動
- **タブ切り替え時の初期化**
  - 分析実行タブが選択されたときに自動的に学生ファイル一覧を読み込み

#### server.js の更新
- **`/api/student-files` エンドポイント（GET）**
  - `students/` フォルダ内の `.json` ファイル一覧を返す
  - `index.json` は除外
  - エラーハンドリング（フォルダが存在しない場合は空配列を返す）
- **`/api/run-analysis` エンドポイント（GET）**
  - クエリパラメータ `file` からファイル名を取得
  - `julia analysis/run_analysis.jl students/{file}` コマンドを実行
  - タイムアウト15秒
  - Juliaスクリプトの標準出力をJSONとしてパースして返す
  - エラーハンドリング（実行エラー・JSONパースエラーに対応）

#### analysis/run_analysis.jl（新規作成）
- **Juliaスクリプトによる分析処理**
  - `JSON` と `Statistics` パッケージを使用
  - コマンドライン引数からファイル名を取得
  - JSONファイルを読み込み
- **計算する統計項目**
  - `totalAnswers`: 総回答数
  - `correctCount`: 正答数
  - `correctRate`: 正答率（%）
  - `avgResponseTime`: 平均反応時間（秒）
  - `uniqueConcepts`: ユニークな概念タグ数
- **データ構造の対応**
  - `logs` 配列がある場合は各統計を計算
  - `logs` がない場合はフォールバック（データ構造の情報を返す）
- **出力形式**
  - JSON形式で標準出力に出力（サーバーがパースしてクライアントへ返す）

### 動作フロー

1. **タブ選択**: ユーザーが「📊 分析実行」タブをクリック
   → `loadStudentListForAnalysis()` が呼ばれ、`/api/student-files` からファイル一覧を取得

2. **ファイル選択**: ユーザーが学生ファイルをドロップダウンから選択

3. **分析実行**: 「📊 このデータを分析する」ボタンをクリック
   → `/api/run-analysis?file=xxx.json` へGETリクエスト
   → ボタンが「分析中...」と表示され、無効化

4. **Julia実行**: サーバーが `julia analysis/run_analysis.jl students/xxx.json` を実行
   → JuliaスクリプトがJSONファイルを読み込み、統計を計算
   → 結果をJSON形式で標準出力

5. **結果取得**: サーバーがJuliaの出力をJSONとしてパース
   → クライアントへJSONレスポンスを返す

6. **バナー表示**: 分析完了バナーが表示される
   → `window.latestAnalysisResult` に結果を保存

7. **結果表示**: ユーザーが「結果を見る」をクリック
   → JSON結果が整形されて `analysis-result-area` に表示
   → スムーズスクロールで結果エリアまで移動

### 新規ファイル

#### analysis/run_analysis.jl
- Juliaスクリプトによる学習データ分析
- JSONファイルの読み込みと統計計算
- 結果をJSON形式で出力

### 更新ファイル

#### admin/analysis.html
- タブメニューに「📊 分析実行」ボタンを追加
- 分析実行タブのコンテンツを追加（ファイル選択、実行ボタン、バナー、結果表示エリア）
- CSSに分析ボタンとバナーのスタイルを追加

#### src/admin/analysis.js
- `loadStudentListForAnalysis()` 関数を追加（学生ファイル一覧の読み込み）
- 分析実行ボタンのイベントハンドラを追加
- 結果表示機能を追加
- タブ切り替え時の初期化処理を追加

#### server.js
- `/api/student-files` エンドポイントを追加
- `/api/run-analysis` エンドポイントを追加（Juliaスクリプトの実行）

### 技術的な特徴

1. **バックグラウンド実行**: Juliaスクリプトはバックグラウンドで実行され、ユーザーは他のタブで作業を続けられる
2. **非同期処理**: 分析実行中もUIはブロックされず、ローディング表示で状態を通知
3. **エラーハンドリング**: Julia実行エラーやJSONパースエラーに対応
4. **既存機能との統合**: 既存のタブ切り替え機能と統合され、干渉しない

### 主な改善点

1. **拡張性**: Juliaスクリプトを自由に書き換えることで、より高度な分析が可能
2. **柔軟性**: データ構造に応じて柔軟に対応（`logs` 配列の有無をチェック）
3. **ユーザビリティ**: 分析完了をバナーで通知し、結果をワンクリックで表示
4. **安全性**: タイムアウト設定により、長時間実行されるスクリプトから保護

## Julia 詳細分析の fetch パス修正・静的ファイル対応

### 背景・目的
Julia 詳細分析タブが VSCode Live Server 上で 404 エラーを発生していた問題を解決。静的ファイルサーバー（GET のみ対応）に対応するため、サーバー側 API を使用せず、直接ファイル読み込み方式に統一。

### 実装内容

#### src/admin/analysis.js の更新
- **`/api/run-analysis` へのリクエストを削除**
  - 以前: `fetch('/api/run-analysis?file=...')` を使用
  - 変更後: `DatasetLoader.loadDataset()` を使用して直接 JSON ファイルを読み込み
- **`runJuliaAnalysis()` 関数を追加**
  - クライアント側で簡易分析を実行する関数を実装
  - 取得した JSON データをそのまま分析に渡す形式に変更
  - 基本的な統計（総回答数、正答数、正答率、平均反応時間、ユニーク概念数）を計算
- **分析実行処理の変更**
  - ファイル名をクエリパラメータとして送信する方式から、直接ファイル読み込み方式へ変更
  - 他のタブ（全体概要、問題別分析など）と同じデータ読み込み方式に統一

#### server.js の更新（参考）
- `/api/run-analysis` エンドポイントは残存しているが、Julia詳細分析タブでは使用しない
- 静的ファイルサーバー環境でも動作するように、クライアント側で直接ファイルを読み込む方式に変更

### 動作フロー（修正後）

1. ユーザーが「📊 このデータを分析する」ボタンをクリック
2. `DatasetLoader.loadDataset(selectedDataset)` で `../students/${folder}/${file}.json` を直接 fetch（GETリクエスト）
3. 取得した JSON データを `runJuliaAnalysis()` に渡す
4. クライアント側で簡易分析を実行
5. 結果を表示

### 主な改善点

1. **静的ファイルサーバー対応**: VSCode Live Server などの静的ファイルサーバーでも動作
2. **一貫性の向上**: 他の分析タブと同じデータ読み込み方式を使用
3. **405エラーの解消**: POST/PUT/DELETE を使用せず、GET のみで動作
4. **シンプルな実装**: サーバー側APIに依存しないシンプルな実装

## 学術レポート形式UIへの変換

### 背景・目的
Julia 詳細分析の結果表示を、JSON の生表示から学術レポート形式の読みやすい UI に変換。教師が結果を一目で理解できるように、セクションごとに整理されたレポート形式で表示。

### 実装内容

#### admin/analysis.html の更新
- **CSSスタイルの追加**
  - `.report-card`: レポートカードのスタイル（白背景、影、左端のアクセント）
  - `.report-number`: 大きく見やすい数値表示（1.8rem、太字、色指定）
  - `.report-stats`: 統計情報のグリッドレイアウト
  - `.report-stat-item`: 個別の統計項目
  - `.report-comment`: コメント欄（緑の左ボーダー）
  - `.report-notes`: 注意事項（黄色背景、枠付き）

#### src/admin/analysis.js の更新
- **`renderAnalysisReport()` 関数を追加**
  - JSONデータを学術レポート形式のHTMLに変換する関数
  - **正答率セクション**: 総回答数、正答数、正答率をグリッド表示。正答率に応じた自動コメント生成（80%以上: 優秀、60-80%: 良好、40-60%: 基礎理解不足、40%未満: 集中的支援必要）
  - **反応時間セクション**: 平均反応時間を大きく表示（オレンジ）。反応時間に応じた自動コメント生成（3秒未満: 素早い反応、3-10秒: 適切、10-20秒: やや時間がかかる、20秒以上: 時間がかかる）
  - **概念使用セクション**: uniqueConcepts を中央寄せで表示（紫）。概念数に応じた自動コメント生成（0: 記録なし、1-2: 限定的、3-9: 適切、10以上: 広範囲）
  - **Notesセクション**: `result.message` を黄色の枠付きボックスで表示
- **結果表示処理の変更**
  - JSONの生表示（`<pre>`）を削除
  - `renderAnalysisReport()` を使用してレポート形式で表示

### 表示内容

- **正答率分析**: 総回答数、正答数、正答率を並べて表示。正答率に応じたコメント付き
- **反応時間分析**: 平均反応時間を大きく表示。反応時間に応じたコメント付き
- **概念使用分析**: ユニークな概念数を大きく表示。概念数に応じたコメント付き
- **注意事項**: `result.message` がある場合は黄色のボックスで表示

### 主な改善点

1. **可読性の向上**: JSONの生表示から、セクションごとに整理されたレポート形式へ
2. **自動コメント生成**: データに応じて適切なコメントを自動生成
3. **視覚的な強調**: 重要な数値を大きく、色付きで表示
4. **学術的フォーマット**: レポート形式で印刷や共有にも適した表示

## 反応時間分布フィッティング（指数分布・正規分布）の実装

### 背景・目的
反応時間の分布を指数分布と正規分布にフィッティングし、Juliaで分析してWebダッシュボードに結果とグラフを表示する機能を実装。学習者の反応時間パターンを統計的に分析し、可視化する。

### 実装内容

#### analysis/reaction_time.jl の更新
- **分布曲線をプロットに追加**
  - ヒストグラムに指数分布と正規分布の曲線を重ねて表示
  - 指数分布: 赤色の線（λ パラメータを表示）
  - 正規分布: 青色の線（μ, σ パラメータを表示）
  - 凡例を追加して分布を識別可能に
- **グラフファイル名の変更**
  - `rt_plot.png` → `rt_fit.png` に変更
  - タイトルを「反応時間の分布（指数分布・正規分布フィッティング）」に更新
- **結果JSONの更新**
  - `graph: "rt_fit.png"` フィールドを追加

#### src/admin/analysis.js の更新
- **`runJuliaAnalysis()` 関数の拡張**
  - 反応時間の分布フィッティングをクライアント側で計算
  - **指数分布パラメータ**: λ = 1 / mean（最尤推定）
  - **正規分布パラメータ**: μ = mean, σ = std（最尤推定）
  - 基本統計量（平均、中央値、標準偏差、最小値、最大値）も計算
- **`runServerSideJuliaAnalysis()` 関数を追加**
  - サーバー側のJulia分析エンドポイント (`/analyze/reaction-time`) を呼び出す関数
  - エラー時はクライアント側の結果を返す（フォールバック）
  - Julia分析の結果（グラフを含む）をクライアント側の結果に統合
- **`renderAnalysisReport()` 関数の拡張**
  - **反応時間分布フィッティングセクションを追加**
    - 指数分布パラメータ λ を大きく表示（ピンク色）
    - 正規分布平均 μ を大きく表示（青色）
    - 正規分布標準偏差 σ を大きく表示（緑色）
    - パラメータの説明コメントを追加
    - グラフがあれば `<img>` タグで表示（Base64エンコードされた画像またはファイルパス）
    - グラフがない場合は警告メッセージを表示

#### admin/analysis.html の更新
- **CSSスタイルの追加**
  - `.report-rt-block`: 反応時間フィッティングブロック用スタイル
  - `.report-rt-block .report-number`: 数値表示のスタイル（1.8rem、太字、色指定）

### 動作フロー

1. **クライアント側での簡易分析**: 反応時間の基本統計と分布フィッティングパラメータ（λ, μ, σ）を計算
2. **サーバー側Julia分析（オプション）**: サーバー側APIが利用可能な場合、Juliaスクリプトを実行してグラフを生成
3. **結果の統合**: Julia分析の結果（グラフ含む）をクライアント側の結果に統合
4. **レポート表示**: 学術レポート形式で λ, μ, σ とグラフを表示

### 技術的な特徴

1. **二段階の分析**: クライアント側で基本的な分析を即座に実行し、サーバー側で高度な分析を実行（フォールバック対応）
2. **分布フィッティング**: 指数分布と正規分布の両方にフィッティングし、パラメータを推定
3. **可視化**: Juliaで生成されたグラフ（ヒストグラム + 分布曲線）をWebダッシュボードに表示
4. **学術的フォーマット**: パラメータを大きく、色付きで表示し、説明コメントを追加

### 主な改善点

1. **統計分析の高度化**: 単純な平均値だけでなく、分布形状を分析
2. **可視化の追加**: ヒストグラムとフィッティング曲線を組み合わせたグラフ表示
3. **ユーザビリティ**: パラメータを学術レポート形式で見やすく表示
4. **柔軟性**: サーバー側APIが利用できない場合でも、クライアント側で基本的な分析を実行可能

## 反応時間フィッティング分析UIの追加（クライアント側実装）

### 背景・目的
反応時間データから指数分布（λ）と正規分布（μ, σ）のパラメータを算出し、Chart.jsで可視化する機能を追加。文系の教師でも理解しやすい自然言語解釈を自動生成し、学習者の反応時間パターンを分析できるようにする。

### 実装内容

#### admin/analysis.html の更新
- **新しいセクションを追加**
  - `rt-fitting-section` セクションを追加（ダッシュボードの下に配置）
  - 初期状態は非表示（`display:none`）、データ読み込み時に自動表示
  - 結果表示エリア（`rt-fitting-result`）とグラフ用のcanvas（`rt-fitting-chart`）を追加
- **CSSスタイルの追加**
  - `.analysis-section`: セクション全体のスタイル（パディング16px、背景#fafafa、ボーダー）
  - `.analysis-result`: 結果表示エリアのスタイル（フォントサイズ1.1em、行間1.6、背景白、左側に青のアクセント線）
  - `#rt-fitting-chart`: グラフの最大高さを400pxに設定

#### src/admin/analysis.js の更新
- **`runRTFitting()` 関数を追加**
  - 反応時間データの前処理（0やnull、無限大を除外）
  - **指数分布のλを計算**: λ = 1 / 平均値（最尤推定）
  - **正規分布のμ（平均）・σ（標準偏差）を計算**: μ = 平均値、σ = 標準偏差（最尤推定）
  - Chart.jsでヒストグラム（20ビン）+ フィット曲線を描画
    - 観測データ: 紫色のバーグラフ
    - 指数分布フィット: 赤色の線グラフ（λパラメータを凡例に表示）
    - 正規分布フィット: 青色の線グラフ（μ, σパラメータを凡例に表示）
  - `interpretRT()`で自然言語解釈を生成
  - 結果を`#rt-fitting-result`に表示（パラメータ値と解釈を表示）
- **`interpretRT()` 関数を追加**
  - **λの解釈**: 
    - λ > 0.25: 「反応が速く、直感的に判断する傾向があります。」
    - 0.1 < λ ≤ 0.25: 「やや慎重で、確認を挟んでから回答するタイプです。」
    - λ ≤ 0.1: 「非常に慎重で、じっくり考えてから回答します。」
  - **μの解釈**:
    - μ < 5: 「全体的に判断が速い学習者です。」
    - 5 ≤ μ < 10: 「平均的な判断スピードです。」
    - μ ≥ 10: 「丁寧に読み、確認してから回答する学習スタイルです。」
  - **σの解釈**:
    - σ < 2: 「思考スピードは安定しています。」
    - 2 ≤ σ < 5: 「問題によって迷いやすさに少し差が見られます。」
    - σ ≥ 5: 「理解のムラが大きく、つまずき概念が存在する可能性があります。」
- **`renderAll()` 関数の更新**
  - 分析完了後に反応時間データを抽出し、`runRTFitting()`を呼び出すように追加
  - 有効な反応時間データ（> 0かつnullでない）が存在する場合のみ実行

### 動作フロー

1. **データ読み込み**: `quiz_log_dummy.json` が読み込まれる
2. **分析実行**: `renderAll()` が呼ばれ、すべての統計が計算される
3. **反応時間抽出**: ログから `response_time` を抽出し、有効な値のみをフィルタリング（0やnull、無限大を除外）
4. **フィッティング実行**: `runRTFitting()` が呼ばれ、λ, μ, σ を計算
   - 平均値からλを計算（λ = 1 / mean）
   - 平均値と標準偏差からμ, σを計算（μ = mean, σ = std）
5. **解釈生成**: `interpretRT()`でパラメータ値に基づいて自然言語解釈を生成
6. **表示**: 
   - パラメータ値（λ, μ, σ）と解釈コメントを`#rt-fitting-result`に表示
   - Chart.jsで混合チャート（bar + line）を描画
     - ヒストグラム（20ビン）を紫色のバーで表示
     - 指数分布フィット曲線を赤色の線で表示
     - 正規分布フィット曲線を青色の線で表示
7. **セクション表示**: `rt-fitting-section` を `display: block` に変更して表示

### 技術的な特徴

1. **クライアント側での完結**: サーバー側APIに依存せず、ブラウザ内で完結する分析
2. **混合チャート**: Chart.jsの混合チャート機能（bar + line）を使用して、ヒストグラムとフィット曲線を同時に表示
3. **自然言語解釈**: 統計パラメータを教師が理解しやすい自然言語に変換
4. **自動表示**: データ読み込み時に自動的に分析・表示される（手動操作不要）

### 主な改善点

1. **可視化の強化**: ヒストグラムにフィット曲線を重ねて表示することで、データの分布形状を視覚的に理解できる
2. **教師向けの解釈**: 統計パラメータ（λ, μ, σ）をそのまま表示するだけでなく、学習者の特徴を自然言語で説明
3. **統合されたUI**: 既存のダッシュボードに統合され、他の分析結果と一緒に表示される
4. **リアルタイム分析**: データ読み込み後、即座に分析結果が表示される

### 表示内容

- **パラメータ表示**: 
  - 指数分布 λ の値（6桁小数点まで表示）
  - 正規分布 μ（平均）の値（3桁小数点まで表示）
  - 正規分布 σ（標準偏差）の値（3桁小数点まで表示）
- **自然言語解釈**: λ, μ, σの値に基づいて生成された3つの解釈コメント
- **グラフ**: 
  - 横軸: 反応時間（秒）
  - 縦軸: 頻度
  - 観測データのヒストグラム（紫色のバー）
  - 指数分布フィット曲線（赤色の線）
  - 正規分布フィット曲線（青色の線）
  - 凡例とタイトルを表示

## 備考 / 今後のタスク

- quiz_log.json に recommended_terms を保存する機能が実装された場合、自動的に Glossary 提示履歴が表示される
- conceptTag がログに含まれるようになった場合、より正確な概念混同分析が可能
- CSV 出力や PDF 出力機能の追加（将来的に）
- リアルタイムダッシュボード機能（将来的に）
- 複数のログファイルの比較分析機能（将来的に）
- index.json の自動更新をサーバー側で実装する場合の検討（現在はダウンロード形式）
- Julia分析スクリプトの拡張（より高度な統計分析、可視化の追加）
- Julia分析結果の可視化（グラフやチャートの生成）

