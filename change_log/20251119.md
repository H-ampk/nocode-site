# 2025-11-19 Glossary Loader テストUIの教育者向けカードUI改善

## 概要
Glossary Loader テストページ（`admin/glossary_test.html`）の全セクションを、文系の教員でも見やすいカードUI形式に改善しました。JSONのraw表示を排除し、視覚的に理解しやすいレイアウトに統一しました。

## 改善対象セクション

### 1. プロジェクトGlossary読み込みテスト
### 2. ドメインGlossary読み込みテスト
### 3. グローバルGlossary読み込みテスト
### 4. マージテスト
### 5. Policy ベース読み込みテスト

## 実装内容

### HTML構造の改善

#### 共通の変更
- JSONのraw表示（`<pre>`タグ）を削除
- 各セクションに結果表示用の`<div id="*ResultArea"></div>`を追加
- コントロール部分を`<div class="controls">`で統一
- ボタンのIDを統一（`loadProjectBtn`, `loadDomainBtn`, `loadGlobalBtn`, `runMergeBtn`, `runPolicyBtn`）

#### セクション別の変更

**1. プロジェクトGlossary読み込みテスト**
- `<div id="resultArea"></div>`を追加
- プロジェクトID入力欄のIDを`projectIdInput`に統一

**2. ドメインGlossary読み込みテスト**
- `<div id="domainResultArea"></div>`を追加
- セレクトボックスのIDを`domainSelect`に変更

**3. グローバルGlossary読み込みテスト**
- `<div id="globalResultArea"></div>`を追加

**4. マージテスト**
- `<div id="mergeResultArea"></div>`を追加

**5. Policy ベース読み込みテスト**
- `<div id="policyInfo"></div>`を追加（Policy設定表示用）
- `<div id="policyResultArea"></div>`を追加（結果表示用）
- `fieldset`を削除し、`<div class="controls">`に統一

### CSSの追加（ライトテーマ）

#### 共通スタイル
- **背景色**: `#f5f5f5`（柔らかいグレー）
- **カード背景**: `#ffffff`（白）
- **アクセントカラー**: `#4a90e2`（青）
- **フォント**: `'Segoe UI', Tahoma, Geneva, Verdana, sans-serif`

#### カードUIスタイル

**用語カード（`.glossary-card`, `.global-term-card`, `.term-card`）**
- 白背景のカード
- 左側に青いアクセントボーダー（4px）
- 角丸（8px）とシャドウ
- パディング15px

**ドメイン概要カード（`.domain-summary-card`）**
- 青いボーダー（2px）で強調
- 角丸（10px）とシャドウ

**Policy設定カード（`.policy-card`）**
- 紫系の左ボーダー（`#6a5acd`）で区別
- 角丸（10px）とシャドウ

**タグ・キーワードスタイル（`.tag`, `.keyword`, `.field-tag`, `.keyword-tag`）**
- 青系の背景色（`#eef7ff`）
- 青いボーダー（`#bcd7ff`）
- 角丸（8px-12px）
- 横並び表示

**例のボックス（`.example-box`）**
- グレー背景（`#fafafa`）
- 左側にグレーのボーダー（3px）
- 視認性を向上

**セクションタイトル（`.merge-section-title`）**
- 大きな見出しスタイル（1.3rem）
- セクション間の区切りを明確化

**その他エントリーカード（`.other-entry-card`）**
- グレー系のボーダーで区別
- JSON表示用の`<pre>`タグを含む
- 最小限のJSON表示に限定

### JavaScriptの更新

#### 共通関数

**`escapeHtml(text)`**
- XSS対策としてHTMLエスケープを実装
- すべてのユーザー入力に適用

#### セクション別のレンダリング関数

**1. `renderGlossaryCards(glossaryObj)`**
- プロジェクトGlossary用のカードUIレンダリング
- 用語名・ID・定義・タグを表示
- 空の場合は適切なメッセージを表示

**2. `renderDomainGlossary(domainGlossary)`**
- ドメインGlossary用のカードUIレンダリング
- **ドメイン概要**: `domain_definition`を大きなカードで表示
- **キーワード**: `keywords`配列をタグ風に表示
- **用語一覧**: `terms`オブジェクトの各用語をカード化
  - 用語名・ID・定義・ドメイン定義・例・補足を表示

**3. `renderGlobalGlossary(globalGlossary)`**
- グローバルGlossary用のカードUIレンダリング
- 用語名・ID・定義・分野（`fields`）・リンク（`links`）・例（`example`）を表示
- `fields`はタグ風に横並び表示
- `links`は外部リンクとして表示
- `example`は囲み枠で強調表示

**4. `renderMergeResult(merged)`**
- マージ結果用のカードUIレンダリング
- **1) termsセクション**: 統合済み用語一覧をカードUIで表示
  - Global/Domain/Projectと同じカードデザイン
  - 用語名・ID・定義・ドメイン定義・補足・分野・リンク・例を表示
- **2) keywordsセクション**: 統合キーワードをタグ表示
  - 配列・オブジェクトの両形式に対応
- **3) その他の単独項目**: `terms`と`keywords`以外のプロパティを別カードとして表示
  - JSON形式で最小限の表示

**5. `renderPolicyInfo(policy)` / `renderPolicyResult(result)`**
- Policy設定用のカードUIレンダリング
- **Policy設定カード**: Mode、Domains、Policy JSONを表示
- **Policy適用後のGlossary**: 用語カードUIで表示
  - 用語名・ID・定義・ドメイン定義・補足・タグ・リンク・例を表示
  - `terms`オブジェクトと直接オブジェクトの両形式に対応

#### ボタンイベントの更新

すべてのセクションで、ボタンクリック時に：
1. 読み込み中メッセージを表示
2. GlossaryLoaderからデータを取得
3. 対応するレンダリング関数を呼び出し
4. エラーハンドリングを実装

## データ構造の対応

### 柔軟なデータ構造対応
- `terms`配列形式と`terms`オブジェクト形式の両方に対応
- `tags`と`fields`の両方に対応（`term.tags || term.fields`）
- `domain_definition`、`note`、`example`などのオプションフィールドに対応
- 空のGlossaryやエラー時の適切なメッセージ表示

### セキュリティ対策
- すべてのユーザー入力に`escapeHtml()`を適用
- 外部リンクに`target="_blank"`と`rel="noopener noreferrer"`を追加

## UI/UXの特徴

### 視覚的な階層構造
- **Policy設定カード → 結果カード**の順で表示し、因果関係を明確化
- セクションタイトルで大きな区切りを表示
- カード内で用語名・定義・補足情報を階層的に表示

### 統一感のあるデザイン
- すべてのセクションで同じカードデザインを使用
- ライトテーマで統一（背景`#f5f5f5`、カード`#ffffff`）
- アクセントカラーで視覚的な区別（青・紫・グレー）

### 文系教員向けの配慮
- JSONのraw表示を最小限に（Policy設定内のみ）
- タグ・キーワードを視覚的に分かりやすく表示
- 用語の定義・例・補足を明確に分離
- 自然言語での説明を重視

## 主な改善点

### 1. 可読性の向上
- JSONのraw表示から、セクションごとに整理されたカードUIへ
- 用語名・定義・タグを視覚的に分離
- 重要な情報を大きく、色付きで表示

### 2. 統一性の確保
- すべてのセクションで同じカードデザインを使用
- コントロール部分のレイアウトを統一
- エラーメッセージの表示形式を統一

### 3. 柔軟性の向上
- データ構造の混合に対応（配列・オブジェクトの両形式）
- オプションフィールドの有無に対応
- 空のGlossaryやエラー時の適切な処理

### 4. セキュリティの強化
- XSS対策として`escapeHtml()`を実装
- 外部リンクのセキュリティ対策

## 更新ファイル

### admin/glossary_test.html
- HTML構造の改善（JSON表示の削除、カード表示用のdiv追加）
- CSSの追加（ライトテーマ、カードUIスタイル）
- JavaScriptの更新（レンダリング関数の実装、ボタンイベントの変更）

## 技術的な特徴

### クライアント側での完結
- サーバー側APIに依存せず、ブラウザ内で完結するUI改善
- GlossaryLoaderの既存機能を活用

### モジュール化されたレンダリング
- 各セクションごとに独立したレンダリング関数を実装
- 再利用可能な構造

### エラーハンドリング
- データ読み込みエラー時の適切なメッセージ表示
- 空のGlossaryや不正なデータ構造への対応

## 備考 / 今後のタスク

- 検索バー・タグフィルタ機能の追加（将来的に）
- 用語カードの折りたたみ機能（将来的に）
- 用語の並び替え機能（将来的に）
- エクスポート機能（CSV/PDF形式、将来的に）
- レスポンシブデザインのさらなる改善（モバイル対応の強化）

---

# 診断クイズ・通常クイズのスコアリングUI改善

## 概要
診断クイズと通常クイズの作成画面に、文系教師向けのベクトル設定UIを実装しました。JSONの直接編集を排除し、Glossaryから評価軸を自動取得して、ラジオボタンで直感的に設定できるUIに改善しました。

## 改善対象

### 1. 診断クイズのスコアリングUI
### 2. 通常クイズの理解分析（ベクトル設定）UI

## 実装内容

### 診断クイズのスコアリングUI改善

#### HTML構造の変更
- JSONのraw表示（`<textarea>`）を削除
- 各選択肢ごとに評価軸UIを表示する構造に変更
- JSON詳細表示を折りたたみ可能な形式で追加

#### JavaScriptの実装

**Glossary読み込み機能**
- `loadGlossaryForScoring()`: Glossaryを読み込み、キャッシュ
  - プロジェクトGlossaryとグローバルGlossaryを統合
  - キャッシュ機能でパフォーマンス向上

**評価軸UIレンダリング**
- `renderDiagnosticScoringList()`: スコアリングUIを描画
  - 各選択肢ごとに評価軸UIを表示
  - Glossaryから評価軸を自動取得
- `renderAxisUI()`: 評価軸UIを描画
  - Glossaryの各用語を評価軸として表示
  - 用語名・ID・定義を表示
  - -1/0/+1のラジオボタンを配置

**スコア更新機能**
- `updateAxisScore()`: 評価軸のスコアを更新
  - ラジオボタンの選択に応じてJSONを自動生成
  - 0の場合は削除（影響なし）
  - 空のvectorの場合はルールを削除
- `updateScoringJson()`: JSON詳細表示を更新

**選択肢変更時の対応**
- 選択肢追加・削除・変更時にスコアリングUIを自動再描画
- 選択肢削除時にスコアリングルールも自動削除

### 通常クイズの理解分析（ベクトル設定）UI統合

#### HTML構造の追加
- 正誤判定とデザイン設定の間に「理解分析（ベクトル設定）」セクションを追加
- 各選択肢ごとに評価軸UIを表示
- JSONは詳細表示のみ（折りたたみ可能）

#### JavaScriptの実装

**ベクトル設定UIの表示**
- `renderVectorSettingsForQuestion()`: 通常クイズ用のベクトル設定UIを表示
  - Glossaryから評価軸を自動取得
  - 各選択肢ごとに評価軸UIを生成
  - 既存のベクトル設定を復元

**評価軸UIの描画**
- `renderVectorAxisUI()`: 評価軸UIを描画
  - Glossaryの各用語を評価軸として表示
  - 用語名・ID・定義を表示
  - -1/0/+1のラジオボタンを配置

**スコア更新機能**
- `updateVectorAxisScore()`: 評価軸のスコアを更新
  - ラジオボタンの選択に応じてJSONを自動生成
  - `question.vector_scores`に保存
  - 0の場合は削除（影響なし）
  - 空のvectorの場合は削除

**選択肢管理**
- 選択肢追加・削除・変更時にベクトル設定UIを自動更新
- 選択肢削除時にベクトル設定も自動削除
- 選択肢IDの自動生成（`id`、`value`、またはインデックスベース）

#### データ構造
- **診断クイズ**: `question.scoring`配列（既存形式を維持）
  ```javascript
  [
    { choice_id: 'a', vector: { logic: 1, memory: -1 } },
    { choice_id: 'b', vector: { logic: -1, memory: 1 } }
  ]
  ```
- **通常クイズ**: `question.vector_scores`オブジェクト（新形式）
  ```javascript
  {
    "0": { "logic": 1, "memory": -1 },
    "1": { "logic": -1, "memory": 1 }
  }
  ```

### CSSの追加

#### スコアリングUI用スタイル
- `.score-axis-card`: 評価軸カードのスタイル
  - 白背景のカード
  - 角丸とシャドウ
- `.axis-title`: 評価軸タイトル（太字、1.1rem）
- `.axis-desc`: 評価軸説明（グレー、0.95rem）
- `.score-radio-group`: ラジオボタングループ
  - 横並び表示（gap: 20px）
  - ホバー効果

## 主な改善点

### 1. JSONの直接編集を排除
- 診断クイズ: JSONの`<textarea>`を削除
- 通常クイズ: JSON編集UIを追加せず、UI操作のみで設定
- JSONは詳細表示のみ（折りたたみ可能）

### 2. Glossaryとの統合
- Glossaryから評価軸を自動取得
- 用語名・ID・定義をそのまま評価軸UIに使用
- プロジェクトGlossaryとグローバルGlossaryを統合

### 3. 直感的なUI操作
- ラジオボタンで-1/0/+1を選択
- 各評価軸に説明文を表示
- 選択肢ごとに評価軸UIを自動生成

### 4. 自動データ生成
- UI操作から内部JSONを自動生成
- 選択肢変更時に自動更新
- 空のデータを自動削除

### 5. 統一されたデザイン
- 診断クイズと通常クイズで同じUIデザイン
- 教育者向けの柔らかいライトテーマ
- 視覚的に分かりやすいレイアウト

## 更新ファイル

### editor.js
- `renderDiagnosticScoringList()`: 診断クイズ用スコアリングUIの実装
- `renderAxisUI()`: 評価軸UIの描画
- `updateAxisScore()`: 評価軸スコアの更新
- `renderVectorSettingsForQuestion()`: 通常クイズ用ベクトル設定UIの実装
- `renderVectorAxisUI()`: 通常クイズ用評価軸UIの描画
- `updateVectorAxisScore()`: 通常クイズ用評価軸スコアの更新
- `updateChoicesList()`: 選択肢リスト更新時にベクトル設定UIを再描画
- `removeChoice()`: 選択肢削除時にベクトル設定も削除

### src/editor/editor.html
- GlossaryLoaderスクリプトの追加
- スコアリングUI用CSSの追加

## 技術的な特徴

### クライアント側での完結
- サーバー側APIに依存せず、ブラウザ内で完結するUI改善
- GlossaryLoaderの既存機能を活用

### データ構造の柔軟性
- 診断クイズ: 既存の`scoring`配列形式を維持
- 通常クイズ: 新形式の`vector_scores`オブジェクトを追加
- 選択肢IDの自動生成（`id`、`value`、インデックスベース）

### エラーハンドリング
- Glossary読み込みエラー時の適切なメッセージ表示
- 空のGlossaryや不正なデータ構造への対応

## UI/UXの特徴

### 文系教師向けの配慮
- JSONのraw表示を最小限に（詳細表示のみ）
- 自然言語での説明を重視
- 直感的なラジオボタン操作
- Glossaryの定義をそのまま説明文として表示

### 視覚的な階層構造
- 選択肢ごとに評価軸UIを分離
- 評価軸名・定義・ラジオボタンを階層的に表示
- カード形式で視認性を向上

### 統一感のあるデザイン
- 診断クイズと通常クイズで同じUIデザイン
- ライトテーマで統一
- アクセントカラーで視覚的な区別

## 備考 / 今後のタスク

- 診断クイズと通常クイズのデータ形式の統一（将来的に）
- ベクトル設定の一括コピー機能（将来的に）
- 評価軸のフィルタリング機能（将来的に）
- ベクトル設定のプレビュー機能（将来的に）

---

# Glossaryテンプレート選択UIシステムの実装

## 概要
3種類のGlossaryテンプレートを自動生成し、教師が選択してロードできるUIシステムを実装しました。テンプレートを選択するだけで、エディタのベクトル設定UIで使用できるようになり、JSONファイルの手動編集が不要になりました。

## 実装内容

### テンプレート定義

#### 3種類のテンプレート
1. **thinking_skills（思考スキル）**
   - `skill.logic`: 論理 - 筋道立てて考える力
   - `skill.analysis`: 分析 - 構成要素や関係性を明らかにする力
   - `skill.synthesis`: 統合 - 複数の要素を組み合わせ新しい理解を作る力

2. **psychology（教育心理）**
   - `psy.cognition`: 認知 - 情報を処理し理解する心的機能
   - `psy.memory`: 記憶 - 情報を保持し想起する能力
   - `psy.attention`: 注意 - 刺激や情報に意識を向ける能力

3. **future_skills（AI時代の学力）**
   - `future.problem_solving`: 問題解決 - 課題に対して解決方法を構築する能力
   - `future.metacognition`: メタ認知 - 自分の思考の過程を理解し調整する力
   - `future.self_regulation`: 自己調整 - 自分の行動や学習を管理する能力

### HTML構造の追加

#### Glossary Loaderテスト画面
- テンプレート選択UIを画面の上部に追加
- セレクトボックスで3つのテンプレートから選択
- プレビューエリアで読み込んだテンプレートを表示

```html
<div class="glossary-template-box">
  <h3>📚 Glossary テンプレートを選択</h3>
  <div class="controls">
    <label>テンプレート:</label>
    <select id="glossaryTemplateSelect">
      <option value="">選択してください</option>
      <option value="thinking_skills">① 思考スキル（論理・分析・統合）</option>
      <option value="psychology">② 教育心理（認知・記憶・注意）</option>
      <option value="future_skills">③ AI時代の学力（問題解決・メタ認知・自己調整）</option>
    </select>
    <button id="loadGlossaryTemplateBtn">テンプレートを読み込む</button>
  </div>
  <div id="templatePreviewArea"></div>
</div>
```

### CSSの追加

#### テンプレート選択UI用スタイル
- `.glossary-template-box`: テンプレート選択ボックスのスタイル
  - 背景色: `#fafafa`
  - ボーダー: `1px solid #ddd`
  - 角丸: `8px`
  - シャドウ: `0 2px 4px rgba(0,0,0,0.05)`
- `#glossaryTemplateSelect`: セレクトボックスのスタイル
  - パディング: `8px 12px`
  - 最小幅: `300px`
- `#loadGlossaryTemplateBtn`: 読み込みボタンのスタイル
  - 背景色: `#6a5be2`（紫系）
  - ホバー時: `#5548c4`
  - 角丸: `6px`

### JavaScriptの実装

#### テンプレート定義
- `GLOSSARY_TEMPLATES`: 3つのテンプレートをJavaScriptオブジェクトとして定義
  - 各テンプレートは`terms`オブジェクトを含む
  - 各用語は`id`、`name`、`definition`、`example`、`tags`を含む

#### テンプレート読み込み処理
- `DOMContentLoaded`イベントで読み込みボタンのイベントリスナーを設定
- テンプレート選択時に：
  1. `window.currentGlossary`にテンプレートを設定（グローバル変数）
  2. プレビューエリアにテンプレートの用語をカード表示
  3. エディタのベクトル設定UIを自動更新（`window.refreshVectorAxis()`を呼び出し）

#### エディタとの連携

**`loadGlossaryForScoring()`の更新**
- テンプレートが読み込まれている場合は優先的に使用
  ```javascript
  if (window.currentGlossary && window.currentGlossary.terms) {
      return window.currentGlossary.terms;
  }
  ```
- テンプレートがない場合は既存のGlossary Loaderを使用

**`window.refreshVectorAxis()`関数**
- テンプレート読み込み時にベクトル設定UIを自動更新
- 現在編集中の質問を検出
- 診断クイズと通常クイズの両方に対応
  - 診断クイズ: `renderDiagnosticScoringList()`を呼び出し
  - 通常クイズ: `renderVectorSettingsForQuestion()`を呼び出し

## 主な改善点

### 1. テンプレート選択のみで使用可能
- 教師はテンプレートを選択するだけで、すぐに使用可能
- JSONファイルの手動編集が不要
- テンプレートの内容をプレビューで確認可能

### 2. エディタとの自動連携
- テンプレート読み込み時にエディタのベクトル設定UIが自動更新
- 現在編集中の質問の評価軸UIが即座に反映
- 診断クイズと通常クイズの両方に対応

### 3. グローバル変数による状態管理
- `window.currentGlossary`: 現在読み込まれているテンプレート
- エディタからもアクセス可能
- テンプレートが優先的に使用される

### 4. プレビュー機能
- テンプレート読み込み後に用語をカード表示
- 用語名・ID・定義・例を視覚的に確認可能
- 既存のGlossaryカードUIスタイルを再利用

## 更新ファイル

### admin/glossary_test.html
- テンプレート選択UIの追加（HTML）
- テンプレート選択UI用CSSの追加
- テンプレート定義（`GLOSSARY_TEMPLATES`）の実装
- テンプレート読み込み処理の実装
- `window.currentGlossary`の設定
- プレビュー表示機能の実装

### editor.js
- `loadGlossaryForScoring()`の更新（テンプレート優先）
- `window.refreshVectorAxis()`関数の実装
- テンプレート読み込み時のベクトル設定UI自動更新

## 技術的な特徴

### クライアント側での完結
- サーバー側APIに依存せず、ブラウザ内で完結
- テンプレート定義をJavaScriptオブジェクトとして実装
- グローバル変数による状態管理

### 既存システムとの統合
- Glossary Loaderの既存機能を活用
- エディタのベクトル設定UIと自動連携
- 既存のカードUIスタイルを再利用

### 柔軟な拡張性
- 新しいテンプレートを簡単に追加可能
- テンプレート定義の構造が明確
- 用語の追加・変更が容易

## UI/UXの特徴

### 教師向けの配慮
- テンプレート選択のみで使用可能
- JSONファイルの手動編集が不要
- プレビューでテンプレート内容を確認可能
- 自然言語での説明を重視

### 視覚的なフィードバック
- テンプレート読み込み後にプレビュー表示
- 用語をカード形式で視覚的に表示
- 読み込み成功時にアラート表示

### 自動更新機能
- テンプレート読み込み時にエディタのUIが自動更新
- 現在編集中の質問の評価軸UIが即座に反映
- 手動での更新操作が不要

## 動作フロー

1. **Glossary Loaderテスト画面でテンプレートを選択**
   - セレクトボックスからテンプレートを選択
   - 「テンプレートを読み込む」ボタンをクリック

2. **テンプレートの読み込み**
   - `window.currentGlossary`にテンプレートが設定される
   - プレビューエリアにテンプレートの用語が表示される

3. **エディタでの使用**
   - エディタで質問を編集
   - ベクトル設定UIでテンプレートの評価軸が自動表示される
   - ラジオボタンで-1/0/+1を選択して設定

4. **自動更新**
   - テンプレート読み込み時にエディタのUIが自動更新
   - 現在編集中の質問の評価軸UIが即座に反映

## 備考 / 今後のタスク

- テンプレートの追加・編集機能（将来的に）
- カスタムテンプレートの保存機能（将来的に）
- テンプレートのエクスポート機能（将来的に）
- テンプレートのプレビュー機能の強化（将来的に）

---

# Glossaryテンプレートシステムのバグ修正と改善

## 概要
Glossaryテンプレート選択UIシステムの実装後、いくつかのバグを修正し、テンプレートがscoring UIに正しく反映されるように改善しました。

## 修正内容

### 1. Glossaryテンプレート読み込み時の`currentGlossary`の扱い修正

#### 問題点
- `window.currentGlossary`に`glossary`全体を保存していたため、`loadGlossaryForScoring()`で正しく取得できなかった
- `refreshVectorAxis()`の引数が統一されていなかった

#### 修正内容

**`admin/glossary_test.html`の修正**
- `window.currentGlossary = glossary;` → `window.currentGlossary = glossary.terms;`
  - `terms`オブジェクトのみを保持するように変更
- `window.refreshVectorAxis(glossary);` → `window.refreshVectorAxis(glossary.terms);`
  - `terms`オブジェクトを渡すように変更

**`editor.js`の修正**
- `loadGlossaryForScoring()`の条件を修正
  - 変更前: `if (window.currentGlossary && window.currentGlossary.terms)`
  - 変更後: `if (window.currentGlossary)`
- 返却値を修正
  - 変更前: `return window.currentGlossary.terms;`
  - 変更後: `return window.currentGlossary;`
- `refreshVectorAxis()`の引数名を統一
  - 変更前: `window.refreshVectorAxis = function(glossary)`
  - 変更後: `window.refreshVectorAxis = function(glossaryTerms)`
  - 関数内でも`glossaryTerms`を使用するように統一

### 2. Glossaryテンプレート読み込み時の表示問題の修正

#### 問題点
- テンプレートを読み込んでも、Glossaryカードが`resultArea`に表示されなかった

#### 修正内容

**`admin/glossary_test.html`の修正**
- `window.currentGlossary = glossary.terms;`の直後に`renderGlossaryCards(glossary.terms);`を追加
- Glossaryカードが確実に表示されるように改善
- フォールバック処理も追加（`renderGlossaryCards`が存在しない場合）

### 3. デバッグログの追加

**`editor.js`の修正**
- `renderDiagnosticScoringList()`の開始部分にデバッグログを追加
- `console.log('[Diagnostic] Using Glossary terms:', window.currentGlossary);`
- テンプレートGlossaryの使用状況を確認可能に

### 4. エラーハンドリングの強化

**`admin/glossary_test.html`の修正**
- `renderGlossaryCards`関数の存在確認を追加
- 存在しない場合はフォールバック処理で直接`resultArea`に表示
- エラーログを出力

## 修正後の動作

### テンプレート読み込み時の動作
1. `window.currentGlossary = glossary.terms;`で`terms`オブジェクトのみを保存
2. `renderGlossaryCards(glossary.terms)`でGlossaryカードを表示
3. `window.refreshVectorAxis(glossary.terms)`でベクトル設定UIを更新

### `loadGlossaryForScoring()`の動作
1. `window.currentGlossary`が存在する場合は直接返す（`terms`オブジェクト）
2. 存在しない場合は既存のGlossary Loaderを使用

### ベクトル設定UIの更新
1. `refreshVectorAxis(glossaryTerms)`が呼ばれる
2. `window.currentGlossary = glossaryTerms;`で設定
3. 診断クイズと通常クイズの両方でUIが更新される

## 主な改善点

### 1. データ構造の統一
- `window.currentGlossary`は常に`terms`オブジェクトを保持
- `loadGlossaryForScoring()`が一貫して`terms`オブジェクトを返す
- 引数名を`glossaryTerms`に統一

### 2. 表示の確実性
- `renderGlossaryCards(glossary.terms)`を確実に呼び出す
- フォールバック処理を追加
- エラーハンドリングを強化

### 3. デバッグの容易さ
- デバッグログを追加
- エラーメッセージを明確化
- コンソールで状態を確認可能

## 更新ファイル

### admin/glossary_test.html
- `window.currentGlossary`の設定を`glossary.terms`に変更
- `refreshVectorAxis()`の呼び出しを`glossary.terms`に変更
- `renderGlossaryCards(glossary.terms)`の呼び出しを追加
- フォールバック処理とエラーハンドリングを追加

### editor.js
- `loadGlossaryForScoring()`の条件と返却値を修正
- `refreshVectorAxis()`の引数名を`glossaryTerms`に統一
- デバッグログを追加

## 技術的な特徴

### データ構造の一貫性
- `window.currentGlossary`は常に`terms`オブジェクト
- `loadGlossaryForScoring()`は常に`terms`オブジェクトを返す
- 引数名を統一して可読性を向上

### エラーハンドリング
- 関数の存在確認を追加
- フォールバック処理を実装
- エラーログを出力

### デバッグ支援
- コンソールログで状態を確認可能
- エラーメッセージを明確化
- 問題の特定が容易

## 備考 / 今後のタスク

- テンプレート読み込み時のエラーメッセージの改善（将来的に）
- テンプレートの検証機能（将来的に）
- テンプレートのバージョン管理（将来的に）

---

# エディタ画面の統合とiframe完全削除

## 概要
`admin/editor.html` と `src/editor/editor.html` を統合し、iframe に依存しない単一ファイル構成のエディタに改善しました。GlossaryLoader が正しく読み込まれ、評価軸UIが正常に動作するように修正しました。

## 改善対象

### 1. エディタ画面の統合
### 2. project.json 読み込み問題の修正
### 3. iframe 完全削除と直接読み込み方式への移行

## 実装内容

### 1. エディタ画面の統合

#### admin/editor.html の変更
- iframe を完全削除
- `src/editor/editor.html` へのリダイレクトページに変更
- HTML の `meta refresh` と JavaScript の両方でリダイレクトを実装
- 不要なCSSリンクと認証コードを削除（認証は `src/editor/editor.html` で処理）

```html
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="refresh" content="0; url=../src/editor/editor.html">
  <title>Admin Editor - リダイレクト中...</title>
</head>
<body>
  <div style="padding: 2rem; text-align: center; font-family: sans-serif;">
    <h1>エディタにリダイレクト中...</h1>
    <p>自動的にリダイレクトされない場合は、<a href="../src/editor/editor.html">こちらをクリック</a>してください。</p>
  </div>
  <script>
    window.location.href = '../src/editor/editor.html';
  </script>
</body>
</html>
```

#### src/editor/editor.html の統合
- 認証機能（`pin.js`）を統合
- `public/css/main.css` を読み込むように設定
- script パスを正しい階層に修正
  - 修正前: `../../src/core/config.js`（誤ったパス）
  - 修正後: `../core/config.js`（正しいパス）
- GlossaryLoader の読み込み確認用の `console.log` を追加

### 2. project.json 読み込み問題の修正

#### 問題点
- `src/editor/editor.html` から `project.json` を読み込む際にパスが正しく解決されていなかった
- `pin.js` と `config.js` のパス解決が `admin/` ディレクトリ前提だった

#### 修正内容

**src/auth/pin.js の修正**
- `loadConfig` 関数を現在のページパスに基づいて動的にパスを計算するように変更
  - `admin/editor.html` から: `../projects/`
  - `src/editor/editor.html` から: `../../projects/`
- `getMainHtmlPath` 関数を追加し、リダイレクト先のパスも動的に計算
- エラーハンドリングを強化（詳細なエラーメッセージを追加）

**src/core/config.js の修正**
- `getAdminConfigPath` 関数を現在のページパスに基づいて動的にパスを計算するように変更
- エラーハンドリングを強化（読み込みに失敗したパスも表示）

**src/core/GlossaryLoader.js の修正**
- `getBasePath` 関数を追加し、共通のパス解決ロジックを実装
- `loadProjectGlossary`, `loadDomainGlossary`, `loadGlobalGlossary` すべてで動的パス解決を使用

### 3. iframe 完全削除と直接読み込み方式への移行

#### 問題点
- `src/editor/editor.html` に `postMessage` や `localStorage` の `storage` イベントを使った iframe 前提のコードが残っていた
- `window.currentGlossary` の管理が iframe 前提だった

#### 修正内容

**src/editor/editor.html の修正**
- `postMessage` イベントリスナーを削除
- `localStorage` の `storage` イベントリスナーを削除
- iframe 関連のコメントを削除
- `loadGlossaryDirectly()` 関数を追加し、`GlossaryLoader` を使って直接 Glossary を読み込む
- `window.currentGlossary` を `src/editor/editor.html` 内で直接管理
- `admin: true` オプションで正しいパスから読み込む

```javascript
// GlossaryLoader を使って直接 Glossary を読み込む（iframe 不要）
function loadGlossaryDirectly() {
    if (typeof GlossaryLoader === 'undefined') {
        console.warn('[Editor] GlossaryLoader がまだ読み込まれていません。再試行します...');
        setTimeout(loadGlossaryDirectly, 100);
        return;
    }
    
    var projectId = localStorage.getItem('projectId') || 'default';
    console.log('[Editor] Glossaryを読み込みます (projectId: ' + projectId + ')');
    
    // 3層構造のGlossaryを読み込んで統合
    Promise.all([
        GlossaryLoader.loadProjectGlossary(projectId, { admin: true }),
        GlossaryLoader.loadGlobalGlossary({ admin: true })
    ]).then(function(results) {
        var projectGlossary = results[0];
        var globalGlossary = results[1];
        
        // GlossaryLoader.mergeGlossaries を使って統合
        var merged = GlossaryLoader.mergeGlossaries([globalGlossary, projectGlossary]);
        
        // terms をオブジェクト形式に変換
        var terms = {};
        if (merged.terms) {
            if (Array.isArray(merged.terms)) {
                merged.terms.forEach(function(term) {
                    if (term && term.id) {
                        terms[term.id] = term;
                    }
                });
            } else if (typeof merged.terms === 'object') {
                terms = merged.terms;
            }
        }
        
        // window.currentGlossary に設定
        updateGlossaryFromData({ terms: terms });
        console.log('[Editor] Glossaryの読み込みが完了しました:', Object.keys(terms).length + ' 個の用語');
    }).catch(function(error) {
        console.error('[Editor] Glossaryの読み込みに失敗しました:', error);
        window.currentGlossary = { terms: {} };
    });
}
```

**editor.js の修正**
- `loadGlossaryForScoring` 関数で admin オプションを動的に判定
  - パスに基づいて `admin: true/false` を自動判定
  - `src/editor/editor.html` からは `admin: true` を使用

```javascript
async function loadGlossaryForScoring() {
    // window.currentGlossary が存在する場合は優先
    if (window.currentGlossary && window.currentGlossary.terms) {
        return window.currentGlossary.terms;
    }
    
    if (cachedGlossary) return cachedGlossary;
    
    try {
        // 現在のページのパスに基づいて admin オプションを動的に判定
        const pathname = window.location.pathname;
        const isAdmin = pathname.indexOf('/admin/') >= 0 || pathname.indexOf('/src/editor/') >= 0;
        
        const projectId = localStorage.getItem('projectId') || 'default';
        const projectGlossary = await GlossaryLoader.loadProjectGlossary(projectId, { admin: isAdmin });
        const globalGlossary = await GlossaryLoader.loadGlobalGlossary({ admin: isAdmin });
        const merged = GlossaryLoader.mergeGlossaries([globalGlossary, projectGlossary]);
        // ...
    }
}
```

## 主な改善点

### 1. iframe の完全削除
- `postMessage` や `localStorage` の `storage` イベントに依存しない
- エディタ画面が `src/editor/editor.html` のみで動作
- データ共有の複雑さを排除

### 2. パス解決の動的化
- 現在のページパスに基づいて適切なパスを自動計算
- `admin/editor.html` と `src/editor/editor.html` の両方から正しく動作
- 後方互換性を維持

### 3. GlossaryLoader の直接読み込み
- iframe を使わず、`GlossaryLoader` で直接 Glossary を読み込む
- `window.currentGlossary` を `src/editor/editor.html` 内で直接管理
- エラーハンドリングを強化

### 4. 統一された構造
- エディタ画面が1つのファイル（`src/editor/editor.html`）に統合
- 認証機能も統合され、管理画面として動作
- コードの重複を排除

## 更新ファイル

### admin/editor.html
- iframe を削除し、リダイレクトページに変更
- 不要なコードを削除

### src/editor/editor.html
- 認証機能（`pin.js`）を統合
- script パスを正しい階層に修正
- iframe 前提のコードを削除
- `loadGlossaryDirectly()` 関数を追加
- GlossaryLoader の読み込み確認用の `console.log` を追加

### src/auth/pin.js
- `loadConfig` 関数を動的パス解決に変更
- `getMainHtmlPath` 関数を追加
- エラーハンドリングを強化

### src/core/config.js
- `getAdminConfigPath` 関数を動的パス解決に変更
- エラーハンドリングを強化

### src/core/GlossaryLoader.js
- `getBasePath` 関数を追加
- すべての読み込み関数で動的パス解決を使用

### editor.js
- `loadGlossaryForScoring` 関数で admin オプションを動的に判定

## 技術的な特徴

### 動的パス解決
- 現在のページパスに基づいて適切なパスを自動計算
- `admin/` と `src/editor/` の両方から正しく動作
- 後方互換性を維持

### 直接読み込み方式
- iframe を使わず、`GlossaryLoader` で直接 Glossary を読み込む
- `window.currentGlossary` を直接管理
- エラーハンドリングを強化

### エラーハンドリング
- 詳細なエラーメッセージを表示
- 読み込みに失敗したパスも表示
- コンソールログで状態を確認可能

## UI/UXの特徴

### シンプルな構造
- エディタ画面が1つのファイルに統合
- iframe の複雑さを排除
- データ共有の複雑さを排除

### 確実な動作
- GlossaryLoader が正しく読み込まれる
- 評価軸UI（diagnostic / normal）が正常に表示される
- project.json が正しく読み込まれる

### デバッグの容易さ
- コンソールログで状態を確認可能
- エラーメッセージが詳細
- 問題の特定が容易

## 備考 / 今後のタスク

- エディタ画面のさらなる最適化（将来的に）
- パス解決のさらなる改善（将来的に）
- エラーハンドリングの強化（将来的に）

---

# admin/editor.html の完全削除とエディタの一本化

## 概要
`admin/editor.html` を完全に削除し、エディタ機能を `src/editor/editor.html` に一本化しました。iframe や postMessage に依存するコードをすべて撤去し、エディタが単一ファイルで完結する構造に改善しました。

## 改善対象

### 1. admin/editor.html の完全削除
### 2. 参照リンクの修正
### 3. iframe/postMessage 依存コードの完全撤去

## 実装内容

### 1. admin/editor.html の完全削除

#### 削除内容
- `admin/editor.html` ファイルを物理的に削除
- リダイレクトページとしての役割も不要になったため完全削除
- エディタは `src/editor/editor.html` のみで動作

### 2. 参照リンクの修正

#### admin/admin.html の修正
- エディタへのリンクを `editor.html` → `../src/editor/editor.html` に変更
- 管理ダッシュボードから直接正しいエディタファイルを参照

```html
<!-- 修正前 -->
<a href="editor.html">🛠 クイズ編集（Editor）</a>

<!-- 修正後 -->
<a href="../src/editor/editor.html">🛠 クイズ編集（Editor）</a>
```

#### README.md の修正
- ドキュメント内の `admin/editor.html` への参照を削除
- エディタは `src/editor/editor.html` を直接使用することを明記

```markdown
<!-- 修正前 -->
│   ├── editor.html             # エディタ画面（src/editor/editor.html へリダイレクト）

<!-- 修正後 -->
│   └── (editor.html は削除、src/editor/editor.html を直接使用)
```

### 3. iframe/postMessage 依存コードの完全撤去

#### admin/glossary_test.html の修正

**削除したコード**
- iframe を探して postMessage で送信するコード
- `window.opener` 経由で親ウィンドウの iframe を探すコード
- localStorage への保存（別タブ対応）コード

**新しい実装**
- `window.currentGlossary` を直接設定
- `window.refreshVectorAxis` を直接呼び出し
- iframe を使わず、エディタと直接連携

```javascript
// 修正前: iframe を探して postMessage で送信
const editorFrame = document.getElementById('editorFrame');
if (editorFrame && editorFrame.contentWindow) {
  editorFrame.contentWindow.postMessage({
    type: 'GLOSSARY_UPDATE',
    glossary: glossaryData
  }, '*');
}

// 修正後: window.currentGlossary を直接設定
const glossaryData = { terms: glossary.terms || glossary };
window.currentGlossary = glossaryData;
console.log('[Glossary] window.currentGlossary を設定しました:', glossaryData);

// エディタのベクトル設定UIを更新（存在する場合）
if (typeof window.refreshVectorAxis === 'function') {
  window.refreshVectorAxis(glossaryData.terms);
  console.log('[Glossary] ベクトル設定UIを更新しました');
}
```

**コメントの更新**
- iframe 関連のコメントを削除
- 新しい実装方式に合わせたコメントに更新

```javascript
// 修正前
// 注意: window.currentGlossary は iframe 内とは別世界なので設定しない
// iframe 内の editor へは postMessage で送信する

// 修正後
// window.currentGlossary はエディタで直接使用される
```

## 主な改善点

### 1. ファイル構造の簡素化
- `admin/editor.html` を完全削除
- エディタは `src/editor/editor.html` のみで動作
- ファイルの重複を排除

### 2. 参照パスの統一
- すべてのエディタへの参照を `src/editor/editor.html` に統一
- リダイレクトを経由しない直接参照
- パスの混乱を排除

### 3. iframe/postMessage の完全撤去
- iframe を探すコードを削除
- postMessage による通信を削除
- `window.currentGlossary` を直接設定する方式に統一

### 4. データ共有の簡素化
- iframe を経由しない直接的なデータ共有
- `window.currentGlossary` をグローバル変数として直接管理
- `window.refreshVectorAxis` を直接呼び出し

## 更新ファイル

### admin/editor.html
- **削除**: ファイルを完全に削除

### admin/admin.html
- エディタへのリンクを `../src/editor/editor.html` に変更

### admin/glossary_test.html
- iframe を探して postMessage で送信するコードを削除
- `window.currentGlossary` を直接設定する形に変更
- `window.refreshVectorAxis` を直接呼び出す形に変更
- iframe 関連のコメントを削除

### README.md
- ドキュメント内の `admin/editor.html` への参照を削除
- エディタは `src/editor/editor.html` を直接使用することを明記

## 技術的な特徴

### 単一ファイル構成
- エディタは `src/editor/editor.html` のみで完結
- リダイレクトを経由しない直接アクセス
- ファイル構造が明確

### 直接的なデータ共有
- iframe を使わず、グローバル変数で直接共有
- `window.currentGlossary` を直接設定
- `window.refreshVectorAxis` を直接呼び出し

### コードの簡素化
- iframe を探す複雑なコードを削除
- postMessage による通信を削除
- よりシンプルで理解しやすいコード

## UI/UXの特徴

### シンプルな構造
- エディタへのアクセスが明確
- リダイレクトを経由しない直接アクセス
- ファイル構造が理解しやすい

### 確実な動作
- iframe に依存しないため、動作が安定
- データ共有が直接的なため、タイミングの問題が発生しない
- エラーの原因が特定しやすい

### 開発の容易さ
- コードがシンプルで理解しやすい
- デバッグが容易
- 今後の開発が安定

## 動作フロー

### エディタへのアクセス
1. 管理ダッシュボード（`admin/admin.html`）から「クイズ編集（Editor）」をクリック
2. 直接 `src/editor/editor.html` にアクセス（リダイレクト不要）
3. エディタが起動

### Glossary の読み込み
1. Glossary Loader テスト画面（`admin/glossary_test.html`）でテンプレートを読み込み
2. `window.currentGlossary` に直接設定
3. `window.refreshVectorAxis` を直接呼び出し
4. エディタのベクトル設定UIが自動更新

## 備考 / 今後のタスク

- エディタ機能のさらなる最適化（将来的に）
- データ共有方式のさらなる改善（将来的に）
- エラーハンドリングの強化（将来的に）

---

# エディタ内Glossaryテンプレート選択システムの実装と評価軸UI更新問題の修正

## 概要
エディタ内に3種類のGlossaryテンプレート（教育学・心理学・AIリテラシー）を統合し、クイズ作成時にテンプレートから評価軸を選択できるUIシステムを実装しました。また、テンプレート選択時に評価軸UIが更新されない問題を修正しました。

## 改善対象

### 1. エディタ内テンプレート選択UIの統合
### 2. テンプレート選択時の評価軸UI更新問題の修正
### 3. 評価軸読み込み処理の同期化

## 実装内容

### 1. エディタ内テンプレート定義の追加

#### 3種類の新しいテンプレート
1. **learning_science（教育学：学習科学）**
   - `learning.understanding`: 理解度 - 概念同士の関係性を理解しているか
   - `learning.transfer`: 転移可能性 - 学んだ内容を新しい状況に応用できる力
   - `learning.metacognition`: メタ認知 - 自分の理解状態を把握し調整できる力
   - `learning.strategy`: 学習方略 - 有効な学習方法を使えるか

2. **psychology（心理学：認知）**
   - `cognition.attention`: 注意 - 必要な情報に焦点を合わせる能力
   - `cognition.memory`: 記憶 - 学習内容を保持し想起する能力
   - `cognition.reasoning`: 推論 - 情報を組み合わせて結論を導く能力
   - `cognition.processing`: 処理速度 - 情報処理の速さと効率

3. **ai_literacy（AIリテラシー）**
   - `ai.critical`: 批判的思考 - AIの出力を鵜呑みにせず検証する力
   - `ai.data_reason`: データ思考 - データから意味を読み取る力
   - `ai.meta`: AI時代のメタ認知 - AIと人間の役割を使い分ける力
   - `ai.collaboration`: AI協働 - AIを利用して問題解決を進める能力

#### editor.js へのテンプレート定義追加
- `GLOSSARY_TEMPLATES` オブジェクトを `editor.js` の先頭に追加
- 各テンプレートは `terms` オブジェクトを含む
- 各用語は `id`、`name`、`definition`、`example`、`tags` を含む

```javascript
const GLOSSARY_TEMPLATES = {
    learning_science: {
        terms: {
            "learning.understanding": { /* ... */ },
            "learning.transfer": { /* ... */ },
            "learning.metacognition": { /* ... */ },
            "learning.strategy": { /* ... */ }
        }
    },
    psychology: {
        terms: {
            "cognition.attention": { /* ... */ },
            "cognition.memory": { /* ... */ },
            "cognition.reasoning": { /* ... */ },
            "cognition.processing": { /* ... */ }
        }
    },
    ai_literacy: {
        terms: {
            "ai.critical": { /* ... */ },
            "ai.data_reason": { /* ... */ },
            "ai.meta": { /* ... */ },
            "ai.collaboration": { /* ... */ }
        }
    }
};
```

### 2. エディタ内テンプレート選択UIの統合

#### 通常クイズ用ベクトル設定UIへの統合
- `renderVectorSettingsForQuestion()` 関数内にテンプレート選択UIを追加
- テンプレート選択UIを評価軸UIの上部に表示
- セレクトボックスで3つのテンプレートから選択可能
- 「テンプレートを読み込む」ボタンでテンプレートを読み込み

```html
<div style="margin-bottom: 20px; padding: 15px; background: #f0f7ff; border: 2px solid #4a90e2; border-radius: 8px;">
    <h3>📚 評価軸テンプレートを選択</h3>
    <p>理解ベクトルを設定するための評価軸テンプレートを選択してください。</p>
    <div style="display: flex; gap: 10px;">
        <select id="glossaryTemplateSelect-${question.id}">
            <option value="">テンプレートを選択してください</option>
            <option value="learning_science">① 教育学（学習科学：理解度・転移・メタ認知・学習方略）</option>
            <option value="psychology">② 心理学（認知：注意・記憶・推論・処理速度）</option>
            <option value="ai_literacy">③ AIリテラシー（批判的思考・データ思考・AI協働）</option>
        </select>
        <button onclick="loadGlossaryTemplateForQuestion('${question.id}')">
            テンプレートを読み込む
        </button>
    </div>
</div>
```

#### 診断クイズ用スコアリングUIへの統合
- `renderDiagnosticScoringList()` 関数内にテンプレート選択UIを追加
- 通常クイズと同じUIデザインで統一
- 診断クイズ専用のID（`glossaryTemplateSelect-diagnostic-${question.id}`）を使用

### 3. テンプレート読み込み処理の実装

#### `loadGlossaryTemplateForQuestion()` 関数の実装
- 通常クイズと診断クイズの両方のセレクトボックスに対応
- 選択されたテンプレートを `window.currentGlossary` に設定
- `localStorage` に保存して永続化
- キャッシュをクリアして新しいテンプレートを確実に反映
- 評価軸UIを再描画（診断クイズと通常クイズの両方に対応）
- 成功メッセージを表示

```javascript
function loadGlossaryTemplateForQuestion(questionId) {
    const select = document.getElementById(`glossaryTemplateSelect-${questionId}`) || 
                   document.getElementById(`glossaryTemplateSelect-diagnostic-${questionId}`);
    if (!select) return;
    
    const selected = select.value;
    if (!selected) {
        alert('テンプレートを選択してください。');
        return;
    }
    
    const template = GLOSSARY_TEMPLATES[selected];
    if (!template) {
        alert('テンプレートが見つかりません。');
        return;
    }
    
    // window.currentGlossary に設定
    const glossaryData = { terms: template.terms || template };
    window.currentGlossary = glossaryData;
    
    // localStorage に保存
    localStorage.setItem('currentGlossary', JSON.stringify(glossaryData));
    
    // キャッシュをクリア（重要：新しいテンプレートを確実に反映）
    cachedGlossary = null;
    
    // 評価軸UIを再描画
    const question = gameData.questions.find(function(q) { return q.id === questionId; });
    if (question) {
        setTimeout(function() {
            if (question.type === 'diagnostic_question') {
                renderDiagnosticScoringList(question);
            } else {
                renderVectorSettingsForQuestion(question);
            }
        }, 50);
    }
    
    // refreshVectorAxis も呼び出す
    if (typeof window.refreshVectorAxis === 'function') {
        setTimeout(function() {
            window.refreshVectorAxis();
        }, 100);
    }
}
```

### 4. 評価軸UI更新問題の修正

#### 問題点
- テンプレートを選択しても評価軸UIが更新されなかった
- `loadGlossaryForScoring()` が非同期関数で、最新の `window.currentGlossary` を参照できていなかった
- `renderVectorSettingsForQuestion()` と `renderDiagnosticScoringList()` が非同期処理に依存していた

#### 修正内容

**`loadGlossaryForScoring()` を同期関数に変更**
- `async` キーワードを削除
- `window.currentGlossary` から直接取得するため、非同期処理は不要
- 即座に最新の状態を返すように改善

```javascript
// 修正前
async function loadGlossaryForScoring() {
    if (window.currentGlossary?.terms) {
        return window.currentGlossary.terms;
    }
    return {};
}

// 修正後
function loadGlossaryForScoring() {
    // window.currentGlossary から直接取得（iframe 前提を完全撤廃）
    // 同期関数として実装（非同期処理は不要）
    if (window.currentGlossary?.terms) {
        return window.currentGlossary.terms;
    }
    return {};
}
```

**`renderVectorSettingsForQuestion()` を同期関数に変更**
- `async` キーワードを削除
- `await loadGlossaryForScoring()` を `loadGlossaryForScoring()` に変更
- 即座に最新の `window.currentGlossary` を参照

```javascript
// 修正前
async function renderVectorSettingsForQuestion(question) {
    const glossaryTerms = await loadGlossaryForScoring();
    // ...
}

// 修正後
function renderVectorSettingsForQuestion(question) {
    // window.currentGlossary から直接取得（最新の状態を確実に反映）
    const glossaryTerms = loadGlossaryForScoring();
    // ...
}
```

**`renderDiagnosticScoringList()` の非同期処理を削除**
- `.then()` を使った非同期処理を削除
- 同期呼び出しに変更

```javascript
// 修正前
loadGlossaryForScoring().then(function(glossaryTerms) {
    // ...
});

// 修正後
// window.currentGlossary から直接取得（最新の状態を確実に反映）
const glossaryTerms = loadGlossaryForScoring();
// ...
```

**`loadGlossaryTemplateForQuestion()` の改善**
- キャッシュをクリア（`cachedGlossary = null`）
- 評価軸UI再描画前に少し遅延を追加（`setTimeout` で50ms）
- 成功メッセージを表示
- `refreshVectorAxis()` の呼び出しも遅延（100ms）

## 主な改善点

### 1. エディタ内でのテンプレート選択が可能
- クイズ作成時にエディタ内で直接テンプレートを選択可能
- `admin/glossary_test.html` に移動する必要がない
- ワークフローが簡素化

### 2. テンプレート選択時の即座反映
- テンプレートを選択すると、評価軸UIが即座に更新される
- 非同期処理を排除し、同期処理で確実に反映
- キャッシュをクリアして新しいテンプレートを確実に使用

### 3. 3種類の新しいテンプレート
- 教育学（学習科学）テンプレート
- 心理学（認知）テンプレート
- AIリテラシーテンプレート
- 既存のテンプレート（thinking_skills, psychology_old, future_skills）と併用可能

### 4. 統一されたUIデザイン
- 通常クイズと診断クイズで同じテンプレート選択UI
- 視覚的に分かりやすいカード形式
- 成功メッセージでフィードバックを提供

### 5. データの永続化
- `localStorage` に保存して永続化
- ページをリロードしてもテンプレートが保持される
- `window.currentGlossary` と `localStorage` の両方で管理

## 更新ファイル

### editor.js
- `GLOSSARY_TEMPLATES` オブジェクトの追加（3種類の新しいテンプレート）
- `loadGlossaryTemplateForQuestion()` 関数の実装
- `renderVectorSettingsForQuestion()` にテンプレート選択UIを統合
- `renderDiagnosticScoringList()` にテンプレート選択UIを統合
- `loadGlossaryForScoring()` を同期関数に変更
- `renderVectorSettingsForQuestion()` を同期関数に変更
- `renderDiagnosticScoringList()` の非同期処理を削除

## 技術的な特徴

### 同期処理による確実な反映
- 非同期処理を排除し、同期処理で最新の状態を確実に反映
- `window.currentGlossary` から直接取得
- キャッシュをクリアして新しいテンプレートを確実に使用

### エディタ内での完結
- エディタ内でテンプレートを選択・読み込み可能
- 外部ページへの移動が不要
- ワークフローが簡素化

### データの永続化
- `localStorage` に保存して永続化
- ページをリロードしてもテンプレートが保持される
- `window.currentGlossary` と `localStorage` の両方で管理

### 柔軟な拡張性
- 新しいテンプレートを簡単に追加可能
- テンプレート定義の構造が明確
- 用語の追加・変更が容易

## UI/UXの特徴

### エディタ内での完結
- クイズ作成時にエディタ内で直接テンプレートを選択可能
- 外部ページへの移動が不要
- ワークフローが簡素化

### 即座のフィードバック
- テンプレートを選択すると、評価軸UIが即座に更新される
- 成功メッセージでフィードバックを提供
- 視覚的に分かりやすいカード形式

### 統一されたデザイン
- 通常クイズと診断クイズで同じテンプレート選択UI
- 既存のUIデザインと統一感を保持
- 視覚的に分かりやすいレイアウト

## 動作フロー

### 通常クイズでのテンプレート選択
1. エディタで質問を編集
2. 「理解分析（ベクトル設定）」セクションでテンプレートを選択
3. 「テンプレートを読み込む」ボタンをクリック
4. `window.currentGlossary` にテンプレートが設定される
5. 評価軸UIが即座に更新される
6. 各選択肢で評価軸を設定可能

### 診断クイズでのテンプレート選択
1. エディタで診断クイズを編集
2. 「スコアリング設定」セクションでテンプレートを選択
3. 「テンプレートを読み込む」ボタンをクリック
4. `window.currentGlossary` にテンプレートが設定される
5. 評価軸UIが即座に更新される
6. 各選択肢で評価軸を設定可能

## 備考 / 今後のタスク

- テンプレートの追加・編集機能（将来的に）
- カスタムテンプレートの保存機能（将来的に）
- テンプレートのエクスポート機能（将来的に）
- テンプレートのプレビュー機能の強化（将来的に）

---

# README.md の再構成とドキュメント統合

## 概要
`README.md` を指定された構造で再構成し、`change_log/`、`docs/`、各 `src/**/README.md`、`editor.js`、`glossary/**/*.json` から情報を抽出して統合しました。要点を要約し、最新の状態を正として整理しました。

## 改善対象

### 1. README.md の構造化
### 2. 各種ドキュメントからの情報抽出と統合
### 3. フォルダ構成の更新

## 実装内容

### 1. README.md の構造化

#### 新しい構造（指定順序）
1. **プロジェクト概要**: What、Purpose、主な特徴を明確化
2. **システム構成図**: アーキテクチャ概要とフォルダ構成を追加
3. **エディタ機能**: 詳細な機能説明とデータ構造を追加
4. **プレイヤー機能**: 詳細な機能説明と動作フローを追加
5. **Glossary（評価軸）システム**: 3層構造、GlossaryLoader、自動レコメンド機能を詳細化
6. **診断ロジック・ベクトル設定UI**: 通常クイズと診断クイズのUI機能を追加
7. **評価軸テンプレート**: 3種類のテンプレートの詳細と使用方法を追加
8. **改善履歴**: change_logから主要な改善点を抽出
9. **今後のロードマップ**: roadmap.mdと既存の計画を統合
10. **開発メモ**: docsからアーキテクチャ、診断ロジック、概念グラフ、Glossary仕様を抽出

### 2. 情報抽出元

#### change_log/ から抽出
- **2025-11-19**: エディタ内Glossaryテンプレート選択システム、エディタ画面の統合とiframe完全削除、admin/editor.htmlの完全削除
- **2025-11-18**: 教師向けデータ分析ダッシュボードの実装
- **2025-11-17**: プロジェクト再構成・公開方式・admin分離
- **2025-11-14**: 分岐機能の改善と実行可能プレビュー機能の実装

#### docs/ から抽出
- **architecture.md**: Editor / Player / Engine / Storage の4層構成、責務分担
- **roadmap.md**: Phase 1-6 の開発計画
- **diagnostic_logic.md**: 診断ロジックのドラフト仕様
- **concept_graph_spec.md**: 概念グラフのドラフト仕様
- **glossary_spec.md**: Glossaryのドラフト仕様

#### src/**/README.md から抽出
- **src/core/README.md**: 共通ロジックや基盤コードの配置
- **src/editor/README.md**: ノーコードエディタのUI・ロジック
- **src/player/README.md**: 学習者向けの実行ビュー
- **src/glossary/README.md**: 用語集のUIおよびJSON操作

#### editor.js から抽出
- **GLOSSARY_TEMPLATES**: 3種類のテンプレート定義（learning_science、psychology、ai_literacy）
- **診断クイズ・通常クイズのスコアリングUI**: ベクトル設定UIの実装詳細

#### glossary/**/*.json から抽出
- **src/glossary/global.json**: グローバルGlossaryのデータ構造
- **src/glossary/domains/psychology.json**: ドメインGlossaryのデータ構造

### 3. フォルダ構成の更新

#### 反映した変更
- `admin/` フォルダから `glossary.html`, `glossary_test.html`, `glossary.js`, `auth.js` を削除（`src/glossary/` と `src/admin/` に移動）
- `player/` フォルダを削除（`src/player/` に統合）
- `glossary/` フォルダを削除（`src/glossary/` に統合）
- `src/auth/` フォルダを削除し、`src/admin/` に統合
- `legacy/` フォルダの追加（バックアップ用）

#### パス更新
- Glossary機能の説明でパスを更新（`glossary/domains/` → `src/glossary/domains/`）
- Glossary Editorのパスを更新（`admin/glossary.html` → `src/glossary/glossary.html`）

## 主な改善点

### 1. 構造化されたドキュメント
- 指定された10項目の構造で整理
- 各セクションが明確に分離され、検索性が向上
- 最新の状態を正として整理

### 2. 情報の統合
- change_log、docs、各README.md、editor.js、glossary JSONから情報を抽出
- 要点を要約し、冗長性を排除
- コードは必要最小限にとどめる

### 3. フォルダ構成の正確性
- 最新のフォルダ構造を反映
- 移動・削除されたファイルを正確に記載
- パス参照を最新の状態に更新

### 4. 改善履歴の要約
- change_logから主要な改善点を抽出
- 技術的な変更点を簡潔に記載
- 日付順に整理

### 5. 開発メモの統合
- docsからアーキテクチャ、診断ロジック、概念グラフ、Glossary仕様を抽出
- ドラフト仕様も含めて記載
- 開発者向けの情報を整理

## 更新ファイル

### README.md
- 構造を10項目に再構成
- プロジェクト概要、システム構成図、エディタ機能、プレイヤー機能、Glossaryシステム、診断ロジック・ベクトル設定UI、評価軸テンプレート、改善履歴、今後のロードマップ、開発メモを追加
- フォルダ構成を最新の状態に更新
- Glossary機能の説明でパスを更新
- Quick Startと開発者向けのセクションを最後に追加

## 技術的な特徴

### 情報抽出の自動化
- change_log、docs、各README.md、editor.js、glossary JSONから情報を抽出
- 要点を要約し、冗長性を排除
- 最新の状態を正として整理

### 構造化されたドキュメント
- 指定された10項目の構造で整理
- 各セクションが明確に分離
- 検索性が向上

### フォルダ構成の正確性
- 最新のフォルダ構造を反映
- 移動・削除されたファイルを正確に記載
- パス参照を最新の状態に更新

## UI/UXの特徴

### 検索性の向上
- 構造化された目次
- 各セクションが明確に分離
- 最新の状態を正として整理

### 情報の統合
- 複数のソースから情報を抽出
- 要点を要約し、冗長性を排除
- コードは必要最小限にとどめる

### 開発者向けの情報
- アーキテクチャ、診断ロジック、概念グラフ、Glossary仕様を統合
- ドラフト仕様も含めて記載
- 開発者向けの情報を整理

## 備考 / 今後のタスク

- ドキュメントの継続的な更新（将来的に）
- 図表の追加（将来的に）
- より詳細な技術仕様の追加（将来的に）
- 多言語対応（将来的に）

