# 改変履歴 - 2025年12月10日

## 📝 概要
ローカルLLM（Ollama）を活用したAI機能の統合と、Glossary・ConceptGraphの自動生成・双方向同期機能を実装しました。

---

## 🤖 A. callOllama() 標準レイヤ実装

### 新規作成
- `src/core/ai.js` - ローカルLLM統一レイヤ

### 機能
- `callOllama(model, prompt, options)` 関数を実装
- ローカルOllama API（`http://localhost:11434/api/generate`）を呼び出す共通関数
- プロジェクト全体で統一されたLLM呼び出しインターフェースを提供

### 使用例
```javascript
import { callOllama } from '../core/ai.js';
const response = await callOllama('phi3:3.8b', 'Hello, how are you?');
```

---

## 📚 B. Glossary 自動生成機能

### 変更ファイル
- `src/glossary/glossary.js` - AI自動生成機能を追加
- `src/glossary/glossary.html` - UIボタンを追加

### 新機能
- `autoGenerateGlossary(term)` 関数を実装
- 用語名を入力して「🤖 AI自動生成」ボタンをクリックすると、定義・例文・タグを自動生成
- 生成結果をフォームに自動反映
- ローカルLLM（phi3:3.8b）を使用

### 出力形式
```json
{
  "definition": "60字以内の定義",
  "example": "概念を説明する短い例",
  "tags": ["#専門領域"]
}
```

---

## 🕸️ C. Concept Graph（依存ネットワーク）自動生成

### 新規作成
- `src/core/concept_graph.js` - Concept Graph生成・読み込み機能
- `src/editor/modules/project/concept_graph.js` - エディタ統合機能

### 変更ファイル
- `src/editor/editor.html` - Concept Graph生成ボタンを追加
- `src/editor/modules/ui/events.js` - イベントハンドラを追加

### 機能
- `generateConceptGraph(glossary)` 関数を実装
- Glossaryから概念依存関係を自動抽出
- `projects/{projectId}/concept_graph.json` として保存
- エディタUIからワンクリックで生成可能

---

## 📊 D. concept_graph.json 正式フォーマット定義

### 新規作成
- `docs/concept_graph_schema.md` - Concept Graphスキーマドキュメント

### 変更ファイル
- `src/core/concept_graph.js` - 出力形式を正式フォーマットに統一

### スキーマ
```json
{
  "nodes": [
    { "id": "条件付き確率" },
    { "id": "ベイズ推定" }
  ],
  "edges": [
    { "from": "条件付き確率", "to": "ベイズ推定" }
  ]
}
```

### 特徴
- D3.js / Cytoscape.js 互換形式
- nodes: 概念名のリスト
- edges: 依存関係（from = 前提概念、to = 派生概念）

---

## 📈 E. Dashboard UI に AI診断タブと可視化を追加

### 新規作成
- `src/dashboard/analysis.html` - ダッシュボードUI
- `src/dashboard/analysis.js` - ダッシュボードロジック
- `src/dashboard/analysis_ai.js` - AI診断機能
- `src/dashboard/logging.js` - ログ読み込み機能
- `src/dashboard/analysis.css` - ダッシュボードスタイル

### 機能
- AI診断タブを追加
- 理解構造の診断機能
- 理解している概念、つまずき、誤概念、理解深度、次の推奨ステップを表示
- ローカルLLM（phi3:3.8b）を使用

---

## 🔄 E. 分析アルゴリズム統一レイヤ

### 新規作成
- `src/dashboard/analysis_unified.js` - 統一分析API

### 機能
- `runAIAnalysis({ projectId, logs, mode })` 関数を実装
- 3つの分析モードをサポート:
  - `"understanding"`: 理解している概念と理解深度
  - `"misconception"`: つまずきと誤概念
  - `"next-step"`: 次の推奨ステップ
- すべてのAI分析呼び出しを統一API経由で実行

---

## 🎯 F. 概念ごとのミスパターン可視化

### 新規作成
- `src/dashboard/visualize_conceptmap.js` - Concept Graph可視化機能

### 変更ファイル
- `src/dashboard/analysis_unified.js` - `extractMisconceptionPattern` 関数を追加
- `src/dashboard/analysis.html` - 概念ミスパターン解析セクションを追加
- `src/dashboard/analysis.js` - ミスパターン解析ロジックを追加
- `src/dashboard/logging.js` - `loadQuiz` 関数を追加

### 機能
- 概念ごとのミス回数を抽出
- Concept Graph上にミスパターンを重ねて可視化
- Cytoscape.jsを使用したインタラクティブなネットワーク可視化
- ミス回数に応じてノードの色を変更（青=低、赤=高）

---

## ⏱️ G. 反応時間 × 誤答トポロジー（迷いマップ）

### 新規作成
- `src/dashboard/visualize_rtmap.js` - 迷いマップ可視化機能

### 変更ファイル
- `src/dashboard/analysis_unified.js` - `analyzeReactionTopology` 関数を追加
- `src/dashboard/analysis.html` - 迷いマップセクションを追加
- `src/dashboard/analysis.js` - 迷いマップ生成ロジックを追加

### 機能
- 概念ごとの反応時間を分析
- 平均反応時間（meanRT）、分散（varianceRT）、迷い指数（hesitation）を計算
- hesitation = variance * 0.7 + mean * 0.3
- Concept Graph上に迷いマップを可視化
- 迷い指数に応じてノードの色を変更（青=低い迷い、オレンジ=高い迷い）

---

## 🔄 H. Glossary × ConceptGraph 双方向同期

### 新規作成
- `src/core/glossary_sync.js` - Glossary同期機能（ES6モジュール）
- `src/editor/modules/project/glossary_sync.js` - エディタ統合機能

### 変更ファイル
- `src/core/concept_graph.js` - `updateGraphFromGlossary` 関数を追加
- `src/editor/editor.html` - 同期ボタンを追加
- `src/editor/modules/ui/events.js` - イベントハンドラを追加

### 機能
- Glossary → Concept Graph更新: 既存のGraphを保持しつつ、Glossaryから新しい概念・依存関係を追加
- Concept Graph → Glossary更新: Graphに存在するがGlossaryに説明がない概念の定義を自動生成
- 双方向同期をワンクリックで実行
- ローカルLLM（phi3:3.8b）を使用

---

## 📊 変更ファイル一覧

### 新規作成
1. `src/core/ai.js` - ローカルLLM統一レイヤ
2. `src/core/concept_graph.js` - Concept Graph生成・読み込み機能
3. `src/core/glossary_sync.js` - Glossary同期機能（ES6モジュール）
4. `src/dashboard/analysis.html` - ダッシュボードUI
5. `src/dashboard/analysis.js` - ダッシュボードロジック
6. `src/dashboard/analysis_ai.js` - AI診断機能
7. `src/dashboard/analysis_unified.js` - 統一分析API
8. `src/dashboard/analysis.css` - ダッシュボードスタイル
9. `src/dashboard/logging.js` - ログ読み込み機能
10. `src/dashboard/visualize_conceptmap.js` - Concept Graph可視化
11. `src/dashboard/visualize_rtmap.js` - 迷いマップ可視化
12. `src/editor/modules/project/concept_graph.js` - Concept Graph生成機能
13. `src/editor/modules/project/glossary_sync.js` - Glossary/Graph同期機能
14. `docs/concept_graph_schema.md` - Concept Graphスキーマドキュメント

### 変更ファイル
1. `src/glossary/glossary.js` - AI自動生成機能を追加
2. `src/glossary/glossary.html` - AI自動生成ボタンを追加
3. `src/core/README.md` - callOllama関数の説明を追加
4. `src/editor/editor.html` - Concept Graph生成・同期ボタンを追加
5. `src/editor/modules/ui/events.js` - イベントハンドラを追加

---

## 🔄 動作確認

### 実装済み機能
- [x] callOllama() 標準レイヤ - ローカルLLM呼び出し
- [x] Glossary自動生成 - 用語の定義・例文・タグを自動生成
- [x] Concept Graph自動生成 - Glossaryから依存関係を抽出
- [x] Dashboard AI診断 - 理解構造の診断
- [x] 統一分析API - すべてのAI分析を統一インターフェース経由で実行
- [x] 概念ミスパターン可視化 - Concept Graph上にミスパターンを重ねて表示
- [x] 迷いマップ可視化 - 反応時間と誤答トポロジーを可視化
- [x] Glossary/Graph双方向同期 - LLMで自動更新

---

## 🎯 技術スタック

- **ローカルLLM**: Ollama (phi3:3.8b)
- **可視化**: Cytoscape.js
- **モジュールシステム**: ES6 Modules
- **データ形式**: JSON

---

## 📖 I. README.md に全フォルダー構成とファイル詳細説明を追加

### 変更ファイル
- `README.md` - 全フォルダー構成と各ファイルの詳細な説明を一文で追加

### 追加内容
- ルートディレクトリのファイル説明
- 各フォルダー（admin, src/core, src/editor, src/player, src/admin, src/glossary, src/dashboard, projects, students, scripts, analysis, docs, change_log, public, data等）のファイル説明
- サブディレクトリの詳細説明
- 各ファイルの役割を一文で簡潔に説明

### 構成
- 「📁 ディレクトリ構造（詳細）」セクションを拡張
- 「📁 ファイル詳細説明」セクションを新規追加
- 全ファイルの説明を体系的に整理

---

## 💡 J. Player分析ページにLLM洞察タブ機能を追加

### 新規作成
- `src/player/analysis.html` - プレイヤー分析ページUI
- `src/player/analysis.css` - プレイヤー分析ページスタイル

### 変更ファイル
- `src/player/analysis.js` - LLMタブ処理ロジックを追加

### 機能
- **3つのLLM洞察タブ**:
  - 💡 **洞察（Insight）**: 学習データから得られる洞察を表示
  - 🔍 **弱点分析（Weakness）**: 学習者の弱点を分析
  - 📚 **推奨教材（Recommendation）**: 推奨される教材を提示

### 実装詳細
- セッション選択ドロップダウンを追加
- localStorageから`studentLogs`を読み込み
- セッション選択時に分析を実行
- 理解階層プロファイルを計算
- サマリーテキストを生成してLLMに送信
- LLM出力を`<INSIGHT>`, `<WEAKNESS>`, `<RECOMMEND>`タグからパース
- タブ切り替えで各分析結果を表示

### UI構成
- **白背景セクション**: セッション選択とLLMタブ
- **黒背景セクション**: 分析結果ダッシュボード

### LLM処理フロー
1. セッション選択
2. ログデータから理解階層プロファイルを計算
3. サマリーテキストを生成（総回答数、正答率、弱い理解階層、誤概念ランキング等）
4. ローカルLLM（Ollama phi3:3.8b）に送信
5. 3つの観点で分析結果を取得
6. タブで切り替えて表示

### 技術詳細
- `fetchLocalLLM()`: Ollama API呼び出し（非ストリーミング）
- `parseLLMResult()`: XML風タグから結果を抽出
- `runLLMAnalysis()`: セッションサマリーからLLM分析を実行
- `window.runLLMAnalysis`: グローバル関数として公開

---

## 📊 変更ファイル一覧（追加分）

### 新規作成（追加）
15. `src/player/analysis.html` - プレイヤー分析ページUI
16. `src/player/analysis.css` - プレイヤー分析ページスタイル

### 変更ファイル（追加）
6. `src/player/analysis.js` - LLMタブ処理ロジックを追加
7. `README.md` - 全フォルダー構成とファイル詳細説明を追加

---

## 🔄 動作確認（追加分）

### 実装済み機能（追加）
- [x] README.mdの全ファイル説明追加 - プロジェクト全体のファイル構成を体系的に整理
- [x] Player分析ページLLMタブ - セッション選択とLLM洞察表示

---

## 📝 今後の拡張予定

- Concept Graphの可視化UI改善
- ミスパターン分析の詳細化
- 反応時間分析の高度化
- Glossary/Graph同期の自動化オプション
- Player分析ページのLLM分析精度向上
- セッション比較機能の追加

