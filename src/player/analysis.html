<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å­¦ç¿’åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <link rel="stylesheet" href="../public/css/main.css" />
  <link rel="stylesheet" href="analysis.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="white-section">
    <h1>ğŸ“Š å­¦ç¿’åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
    
    <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠ -->
    <div id="session-selector" style="margin: 20px 0;">
      <label for="session-select">ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠ:</label>
      <select id="session-select" style="padding: 8px; font-size: 1rem; margin-left: 10px;">
        <option value="">ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
      </select>
    </div>
    <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠã“ã“ã¾ã§ -->

    <!-- ===== LLM Insights Tabs ===== -->
    <div id="llm-section" style="margin: 30px 0;">
      <div id="llm-tabs" style="display: flex; gap: 10px;">
        <button class="llm-tab active" data-tab="insight">ğŸ’¡ æ´å¯Ÿ</button>
        <button class="llm-tab" data-tab="weakness">ğŸ” å¼±ç‚¹åˆ†æ</button>
        <button class="llm-tab" data-tab="recommend">ğŸ“š æ¨å¥¨æ•™æ</button>
      </div>

      <div id="llm-output-box"
           style="
             margin-top: 15px;
             padding: 20px;
             background: #f7f7f7;
             border-radius: 8px;
             min-height: 120px;
             line-height: 1.6;
           ">
        ãƒ­ãƒ¼ã‚«ãƒ«LLMãŒåˆ†æä¸­â€¦
      </div>
    </div>
    <!-- ===== End LLM Insights Tabs ===== -->
  </div>

  <div class="black-section">
    <div id="dashboard-content">
      <h2>åˆ†æçµæœ</h2>
      <p>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã™ã‚‹ã¨ã€åˆ†æçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    </div>
  </div>

  <script src="../core/config.js"></script>
  <script src="logging.js"></script>
  <script src="analysis.js"></script>
  <script>
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿ã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    (function() {
      'use strict';

      const sessionSelect = document.getElementById('session-select');
      const dashboardContent = document.getElementById('dashboard-content');

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
      function loadSessions() {
        try {
          // localStorageã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
          const logData = localStorage.getItem('studentLogs');
          if (!logData) {
            sessionSelect.innerHTML = '<option value="">ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</option>';
            return;
          }

          const data = JSON.parse(logData);
          const sessions = data.sessions || [];

          if (sessions.length === 0) {
            sessionSelect.innerHTML = '<option value="">ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</option>';
            return;
          }

          // ã‚»ãƒƒã‚·ãƒ§ãƒ³é¸æŠè‚¢ã‚’è¿½åŠ 
          sessionSelect.innerHTML = '<option value="">ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
          sessions.forEach((session, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `ã‚»ãƒƒã‚·ãƒ§ãƒ³ ${index + 1} - ${session.generated_at || 'æ—¥ä»˜ä¸æ˜'}`;
            sessionSelect.appendChild(option);
          });
        } catch (error) {
          console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          sessionSelect.innerHTML = '<option value="">ã‚¨ãƒ©ãƒ¼: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</option>';
        }
      }

      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé¸æŠã•ã‚ŒãŸã¨ãã®å‡¦ç†
      function onSessionSelect(event) {
        const sessionIndex = parseInt(event.target.value);
        if (isNaN(sessionIndex)) {
          dashboardContent.innerHTML = '<h2>åˆ†æçµæœ</h2><p>ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é¸æŠã™ã‚‹ã¨ã€åˆ†æçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>';
          return;
        }

        try {
          const logData = JSON.parse(localStorage.getItem('studentLogs'));
          const sessions = logData.sessions || [];
          const session = sessions[sessionIndex];

          if (!session || !session.logs) {
            dashboardContent.innerHTML = '<h2>ã‚¨ãƒ©ãƒ¼</h2><p>ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
          }

          // åˆ†æã‚’å®Ÿè¡Œ
          renderAnalysis(session);
        } catch (error) {
          console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†æã‚¨ãƒ©ãƒ¼:', error);
          dashboardContent.innerHTML = `<h2>ã‚¨ãƒ©ãƒ¼</h2><p>åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</p>`;
        }
      }

      // åˆ†æçµæœã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      function renderAnalysis(sessionData) {
        const logs = sessionData.logs || [];
        
        if (logs.length === 0) {
          dashboardContent.innerHTML = '<h2>åˆ†æçµæœ</h2><p>ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
          return;
        }

        // ç†è§£éšå±¤ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨ˆç®—
        const profile = window.Analysis.analyzeResponses(logs);
        const dashboardData = window.Analysis.computeDashboardData(logs, profile);

        // ã‚µãƒãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆï¼ˆLLMç”¨ï¼‰
        const summaryText = generateSummaryText(sessionData, dashboardData, profile);

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        renderDashboard(dashboardData);

        // LLMåˆ†æã‚’å®Ÿè¡Œ
        if (typeof window.runLLMAnalysis === 'function') {
          window.runLLMAnalysis(summaryText);
        }
      }

      // ã‚µãƒãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
      function generateSummaryText(sessionData, dashboardData, profile) {
        const totalAnswers = dashboardData.totalAnswers || 0;
        const accuracy = Math.round((dashboardData.accuracy || 0) * 100);
        const weakestLevel = dashboardData.weakestLevel || '-';
        const weakLevels = dashboardData.weakLevels || [];
        const misconceptionLabels = dashboardData.misconceptionBarData?.labels || [];
        const misconceptionValues = dashboardData.misconceptionBarData?.datasets?.[0]?.data || [];

        let summary = `å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆ†æçµæœ\n\n`;
        summary += `ç·å›ç­”æ•°: ${totalAnswers}\n`;
        summary += `æ­£ç­”ç‡: ${accuracy}%\n`;
        summary += `æœ€ã‚‚å¼±ã„ç†è§£éšå±¤: ${weakestLevel}\n\n`;

        summary += `ç†è§£éšå±¤ã‚¹ã‚³ã‚¢:\n`;
        Object.entries(profile).forEach(([level, score]) => {
          summary += `  ${level}: ${Math.round(score * 10) / 10}\n`;
        });

        if (weakLevels.length > 0) {
          summary += `\nå¼±ã„ç†è§£éšå±¤TOP3:\n`;
          weakLevels.forEach((level, index) => {
            summary += `  ${index + 1}. ${level}\n`;
          });
        }

        if (misconceptionLabels.length > 0 && misconceptionLabels[0] !== 'èª¤æ¦‚å¿µãªã—') {
          summary += `\nèª¤æ¦‚å¿µãƒ©ãƒ³ã‚­ãƒ³ã‚°:\n`;
          misconceptionLabels.slice(0, 5).forEach((label, index) => {
            const count = misconceptionValues[index] || 0;
            summary += `  ${index + 1}. ${label}: ${count}å›\n`;
          });
        }

        return summary;
      }

      // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      function renderDashboard(dashboardData) {
        const html = `
          <h2>åˆ†æçµæœ</h2>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
            <div style="background: #2a2a2a; padding: 20px; border-radius: 8px;">
              <h3>åŸºæœ¬çµ±è¨ˆ</h3>
              <p>ç·å›ç­”æ•°: ${dashboardData.totalAnswers}</p>
              <p>æ­£ç­”ç‡: ${Math.round((dashboardData.accuracy || 0) * 100)}%</p>
              <p>æœ€ã‚‚å¼±ã„ç†è§£éšå±¤: ${dashboardData.weakestLevel}</p>
            </div>
            <div style="background: #2a2a2a; padding: 20px; border-radius: 8px;">
              <h3>å¼±ã„ç†è§£éšå±¤</h3>
              <ul>
                ${(dashboardData.weakLevels || []).map(level => `<li>${level}</li>`).join('')}
              </ul>
            </div>
          </div>
        `;
        dashboardContent.innerHTML = html;
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
      if (sessionSelect) {
        sessionSelect.addEventListener('change', onSessionSelect);
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadSessions);
      } else {
        loadSessions();
      }
    })();
  </script>
</body>
</html>

