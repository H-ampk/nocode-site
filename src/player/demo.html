<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¯ã‚¤ã‚ºãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</title>
    <link rel="stylesheet" href="../public/css/main.css" />
    <script src="../core/config.js"></script>
    <script src="../core/GlossaryLoader.js"></script>
    <script src="logging.js"></script>
    <script src="recommendation.js"></script>
    <script src="player.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('../../data/game_back_forest.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 20px;
        }
        .container { 
            background: rgba(0, 0, 0, 0.8); 
            backdrop-filter: blur(10px); 
            border-radius: 20px; 
            padding: 50px; 
            max-width: 900px; 
            width: 100%; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.5); 
            text-align: center; 
            animation: slideIn 0.5s ease-out; 
        }
        @keyframes slideIn { 
            from { opacity: 0; transform: translateY(30px);} 
            to { opacity: 1; transform: translateY(0);} 
        }
        h1 { font-size: 2.5em; margin-bottom: 40px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); }
        .question { font-size: 1.5em; margin-bottom: 40px; font-weight: 600; }
        .buttons { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
        button { 
            padding: 20px 40px; 
            font-size: 1.3em; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            border-radius: 15px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); 
            font-weight: 600; 
            min-width: 200px; 
        }
        button:hover { transform: translateY(-5px); box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6); }
        button:active { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .progress { margin-bottom: 30px; font-size: 1.2em; color: #ccc; }
        .back-button { position: fixed; bottom: 20px; right: 20px; padding: 12px 25px; font-size: 1em; }
        .result-container { text-align: center; }
        .result-title { font-size: 2em; margin-bottom: 30px; color: #ffd700; }
        .result-image { max-width: 80%; height: auto; margin: 20px 0; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .result-description { font-size: 1.3em; margin: 30px 0; line-height: 1.6; }
        .restart-button { margin-top: 30px; }
        
        /* è§£èª¬ã‚¨ãƒªã‚¢ */
        .explanation-area {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            text-align: left;
            display: none;
        }
        .explanation-area.show {
            display: block;
        }
        .explanation-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #ffd700;
        }
        .explanation-content {
            font-size: 1em;
            line-height: 1.6;
            white-space: pre-wrap;
            margin-bottom: 10px;
        }
        .explanation-links {
            margin-top: 10px;
        }
        .explanation-links a {
            color: #90cdf4;
            text-decoration: underline;
            margin-right: 10px;
        }
        .related-term {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        .related-term-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 5px;
            color: #ffd700;
        }
        
        /* å›ç­”ç¢ºå®šãƒœã‚¿ãƒ³ */
        .confirm-button {
            margin-top: 20px;
        }
        
        /* é¸æŠè‚¢ã®é¸æŠçŠ¶æ…‹ */
        .choice-selected {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%) !important;
        }
        
        /* æ­£èª¤è¡¨ç¤º */
        .answer-feedback {
            margin-top: 20px;
            font-size: 1.5em;
            font-weight: 600;
        }
        .answer-correct {
            color: #48bb78;
        }
        .answer-incorrect {
            color: #f56565;
        }
    </style>
</head>
<body>
    <div class="container" id="container">
        <p>èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
    <button class="back-button" onclick="goHome()">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
    
    <script>
        var selectedChoiceId = null;
        var selectedChoice = null;
        var currentQuestionData = null;

        // åˆæœŸåŒ–
        function init() {
            QuizPlayer.loadProject()
                .then(function() {
                    // ãƒ‡ãƒ¢ç”¨ã®ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                    var demoQuiz = {
                        questions: [
                            {
                                id: 'q1',
                                text: 'è³ªå•1: ã‚ãªãŸã¯ä½•æ´¾ï¼Ÿ',
                                choices: [
                                    { id: 'c1', text: 'å¤–å‘å‹', value: 0, tags: ['æ€§æ ¼', 'å¤–å‘æ€§'] },
                                    { id: 'c2', text: 'å†…å‘å‹', value: 1, tags: ['æ€§æ ¼', 'å†…å‘æ€§'], isCorrect: true }
                                ]
                            },
                            {
                                id: 'q2',
                                text: 'è³ªå•2: ã©ã¡ã‚‰ã‚’å¥½ã¿ã¾ã™ã‹ï¼Ÿ',
                                choices: [
                                    { id: 'c3', text: 'æŠ½è±¡çš„', value: 0, tags: ['æ€è€ƒ', 'æŠ½è±¡'] },
                                    { id: 'c4', text: 'å…·ä½“çš„', value: 2, tags: ['æ€è€ƒ', 'å…·ä½“'], isCorrect: true }
                                ]
                            }
                        ]
                    };
                    
                    QuizPlayer.loadQuiz = function() {
                        return Promise.resolve(demoQuiz);
                    };
                    
                    return QuizPlayer.loadQuiz();
                })
                .then(function(quizData) {
                    QuizPlayer.showQuestion(0, renderQuestion);
                })
                .then(function() {
                    // çµæœè¡¨ç¤ºã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨­å®š
                    QuizPlayer.showResult = function(renderCallback) {
                        if (renderCallback) {
                            renderCallback('result', {
                                logs: QuizLogging.getAllLogs()
                            });
                        }
                    };
                })
                .catch(function(error) {
                    console.error('Initialization failed:', error);
                    document.getElementById('container').innerHTML = '<p>ã‚¨ãƒ©ãƒ¼: ã‚¯ã‚¤ã‚ºã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
                });
        }

        // å•é¡Œã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderQuestion(question, index, total) {
            currentQuestionData = question;
            selectedChoiceId = null;
            selectedChoice = null;
            
            var container = document.getElementById('container');
            var progress = 'è³ªå• ' + (index + 1) + ' / ' + total;
            var questionText = question.text || question.question || 'å•é¡Œ';
            
            var html = '<div class="progress">' + progress + '</div>';
            html += '<h1 class="question">' + escapeHtml(questionText) + '</h1>';
            html += '<div class="buttons" id="choiceButtons">';
            
            question.choices.forEach(function(choice) {
                var choiceId = choice.id || ('c' + question.choices.indexOf(choice));
                var choiceText = choice.text || choice.label || 'é¸æŠè‚¢';
                html += '<button class="choice-button" data-choice-id="' + escapeHtml(choiceId) + '" onclick="selectChoice(\'' + escapeHtml(choiceId) + '\')">' + escapeHtml(choiceText) + '</button>';
            });
            
            html += '</div>';
            html += '<button class="confirm-button" id="confirmButton" onclick="confirmAnswer()" disabled>å›ç­”ã‚’ç¢ºå®š</button>';
            html += '<div class="explanation-area" id="explanationArea"></div>';
            
            container.innerHTML = html;
        }

        // é¸æŠè‚¢ã‚’é¸æŠ
        function selectChoice(choiceId) {
            if (!currentQuestionData) return;
            
            var choice = currentQuestionData.choices.find(function(c) {
                return (c.id || ('c' + currentQuestionData.choices.indexOf(c))) === choiceId;
            });
            
            if (!choice) return;
            
            selectedChoiceId = choiceId;
            selectedChoice = choice;
            
            // ã‚¯ãƒªãƒƒã‚¯ã‚’è¨˜éŒ²
            QuizPlayer.handleChoiceClick(choiceId, choice, function(type, data) {
                // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                var buttons = document.querySelectorAll('.choice-button');
                buttons.forEach(function(btn) {
                    btn.classList.remove('choice-selected');
                    if (btn.getAttribute('data-choice-id') === choiceId) {
                        btn.classList.add('choice-selected');
                    }
                });
                
                // ç¢ºå®šãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                document.getElementById('confirmButton').disabled = false;
            });
        }

        // å›ç­”ã‚’ç¢ºå®š
        function confirmAnswer() {
            if (!selectedChoiceId || !selectedChoice || !currentQuestionData) return;
            
            QuizPlayer.confirmAnswer(selectedChoiceId, selectedChoice, function(type, data) {
                if (type === 'answer_confirmed') {
                    var container = document.getElementById('container');
                    var isCorrect = data.isCorrect;
                    var explanation = data.explanation;
                    
                    // æ­£èª¤ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                    var feedbackHtml = '<div class="answer-feedback ' + (isCorrect ? 'answer-correct' : 'answer-incorrect') + '">';
                    feedbackHtml += isCorrect ? 'âœ“ æ­£è§£ï¼' : 'âœ— ä¸æ­£è§£';
                    feedbackHtml += '</div>';
                    
                    // è§£èª¬ã‚¨ãƒªã‚¢
                    var explanationArea = document.getElementById('explanationArea');
                    var recommendation = data.recommendation;
                    
                    if (explanation && !isCorrect) {
                        explanationArea.innerHTML = '';
                        explanationArea.classList.add('show');
                        
                        var expHtml = '';
                        
                        // ç†ç”±è¡¨ç¤º
                        if (explanation.reason || (recommendation && recommendation.reason)) {
                            var reason = explanation.reason || (recommendation ? recommendation.reason : '');
                            expHtml += '<div class="explanation-reason" style="font-size: 0.9em; color: #90cdf4; margin-bottom: 10px; font-style: italic;">';
                            expHtml += 'ğŸ’¡ ' + escapeHtml(reason);
                            expHtml += '</div>';
                        }
                        
                        // æ¨å¥¨ç”¨èªãŒè¤‡æ•°ã‚ã‚‹å ´åˆ
                        var termsToShow = [];
                        if (recommendation && recommendation.recommended_terms && recommendation.recommended_terms.length > 0) {
                            termsToShow = recommendation.recommended_terms;
                        } else if (explanation.title) {
                            // æ—¢å­˜ã® explanation ã‚’ä½¿ç”¨
                            termsToShow = [{
                                word: explanation.title,
                                definition: explanation.content,
                                links: explanation.links || []
                            }];
                        }
                        
                        // å„ç”¨èªã‚’è¡¨ç¤º
                        termsToShow.forEach(function(term, index) {
                            if (index > 0) {
                                expHtml += '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);"></div>';
                            }
                            
                            expHtml += '<div class="explanation-title">ğŸ“š ç”¨èªè§£èª¬: ' + escapeHtml(term.word || term.name || 'ç”¨èª' + (index + 1)) + '</div>';
                            
                            // åå¿œæ™‚é–“ã‚„pathè§£æã«åŸºã¥ã„ã¦è¡¨ç¤ºå†…å®¹ã‚’é¸æŠ
                            var content = '';
                            if (term.definition) {
                                content = term.definition;
                            } else if (term.description) {
                                content = term.description;
                            }
                            
                            // ä¾‹ã‚„æ³¨æ„ç‚¹ã‚’è¿½åŠ 
                            if (term.example) {
                                content += '\n\nä¾‹: ' + term.example;
                            }
                            if (term.note) {
                                content += '\n\næ³¨æ„: ' + term.note;
                            }
                            
                            expHtml += '<div class="explanation-content">' + escapeHtml(content) + '</div>';
                            
                            if (term.links && term.links.length > 0) {
                                expHtml += '<div class="explanation-links">å‚è€ƒãƒªãƒ³ã‚¯: ';
                                term.links.forEach(function(link) {
                                    expHtml += '<a href="' + escapeHtml(link) + '" target="_blank">' + escapeHtml(link) + '</a>';
                                });
                                expHtml += '</div>';
                            }
                        });
                        
                        // é–¢é€£ç”¨èªï¼ˆæ¦‚å¿µæ··åŒãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆï¼‰
                        if (explanation.relatedTerm) {
                            expHtml += '<div class="related-term">';
                            expHtml += '<div class="related-term-title">é–¢é€£ç”¨èª: ' + escapeHtml(explanation.relatedTerm.title) + '</div>';
                            expHtml += '<div class="explanation-content">' + escapeHtml(explanation.relatedTerm.content) + '</div>';
                            expHtml += '</div>';
                        }
                        
                        explanationArea.innerHTML = expHtml;
                    } else {
                        explanationArea.classList.remove('show');
                    }
                    
                    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤º
                    var buttonsDiv = document.getElementById('choiceButtons');
                    buttonsDiv.insertAdjacentHTML('afterend', feedbackHtml);
                    
                    // ç¢ºå®šãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                    document.getElementById('confirmButton').disabled = true;
                    
                    // æ¬¡ã®å•é¡Œãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                    var nextButton = document.createElement('button');
                    nextButton.textContent = 'æ¬¡ã®å•é¡Œã¸';
                    nextButton.className = 'confirm-button';
                    nextButton.onclick = function() {
                        QuizPlayer.nextQuestion(function(question, index, total) {
                            if (question) {
                                renderQuestion(question, index, total);
                            } else {
                                // ã™ã¹ã¦ã®å•é¡ŒãŒçµ‚äº†ï¼ˆshowResult ãŒå‘¼ã°ã‚Œã‚‹ï¼‰
                                QuizPlayer.showResult(renderResult);
                            }
                        });
                    };
                    container.appendChild(nextButton);
                }
            });
        }

        // çµæœã‚’è¡¨ç¤º
        function renderResult(data) {
            var container = document.getElementById('container');
            var logs = data.logs || [];
            
            var html = '<div class="result-container">';
            html += '<h1 class="result-title">ã‚¯ã‚¤ã‚ºå®Œäº†</h1>';
            html += '<p class="result-description">ã™ã¹ã¦ã®å•é¡Œã«å›ç­”ã—ã¾ã—ãŸã€‚</p>';
            html += '<p style="margin: 20px 0;">æ­£è§£æ•°: ' + logs.filter(function(log) { return log.correct; }).length + ' / ' + logs.length + '</p>';
            html += '<button class="restart-button" onclick="restartQuiz()">ğŸ”„ ã‚¯ã‚¤ã‚ºã‚’ã‚„ã‚Šç›´ã™</button>';
            html += '<button class="restart-button" onclick="downloadLogs()" style="margin-left: 10px;">ğŸ“¥ å­¦ç¿’ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>';
            html += '</div>';
            
            container.innerHTML = html;
        }

        // ã‚¯ã‚¤ã‚ºã‚’ãƒªã‚»ãƒƒãƒˆ
        function restartQuiz() {
            QuizPlayer.resetQuiz();
            QuizPlayer.showQuestion(0, renderQuestion);
        }

        // ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadLogs() {
            QuizPlayer.downloadLogs();
        }

        // ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
        function goHome() {
            QuizLogging.clearLogs();
            window.location.href = '../../main.html';
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>



